import { GoogleGenerativeAI } from '@google/generative-ai';
import { neon } from '@neondatabase/serverless';
import fs from 'fs/promises';
import path from 'path';

/**
 * ============================================================================
 * SMART-STAY AI SERVICE - –ñ–ï–õ–ï–ó–û–ë–ï–¢–û–ù–ù–ê –°–ò–°–¢–ï–ú–ê –ó–ê –°–ò–ì–£–†–ù–û–°–¢
 * ============================================================================
 * 
 * –¢–æ–∑–∏ —Å–µ—Ä–≤–∏—Å –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞ –º–æ—â–Ω–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –Ω–∞ –∏–º–æ—Ç–∞:
 * - –¢–û–ß–ù–û —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ –∫–æ–¥ –Ω–∞ –¥–æ–º–∞–∫–∏–Ω–∞ (–±–µ–∑ —Ä–∞–∑–º–∏—Ç–æ —Å—ä–≤–ø–∞–¥–µ–Ω–∏–µ)
 * - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç —á—Ä–µ–∑ HM –∫–æ–¥–æ–≤–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –≤ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏
 * - –ó–∞—â–∏—Ç–Ω–∞ —Å—Ç–µ–Ω–∞ –∑–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–≤–∞–Ω–µ –Ω–∞ –Ω–µ–æ—Ç–æ—Ä–∏–∑–∏—Ä–∞–Ω –¥–æ—Å—Ç—ä–ø –¥–æ –Ω–∞—Ä—ä—á–Ω–∏—Ü–∏
 * - –õ–æ–≥–∏–∫–∞ –Ω–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞ —â–∏—Ñ—Ç–æ–≤–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ
 * - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∞ –ø–æ–º–æ—â –ø—Ä–∏ –∞–≤–∞—Ä–∏–π–Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—è –Ω–∞ —Ç–æ–∫–∞ —Å –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏—è
 * - –û—Ç–∫–∞–∑–æ–ª–µ–∫–∞ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏ –∑–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏ –Ω–∞ AI
 * 
 * –°—ä–∑–¥–∞–Ω–æ: —Ñ–µ–≤—Ä—É–∞—Ä–∏ 2026
 */

// ============================================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================================================

/**
 * @const {string[]} MODELS - Gemini –º–æ–¥–µ–ª–∏ –≤ —Ä–µ–¥ –Ω–∞ –æ—Ç–∫–∞–∑
 * –ü—ä—Ä–≤–∏—á–µ–Ω –º–æ–¥–µ–ª, –ø–æ—Å–ª–µ–¥–≤–∞–Ω –æ—Ç –∫–∞—Å–∫–∞–¥–Ω–∏ –æ—Ç–∫–∞–∑–Ω–∏ –∑–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç
 */
const MODELS = ["gemini-3-pro-preview", "gemini-flash-latest", "gemini-3-flash-preview"];

/**
 * @const {any} sql - Neon –∫–ª–∏–µ–Ω—Ç –Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏ –∑–∞ PostgreSQL –∑–∞—è–≤–∫–∏
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω –æ—Ç DATABASE_URL –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞ –Ω–∞ –æ–∫—Ä—ä–∂–µ–Ω–∏–µ
 */
const sql = process.env.DATABASE_URL ? neon(process.env.DATABASE_URL) : null;

/**
 * @const {GoogleGenerativeAI} genAI - Google Generative AI –∫–ª–∏–µ–Ω—Ç
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω –æ—Ç GEMINI_API_KEY –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞ –Ω–∞ –æ–∫—Ä—ä–∂–µ–Ω–∏–µ
 */
const genAI = process.env.GEMINI_API_KEY ? new GoogleGenerativeAI(process.env.GEMINI_API_KEY) : null;

/**
 * @const {string} AUTOMATION_URL - –ë–∞–∑–æ–≤ URL –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
 * –ú–∞—Ä—à—Ä—É—Ç–∏ –∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª –Ω–∞ —Ç–æ–∫–∞, –ø–æ–ª—É—á–∞–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç—É—Å –∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏—è
 */
const AUTOMATION_URL = process.env.AUTOMATION_SERVICE_URL || 'http://localhost:10000';

/**
 * @const {string} HOST_CODE - –ö–†–ò–¢–ò–ß–ù–û: –¢–∞–π–Ω–∏—è –∫–æ–¥ –Ω–∞ –¥–æ–º–∞–∫–∏–Ω–∞
 * –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ –∑–∞ 100% —Ç–æ—á–Ω–æ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (—Ä–∞–∑–º–∏—Ç–æ—Ç–æ —Å—ä–≤–ø–∞–¥–µ–Ω–∏–µ –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ)
 * –°—ä—Ö—Ä–∞–Ω—è–≤–∞ —Å–µ –≤ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞ –Ω–∞ –æ–∫—Ä—ä–∂–µ–Ω–∏–µ, –Ω–∏–∫–æ–≥–∞ –Ω–µ –µ —Ç–≤—ä—Ä–¥–æ –∫–æ–¥–∏—Ä–∞–Ω–∞
 */
const HOST_CODE = process.env.HOST_CODE;

/**
 * @const {string} PUBLIC_INFO_FALLBACK - –¢–≤—ä—Ä–¥–æ –∫–æ–¥–∏—Ä–∞–Ω–∞ –ø—É–±–ª–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
 * –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ, –∫–æ–≥–¥–∞ —Ä–æ–ª—è—Ç–∞ –µ '–Ω–µ–ø–æ–∑–Ω–∞—Ç' –∑–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–≤–∞–Ω–µ –Ω–∞ –Ω–µ–æ—Ç–æ—Ä–∏–∑–∏—Ä–∞–Ω –¥–æ—Å—Ç—ä–ø –¥–æ manual.txt
 * –°—ä–¥—ä—Ä–∂–∞ —Å–∞–º–æ –∞–¥—Ä–µ—Å –Ω–∞ –∏–º–æ—Ç, —É–¥–æ–±—Å—Ç–≤–∞ –∏ –æ–±—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
 * –ö–†–ò–¢–ò–ß–ù–ê –ó–ê–©–ò–¢–ù–ê –°–¢–ï–ù–ê: –¢–æ–≤–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–≤–∞ —Ä–∞–∑—Ç–∏—á–∞–Ω–µ –Ω–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–Ω–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏ –¥–µ—Ç–∞–π–ª–∏
 */
const PUBLIC_INFO_FALLBACK = `
üè† ASPEN VALLEY - –ê–ü–ê–†–¢–ê–ú–ï–ù–¢ D105

üìç –ê–î–†–ï–°: —É–ª. –ê—Å–ø–µ–Ω –í–∞–ª–µ–π 1234, –ü–ª–∞–Ω–∏–Ω—Å–∫–∏ –ü–æ–≥–ª–µ–¥
üìû –ö–û–ù–¢–ê–ö–¢: –î–æ—Å—Ç—ä–ø–Ω–∏ 24/7 –ø—Ä–∏ —Å–ø–µ—à–Ω–æ—Å—Ç

üèä –£–î–û–ë–°–¢–í–ê:
- –í—ä–Ω—à–µ–Ω –±–∞—Å–µ–π–Ω (—Å–µ–∑–æ–Ω–Ω–æ)
- WiFi –Ω–∞–ª–∏—á–µ–Ω
- –ü–∞—Ä–∫–æ–º—è—Å—Ç–æ –¥–æ—Å—Ç—ä–ø–Ω–æ

üîë –†–ï–ó–ï–†–í–ê–¶–ò–Ø:
- –ó–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –≥–æ—Å—Ç–∏: –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞—à–∏—è –∫–æ–¥ HM...
- –ó–∞ –Ω–æ–≤–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏: –ø–æ—Å–µ—Ç–µ—Ç–µ –Ω–∞—à–∏—è —É–µ–±—Å–∞–π—Ç

‚ö†Ô∏è –í–ê–ñ–ù–û:
- –ü–∞—Ä–æ–ª–∏—Ç–µ –∏ –∫–æ–¥–æ–≤–µ—Ç–µ –Ω–µ —Å–µ –¥–∞–≤–∞—Ç –Ω–∞ –Ω–µ–ø–æ–∑–Ω–∞—Ç–∏
- –ó–∞ –¥–æ—Å—Ç—ä–ø –¥–æ —É—Å–ª—É–≥–∏ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
`;


// ============================================================================
// –ö–õ–ò–ï–ù–¢ –ù–ê –£–°–õ–£–ì–ê–¢–ê –ó–ê –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø
// ============================================================================

/**
 * @namespace automationClient
 * @description –ö–∞–ø—Å—É–ª–∏—Ä–∞ –≤—Å—è –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—è —Å –≤—ä–Ω—à–Ω–∞—Ç–∞ —É—Å–ª—É–≥–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
 * –£–ø—Ä–∞–≤–ª—è–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫–∞, –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏—è –∏ –∑–∞—è–≤–∫–∏ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
 */
const automationClient = {
    /**
     * –ü–æ–ª—É—á–∞–≤–∞ —Ç–µ–∫—É—â–∏—è —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –∑–∞ —Ç–æ–∫–∞ –æ—Ç —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
     * @async
     * @returns {Promise<{online: boolean, isOn: boolean}>} –û–±–µ–∫—Ç —Å—ä—Å —Å—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞
     * @throws –ú—ä–ª—á–∞–ª–∏–≤–æ –≤—Ä—ä—â–∞ –æ—Ñ–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –º—Ä–µ–∂–æ–≤–∞ –≥—Ä–µ—à–∫–∞
     */
    async getPowerStatus() {
        try {
            console.log('[AUTOMATION] –ü–æ–ª—É—á–∞–≤–∞–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞ –æ—Ç —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è...');
            const res = await fetch(`${AUTOMATION_URL}/api/power-status`);
            if (!res.ok) {
                console.warn('[AUTOMATION] –ö—Ä–∞–π–Ω–∞—Ç–∞ —Ç–æ—á–∫–∞ –≤—ä—Ä–Ω–∞ —Å—Ç–∞—Ç—É—Å, —Ä–∞–∑–ª–∏—á–µ–Ω –æ—Ç 200:', res.status);
                return { online: false, isOn: false };
            }
            const status = await res.json();
            console.log('[AUTOMATION] –°—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞ –ø–æ–ª—É—á–µ–Ω:', status);
            return status;
        } catch (e) {
            console.error('[AUTOMATION] –ü—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞ –Ω–µ —É—Å–ø—è:', e.message);
            return { online: false, isOn: false };
        }
    },

    /**
     * –£–ø—Ä–∞–≤–ª—è–≤–∞ —Å—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ –Ω–∞ —Ç–æ–∫–∞ —á—Ä–µ–∑ —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
     * –ö–†–ò–¢–ò–ß–ù–û: –í–∏–∫–∞ –æ–±–Ω–æ–≤–µ–Ω–∏—è API endpoint, –∫–æ–π—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ä–∞ Telegram –∫–æ–º–∞–Ω–¥–∞
     * - true –∏–∑–ø—Ä–∞—â–∞ '–í–ö–õ' –∫—ä–º Telegram –±–æ—Ç
     * - false –∏–∑–ø—Ä–∞—â–∞ '–ò–ó–ö–õ' –∫—ä–º Telegram –±–æ—Ç
     * 
     * –°–µ –≤–∏–∫–∞ –ø—Ä–∏ —Å–ø–µ—à–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ (–≥–æ—Å—Ç –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫) –∏–ª–∏ –ø—Ä–∏ AI –∫–æ–º–∞–Ω–¥–∏
     * @async
     * @param {boolean} state - True –∑–∞ –≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫–∞, false –∑–∞ –∏–∑–∫–ª—é—á–≤–∞–Ω–µ
     * @returns {Promise<boolean>} True –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, false –≤ –ø—Ä–æ—Ç–∏–≤–Ω–∏—è —Å–ª—É—á–∞–π
     * @throws –ú—ä–ª—á–∞–ª–∏–≤–æ –≤—Ä—ä—â–∞ false –ø—Ä–∏ –º—Ä–µ–∂–æ–≤–∞ –≥—Ä–µ—à–∫–∞
     */
    async controlPower(state) {
        try {
            console.log('[AUTOMATION] –ò–∑–ø—Ä–∞—â–∞–º –∫–æ–º–∞–Ω–¥–∞ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫–∞ (—Å—ä—Å Telegram):', state ? '–í–ö–õ–Æ–ß–ò (–í–ö–õ)' : '–ò–ó–ö–õ–Æ–ß–ò (–ò–ó–ö–õ)');
            const res = await fetch(`${AUTOMATION_URL}/api/power-control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ state })
            });
            const success = res.ok;
            if (success) {
                const data = await res.json();
                console.log('[AUTOMATION] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫ –£–°–ü–ï–®–ù–û - Telegram —Å—Ç–∞—Ç—É—Å:', data.telegramSent ? '‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω–æ' : '‚ö†Ô∏è –ù–µ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ');
            } else {
                console.log('[AUTOMATION] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫ –ù–ï–£–î–ê–ß–ù–û (—Å—Ç–∞—Ç—É—Å ' + res.status + ')');
            }
            return success;
        } catch (e) {
            console.error('[AUTOMATION] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ—Ç–æ –Ω–∞ —Ç–æ–∫–∞ –Ω–µ —É—Å–ø—è:', e.message);
            return false;
        }
    },

    /**
     * –ò–∑–ø—Ä–∞—â–∞ —Å–ø–µ—à–Ω–æ –∏–∑–≤–µ—Å—Ç—É–≤–∞—ö–µ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞ —á—Ä–µ–∑ —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
     * –ê–∫—Ç–∏–≤–∏—Ä–∞ —Å–µ, –∫–æ–≥–∞—Ç–æ –≥–æ—Å—Ç –¥–æ–∫–ª–∞–¥–≤–∞ –ø—Ä–æ–±–ª–µ–º–∏ –∏–ª–∏ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –æ—Ç–∫—Ä–∏–µ –ø—Ä–æ–±–ª–µ–º–∏
     * @async
     * @param {string} message - –ò–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ, –æ–ø–∏—Å–≤–∞—â–æ —Å–∏—Ç—É–∞—Ü–∏—è—Ç–∞
     * @param {Object} guestInfo - –û–±–µ–∫—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥–æ—Å—Ç–∞
     * @param {string} guestInfo.guest_name - –ü—ä–ª–Ω–æ—Ç–æ –∏–º–µ –Ω–∞ –≥–æ—Å—Ç–∞
     * @param {string} guestInfo.reservation_code - HM –∫–æ–¥, –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–∞—â —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è—Ç–∞
     * @returns {Promise<boolean>} True, –∞–∫–æ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏–µ—Ç–æ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
     */
    async sendAlert(message, guestInfo) {
        try {
            console.log('[AUTOMATION] –ò–∑–ø—Ä–∞—â–∞–º –∏–∑–≤–µ—Å—Ç—É–≤–∞—ö–µ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞:', message);
            await fetch(`${AUTOMATION_URL}/api/alert`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, guestInfo })
            });
            console.log('[AUTOMATION] –ò–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏–µ—Ç–æ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
            return true;
        } catch (e) {
            console.error('[AUTOMATION] –ò–∑–ø—Ä–∞—â–∞–Ω–µ—Ç–æ –Ω–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–µ –Ω–µ —É—Å–ø—è:', e.message);
            return false;
        }
    },

    /**
     * –ü–æ–ª—É—á–∞–≤–∞ –≤—Å–∏—á–∫–∏ —Ç–µ–∫—É—â–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –æ—Ç —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
     * –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ –∑–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç –∏ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —â–∏—Ñ—Ç
     * @async
     * @returns {Promise<Array>} –ú–∞—Å–∏–≤ –æ—Ç –æ–±–µ–∫—Ç–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –æ—Ç –±–∞–∑–∞ –¥–∞–Ω–Ω–∏
     */
    async getBookings() {
        try {
            console.log('[AUTOMATION] –ü–æ–ª—É—á–∞–≤–∞–º –≤—Å–∏—á–∫–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏...');
            const res = await fetch(`${AUTOMATION_URL}/api/bookings`);
            if (!res.ok) {
                console.warn('[AUTOMATION] –ö—Ä–∞–π–Ω–∞—Ç–∞ —Ç–æ—á–∫–∞ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –Ω–µ —É—Å–ø—è:', res.status);
                return [];
            }
            const bookings = await res.json();
            console.log('[AUTOMATION] –ü–æ–ª—É—á–µ–Ω–∏', bookings.length, '—Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏');
            return bookings;
        } catch (e) {
            console.error('[AUTOMATION] –ü–æ–ª—É—á–∞–≤–∞–Ω–µ—Ç–æ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –Ω–µ —É—Å–ø—è:', e.message);
            return [];
        }
    }
};

// ============================================================================
// –°–õ–û–ô –ó–ê –°–ò–ì–£–†–ù–û–°–¢: –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê –†–û–õ–Ø–¢–ê –ù–ê –ü–û–¢–†–ï–ë–ò–¢–ï–õ–Ø
// ============================================================================

/**
 * –ñ–ï–õ–ï–ó–û–ë–ï–¢–û–ù–ù–ê –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ù–ê –î–û–ú–ê–ö–ò–ù–ê - –¢–û–ß–ù–û –°–™–û–¢–í–ï–¢–°–¢–í–ò–ï –ù–ê –ö–û–î
 * 
 * –û–ø—Ä–µ–¥–µ–ª—è –¥–∞–ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –î–û–ú–ê–ö–ò–ù–ê, –∫–∞—Ç–æ —Å—Ä–∞–≤–Ω—è–≤–∞ —Å process.env.HOST_CODE
 * –ö–†–ò–¢–ò–ß–ù–ê –°–ò–ì–£–†–ù–û–°–¢: –ò–∑–ø–æ–ª–∑–≤–∞ === –∑–∞ –¢–û–ß–ù–û —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ —Å—Ç—Ä–æ–∫–∞
 * –ó–ê–ë–†–ê–ù–ï–ù–û: .includes(), —Ä–∞–∑–º–∏—Ç–æ —Å—ä–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ –Ω–∏–∑–æ–≤–µ
 * 
 * @private
 * @param {string|null} authCode - –ö–æ–¥ –æ—Ç –∑–∞–≥–ª–∞–≤–∫–∞ –∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ —Ñ–æ—Ä–º–∞
 * @param {string|null} userMessage - –°—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –∑–∞ –≤–≥—Ä–∞–¥–µ–Ω –∫–æ–¥)
 * @returns {boolean} True —Å–∞–º–æ –∞–∫–æ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ –¢–û–ß–ù–û —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
 */
function isHostVerified(authCode, userMessage) {
    // –ü–†–ê–í–ò–õ–û –ù–ê –°–ò–ì–£–†–ù–û–°–¢ #1: –¢–û–ß–ù–û –°–™–û–¢–í–ï–¢–°–¢–í–ò–ï –ù–ê –ö–û–î –ù–ê –î–û–ú–ê–ö–ò–ù–ê
    // –ù–ï –∏–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ .includes() - —Ç—Ä—è–±–≤–∞ –¥–∞ –µ 100% —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
    
    console.log('[SECURITY] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –¥–æ–º–∞–∫–∏–Ω–∞: –ø—Ä–æ–≤–µ—Ä—è–≤–∞–º authCode...');
    if (authCode && authCode === HOST_CODE) {
        console.log('[SECURITY] ‚úÖ –î–û–ú–ê–ö–ò–ù –í–ï–†–ò–§–ò–¶–ò–†–ê–ù: authCode —Å—ä–≤–ø–∞–¥–∞ —Ç–æ—á–Ω–æ —Å HOST_CODE');
        return true;
    }

    if (userMessage) {
        console.log('[SECURITY] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –¥–æ–º–∞–∫–∏–Ω–∞: –ø—Ä–æ–≤–µ—Ä—è–≤–∞–º userMessage...');
        const trimmedMessage = String(userMessage).trim();
        if (trimmedMessage === HOST_CODE) {
            console.log('[SECURITY] ‚úÖ –î–û–ú–ê–ö–ò–ù –í–ï–†–ò–§–ò–¶–ò–†–ê–ù: userMessage —Å—ä–≤–ø–∞–¥–∞ —Ç–æ—á–Ω–æ —Å HOST_CODE');
            return true;
        }
    }

    console.log('[SECURITY] ‚ùå –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –¥–æ–º–∞–∫–∏–Ω–∞ –ù–ï–£–î–ê–ß–ù–ê: –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ —Ç–æ—á–Ω–æ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ');
    return false;
}

/**
 * –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ù–ê –ì–û–°–¢ –ß–†–ï–ó HM –ö–û–î–û–í–ï –ù–ê –†–ï–ó–ï–†–í–ê–¶–ò–ò
 * 
 * –ò–∑–ø–æ–ª–∑–≤–∞ regex –∑–∞ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ HM –∫–æ–¥–æ–≤–µ –æ—Ç —Å—ä–æ–±—â–µ–Ω–∏—è –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ä–µ—â—É —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
 * HM –∫–æ–¥–æ–≤–µ —Å–∞ —É–Ω–∏–∫–∞–ª–Ω–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∏ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –Ω–∞ –≥–æ—Å—Ç–∏
 * 
 * @private
 * @async
 * @param {string|null} authCode - –ö–æ–¥, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω –≤ –∑–∞–≥–ª–∞–≤–∫–∞—Ç–∞ –∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
 * @param {string} userMessage - –°—ä–æ–±—â–µ–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–Ω–æ —Å—ä–¥—ä—Ä–∂–∞—â–æ HM –∫–æ–¥
 * @returns {Promise<{role: 'guest'|'stranger', booking: Object|null}>}
 */
async function verifyGuestByHMCode(authCode, userMessage) {
    console.log('[SECURITY] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç: —Ç—ä—Ä—Å—è HM –∫–æ–¥...');
    
    // –ü–†–ê–í–ò–õ–û –ù–ê –°–ò–ì–£–†–ù–û–°–¢ #2: REGEX –®–ê–ë–õ–û–ù –ó–ê HM –ö–û–î–û–í–ï
    // –®–∞–±–ª–æ–Ω: HM seguito –æ—Ç –∞–ª—Ñ–∞–Ω—É–º–µ—Ä–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏ (—Ñ–æ—Ä–º–∞—Ç –Ω–∞ –∫–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è)
    const hmCodePattern = /HM[A-Z0-9]+/i;
    
    // –ü—Ä–æ–≤–µ—Ä—è authCode –ø—ä—Ä–≤–æ
    let codeToVerify = null;
    if (authCode && hmCodePattern.test(authCode)) {
        codeToVerify = authCode.toUpperCase();
        console.log('[SECURITY] HM –∫–æ–¥ –Ω–∞–º–µ—Ä–µ–Ω –≤ authCode:', codeToVerify);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è userMessage –∑–∞ –≤–≥—Ä–∞–¥–µ–Ω HM –∫–æ–¥
    if (!codeToVerify && userMessage) {
        const match = userMessage.match(hmCodePattern);
        if (match) {
            codeToVerify = match[0].toUpperCase();
            console.log('[SECURITY] HM –∫–æ–¥ –Ω–∞–º–µ—Ä–µ–Ω –≤ userMessage:', codeToVerify);
        }
    }

    if (!codeToVerify) {
        console.log('[SECURITY] –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω HM –∫–æ–¥ –≤ authCode –∏–ª–∏ —Å—ä–æ–±—â–µ–Ω–∏–µ');
        return { role: 'stranger', booking: null };
    }

    // –ê–∫–æ –Ω—è–º–∞–º–µ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏, –Ω–µ –º–æ–∂–µ–º –¥–∞ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–∞–º–µ
    if (!sql) {
        console.warn('[DATABASE] SQL –∫–ª–∏–µ–Ω—Ç –Ω–µ –µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω - –Ω–µ –º–æ–≥–∞ –¥–∞ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–∞–º HM –∫–æ–¥');
        return { role: 'stranger', booking: null };
    }

    try {
        console.log('[DATABASE] –ó–∞–ø–∏—Ç–≤–∞–º —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –∑–∞ HM –∫–æ–¥:', codeToVerify);
        const bookings = await sql`
            SELECT * FROM bookings 
            WHERE UPPER(reservation_code) = ${codeToVerify.toUpperCase()}
            LIMIT 1
        `;

        if (bookings.length > 0) {
            const booking = bookings[0];
            console.log('[DATABASE] ‚úÖ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∞ –∑–∞ –∫–æ–¥:', codeToVerify);
            console.log('[DATABASE] –ò–º–µ –Ω–∞ –≥–æ—Å—Ç:', booking.guest_name);
            return { role: 'guest', booking };
        }

        console.log('[DATABASE] ‚ùå –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –∑–∞ HM –∫–æ–¥:', codeToVerify);
        return { role: 'stranger', booking: null };
    } catch (e) {
        console.error('[DATABASE] –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Ç–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏:', e.message);
        return { role: 'stranger', booking: null };
    }
}

/**
 * –õ–û–ì–ò–ö–ê –ù–ê –•–†–ê–ù–ò–õ–ò–©–ï –ù–ê –©–ò–§–¢–û–í–ï - –ê–í–¢–û–ú–ê–¢–ò–ß–ù–û –†–ê–ó–ü–†–ï–î–ï–õ–Ø–ù–ï
 * 
 * –í–∑–µ–º–∏ –ø—ä—Ä–≤–∏—è –Ω–µ–∏–∑–ø–æ–ª–∑–≤–∞–Ω —â–∏—Ñ—Ç –æ—Ç —Ç–∞–±–ª–∏—Ü–∞ pin_depot
 * –ú–∞—Ä–∫–∏—Ä–∞ –≥–æ –∫–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω –≤ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏
 * –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è—Ç–∞ –Ω–∞ –≥–æ—Å—Ç —Å—ä—Å —Å–≤–æ—è –Ω–∞–∑–Ω–∞—á–µ–Ω —â–∏—Ñ—Ç
 * 
 * –ö–†–ò–¢–ò–ß–ù–û: –í–∏–∫–∞ —Å–µ —Å–∞–º–æ –≤–µ–¥–Ω—ä–∂ –Ω–∞ –≥–æ—Å—Ç (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞–Ω–µ –Ω–∞ lock_pin)
 * –ì–∞—Ä–∞–Ω—Ç–∏—Ä–∞, —á–µ –≤—Å–µ–∫–∏ –≥–æ—Å—Ç –ø–æ–ª—É—á–∞–≤–∞ —É–Ω–∏–∫–∞–ª–µ–Ω —â–∏—Ñ—Ç –∑–∞ –¥–æ—Å—Ç—ä–ø –¥–æ –∏–º–æ—Ç–∞
 * 
 * @private
 * @async
 * @param {Object} booking - –û–±–µ–∫—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –æ—Ç –±–∞–∑–∞ –¥–∞–Ω–Ω–∏
 * @returns {Promise<string|null>} –ù–∞–∑–Ω–∞—á–µ–Ω —â–∏—Ñ—Ç –∫–æ–¥ –∏–ª–∏ null –∞–∫–æ –Ω—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏
 */
async function assignPinFromDepot(booking) {
    console.log('[PIN_DEPOT] –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º –¥–∞–ª–∏ –≥–æ—Å—Ç –≤–µ—á–µ –∏–º–∞ —â–∏—Ñ—Ç...');
    
    // –ê–∫–æ –≥–æ—Å—Ç –≤–µ—á–µ –∏–º–∞ —â–∏—Ñ—Ç, –≥–æ –≤—ä—Ä–Ω–∏
    if (booking.lock_pin) {
        console.log('[PIN_DEPOT] –ì–æ—Å—Ç –≤–µ—á–µ –∏–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω —â–∏—Ñ—Ç:', booking.lock_pin);
        return booking.lock_pin;
    }

    console.log('[PIN_DEPOT] –ì–æ—Å—Ç –≤—Å–µ –æ—â–µ –Ω–µ–º–∞ —â–∏—Ñ—Ç - –≤–∑–µ–º–∞–º –æ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ...');

    if (!sql) {
        console.warn('[PIN_DEPOT] SQL –Ω–µ –µ –Ω–∞–ª–∏—á–Ω–æ - –Ω–µ –º–æ–≥–∞ –¥–∞ –Ω–∞–∑–Ω–∞—á–∞ —â–∏—Ñ—Ç');
        return null;
    }

    try {
        console.log('[DATABASE] –ó–∞–ø–∏—Ç–≤–∞–º pin_depot –∑–∞ –ø—ä—Ä–≤–∏ –Ω–µ–∏–∑–ø–æ–ª–∑–≤–∞–Ω —â–∏—Ñ—Ç...');
        const freePins = await sql`
            SELECT id, pin_code FROM pin_depot 
            WHERE is_used = FALSE 
            ORDER BY id ASC 
            LIMIT 1
        `;

        if (freePins.length === 0) {
            console.error('[PIN_DEPOT] ‚ùå –ù—è–º–∞–º–µ –Ω–∞–ª–∏—á–Ω–∏ –Ω–µ–∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏ —â–∏—Ñ—Ç–æ–≤–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ—Ç–æ!');
            return null;
        }

        const pin = freePins[0];
        console.log('[PIN_DEPOT] –ù–∞–º–µ—Ä–µ–Ω –Ω–∞–ª–∏—á–Ω–∞ —â–∏—Ñ—Ç, –º–∞—Ä–∫–∏—Ä–∞–º –∫–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω:', pin.pin_code);

        // –ú–∞—Ä–∫–∏—Ä–∞ —â–∏—Ñ—Ç–∞ –∫–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ—Ç–æ
        await sql`
            UPDATE pin_depot 
            SET is_used = TRUE, assigned_at = NOW()
            WHERE id = ${pin.id}
        `;
        console.log('[PIN_DEPOT] ‚úÖ –©–∏—Ñ—Ç –º–∞—Ä–∫–∏—Ä–∞–Ω –∫–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ—Ç–æ');

        // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è—Ç–∞ —Å –Ω–æ–≤–∏—è —â–∏—Ñ—Ç
        console.log('[DATABASE] –ù–∞–∑–Ω–∞—á–∞–≤–∞–º —â–∏—Ñ—Ç –Ω–∞ –∑–∞–ø–∏—Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è...');
        await sql`
            UPDATE bookings 
            SET lock_pin = ${pin.pin_code}, pin_assigned_at = NOW()
            WHERE id = ${booking.id}
        `;
        console.log('[PIN_DEPOT] ‚úÖ –©–∏—Ñ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç:', pin.pin_code);

        return pin.pin_code;
    } catch (e) {
        console.error('[PIN_DEPOT] –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —â–∏—Ñ—Ç:', e.message);
        return null;
    }
}

/**
 * –û–°–ù–û–í–ù–ê –§–£–ù–ö–¶–ò–Ø –ó–ê –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê –†–û–õ–Ø–¢–ê
 * 
 * –û—Ä–≥–∞–Ω–∏–∑–∏—Ä–∞ –≤—Å–∏—á–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç, –∑–∞ –¥–∞ –æ–ø—Ä–µ–¥–µ–ª–∏ —Ä–æ–ª—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è:
 * 1. –ï –ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –î–û–ú–ê–ö–ò–ù–ê? (–¢–û–ß–ù–û —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ –∫–æ–¥)
 * 2. –ï –ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –ì–û–°–¢? (HM –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –∫–æ–¥ –≤ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏)
 * 3. –í –ø—Ä–æ—Ç–∏–≤–Ω–∏—è —Å–ª—É—á–∞–π: –ù–ï–ü–û–ó–ù–ê–¢ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ—Å—Ç—ä–ø)
 * 
 * –ó–∞ –≥–æ—Å—Ç–∏, —Å—ä—â–æ –æ–±—Ä–∞–±–æ—Ç–≤–∞ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —â–∏—Ñ—Ç –æ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
 * 
 * @async
 * @param {string|null} authCode - –ö–æ–¥ –∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç –∑–∞—è–≤–∫–∞
 * @param {string|null} userMessage - –¢–µ–∫—Å—Ç –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * @returns {Promise<{role: 'host'|'guest'|'stranger', data: Object|null}>}
 *          –í—Ä—ä—â–∞ —Ä–æ–ª—è—Ç–∞ –∏ —Å–≤—ä—Ä–∑–∞–Ω–∏—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω–∏ (–∏–Ω—Ñ–æ –Ω–∞ –≥–æ—Å—Ç, –¥–∞–Ω–Ω–∏ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è)
 */
export async function determineUserRole(authCode, userMessage) {
    console.log('\n[SECURITY] ========== –ù–ê–ß–ê–õ–û –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê –†–û–õ–Ø–¢–ê –ù–ê –ü–û–¢–†–ï–ë–ò–¢–ï–õ–Ø ==========');
    console.log('[SECURITY] authCode –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω:', !!authCode);
    console.log('[SECURITY] userMessage –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω:', !!userMessage);

    // –ü–†–û–í–ï–†–ö–ê #1: –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ù–ê –î–û–ú–ê–ö–ò–ù–ê (–¢–û–ß–ù–û –°–™–û–¢–í–ï–¢–°–¢–í–ò–ï –ù–ê –ö–û–î)
    if (isHostVerified(authCode, userMessage)) {
        console.log('[SECURITY] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ä–æ–ª—è: –î–û–ú–ê–ö–ò–ù');
        console.log('[SECURITY] ========== –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ò–ì–£–†–ù–û–°–¢ –ó–ê–í–™–†–®–ï–ù–ê ==========\n');
        return { role: 'host', data: null };
    }

    // –ü–†–û–í–ï–†–ö–ê #2: –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ù–ê –ì–û–°–¢ (HM –ö–û–î –í –ë–ê–ó–ê –î–ê–ù–ù–ò)
    const guestCheck = await verifyGuestByHMCode(authCode, userMessage);
    if (guestCheck.role === 'guest' && guestCheck.booking) {
        const booking = guestCheck.booking;
        console.log('[PIN_DEPOT] –û–±—Ä–∞–±–æ—Ç–≤–∞–º —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —â–∏—Ñ—Ç –∑–∞ –≥–æ—Å—Ç...');

        // –ù–∞–∑–Ω–∞—á–∞–≤–∞ —â–∏—Ñ—Ç –∞–∫–æ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
        const lockPin = await assignPinFromDepot(booking);

        const guestData = {
            guest_name: booking.guest_name,
            reservation_code: booking.reservation_code,
            check_in: booking.check_in,
            check_out: booking.check_out,
            lock_pin: lockPin,
            booking_id: booking.id
        };

        console.log('[SECURITY] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ä–æ–ª—è: –ì–û–°–¢');
        console.log('[SECURITY] –î–∞–Ω–Ω–∏ –Ω–∞ –≥–æ—Å—Ç –ø–æ–¥–≥–æ—Ç–≤–µ–Ω–∏:', guestData.guest_name);
        console.log('[SECURITY] ========== –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ò–ì–£–†–ù–û–°–¢ –ó–ê–í–™–†–®–ï–ù–ê ==========\n');
        return { role: 'guest', data: guestData };
    }

    // –ü–û –ü–û–î–†–ê–ó–ë–ò–†–ê–ù–ï: –ù–ï–ü–û–ó–ù–ê–¢ (–û–ì–†–ê–ù–ò–ß–ï–ù –î–û–°–¢–™–ü)
    console.log('[SECURITY] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ä–æ–ª—è: –ù–ï–ü–û–ó–ù–ê–¢');
    console.log('[SECURITY] ========== –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ò–ì–£–†–ù–û–°–¢ –ó–ê–í–™–†–®–ï–ù–ê ==========\n');
    return { role: 'stranger', data: null };
}

// ============================================================================
// –°–¢–†–û–ò–¢–ï–õ –ù–ê –°–ò–°–¢–ï–ú–ù–û –£–ö–ê–ó–ê–ù–ò–ï - –û–¢–ì–û–í–û–†–ò –í–™–ì–õ–ï–î –ù–ê –†–û–õ–Ø–¢–ê
// ============================================================================

/**
 * –°—Ç—Ä–æ–∏ –ø—Ä–∏–∫–∞–∑ —Å–∏—Å—Ç–µ–º–Ω–æ —É–∫–∞–∑–∞–Ω–∏–µ –∑–∞ AI –≤—ä–≥–ª–µ–¥ –Ω–∞ —Ä–æ–ª—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * 
 * –£–ö–ê–ó–ê–ù–ò–ï –ù–ê –î–û–ú–ê–ö–ò–ù–ê:
 * - –ü—ä–ª–µ–Ω –¥–æ—Å—Ç—ä–ø –¥–æ –Ω–∞—Ä—ä—á–Ω–∏–∫
 * - –ü—ä–ª–Ω–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫
 * - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏
 * 
 * –£–ö–ê–ó–ê–ù–ò–ï –ù–ê –ì–û–°–¢:
 * - –û–≥—Ä–∞–Ω–∏—á–µ–Ω –Ω–∞—Ä—ä—á–Ω–∏–∫ (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, —Å–≤—ä—Ä–∑–∞–Ω–∞ —Å–∞–º–æ —Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è)
 * - –°—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫ —Å–∞–º–æ –∑–∞ —á–µ—Ç–µ–Ω–µ
 * - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —â–∏—Ñ—Ç –Ω–∞ –≤—Ä–∞—Ç–∞
 * 
 * –£–ö–ê–ó–ê–ù–ò–ï –ù–ê –ù–ï–ü–û–ó–ù–ê–¢:
 * - –°–∞–º–æ PUBLIC_INFO_FALLBACK (–Ω–µ manual.txt)
 * - –ù–∏–∫–∞–∫–≤–∏ –ø–∞—Ä–æ–ª–∏, –∫–æ–¥–æ–≤–µ –∏–ª–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
 * - –°–∞–º–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
 * 
 * –ö–†–ò–¢–ò–ß–ù–ê –ó–ê–©–ò–¢–ù–ê –°–¢–ï–ù–ê: –ù–µ–ø–æ–∑–Ω–∞—Ç–∏—Ç–µ –ù–ò–ö–û–ì–ê –Ω–µ –ø–æ–ª—É—á–∞–≤–∞—Ç –¥–æ—Å—Ç—ä–ø –¥–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –Ω–∞ manual.txt
 * 
 * @param {string} role - –†–æ–ª—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è ('host', 'guest' –∏–ª–∏ 'stranger')
 * @param {Object|null} bookingData - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç
 * @param {Object} powerStatus - –¢–µ–∫—É—â —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –∑–∞ —Ç–æ–∫–∞
 * @param {string} manual - –°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ –Ω–∞ manual.txt (–∞–∫–æ –µ –Ω–∞–ª–∏—á–Ω–æ)
 * @param {string} currentDateTime - –¢–µ–∫—É—â –Ω–∏–∑ —Å –¥–∞—Ç–∞/—á–∞—Å
 * @returns {string} –ü—Ä–∏–∫–∞–∑ —Å–∏—Å—Ç–µ–º–Ω–æ —É–∫–∞–∑–∞–Ω–∏–µ –∑–∞ Gemini AI
 */
export function buildSystemInstruction(role, bookingData, powerStatus, manual, currentDateTime) {
    const { online, isOn } = powerStatus;

    console.log('[AI] –°—Ç—Ä–æ—è —Å–∏—Å—Ç–µ–º–Ω–æ —É–∫–∞–∑–∞–Ω–∏–µ –∑–∞ —Ä–æ–ª—è—Ç–∞:', role);
    console.log('[AI] –°—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫ - –æ–Ω–ª–∞–π–Ω:', online, '| –≤–∫–ª—é—á–µ–Ω:', isOn);

    if (role === 'host') {
        console.log('[AI] –°—Ç—Ä–æ—è —É–∫–∞–∑–∞–Ω–∏–µ –∑–∞ –î–û–ú–ê–ö–ò–ù (–ø—ä–ª–µ–Ω –¥–æ—Å—Ç—ä–ø)');
        return `
========================================================================
üè† SMART-STAY AI –ê–°–ò–°–¢–ï–ù–¢ - –†–ï–ñ–ò–ú –ù–ê –î–û–ú–ê–ö–ò–ù/–ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†
========================================================================

üìÖ –¢–ï–ö–£–©–û –î–ê–¢–ê/–ß–ê–°: ${currentDateTime} (–±—ä–ª–≥–∞—Ä—Å–∫–∞ —á–∞—Å–æ–≤–∞ –∑–æ–Ω–∞)
üîê –ù–ò–í–û –ù–ê –î–û–°–¢–™–ü: –ü–™–õ–ï–ù –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†

‚ö° –°–¢–ê–¢–£–° –ù–ê –°–ò–°–¢–ï–ú–ê–¢–ê –ó–ê –¢–û–ö:
   –ú—Ä–µ–∂–æ–≤–∞ –≤—Ä—ä–∑–∫–∞: ${online ? "‚úÖ –û–ù–õ–ê–ô–ù" : "‚ùå –û–§–õ–ê–ô–ù"}
   –ó–∞—Ö—Ä–∞–Ω–≤–∞–Ω–µ: ${isOn ? "‚úÖ –ê–ö–¢–ò–í–ù–û" : "‚ö†Ô∏è –ù–ï–ê–ö–¢–ò–í–ù–û"}

üìã –ü–™–õ–ï–ù –ù–ê–†–™–ß–ù–ò–ö –ù–ê –ò–ú–û–¢–ê:
${manual}

üéØ –¢–í–û–ò –°–ü–û–°–û–ë–ù–û–°–¢–ò:
   ‚Ä¢ –ü—ä–ª–µ–Ω –¥–æ—Å—Ç—ä–ø –¥–æ –≤—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞ –∏–º–æ—Ç–∞
   ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –∑–∞ —Ç–æ–∫–∞
   ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–æ—Å—Ç–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
   ‚Ä¢ –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä–∞–Ω–µ –Ω–∞ —Å–ø–µ—à–Ω–∏ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏—è
   ‚Ä¢ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –æ—Ç—Å—Ç—Ä–∞–Ω—è–≤–∞–Ω–µ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–∏ –ø—Ä–æ–±–ª–µ–º–∏

üí¨ –ï–ó–ò –ù–ê –ö–û–ú–£–ù–ò–ö–ê–¶–ò–Ø: –ë—ä–ª–≥–∞—Ä—Å–∫–∏ (–ë—ä–ª–≥–∞—Ä—Å–∫–∏)
‚öôÔ∏è –¢–û–ù: –ü—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω, –≤—Å–µ–æ–±—Ö–≤–∞—Ç–µ–Ω, –Ω–∞—Å–æ—á–µ–Ω –∫—ä–º –¥–µ–π—Å—Ç–≤–∏–µ

–¢–ò –°–ò –ï–ö–°–ü–ï–†–¢–ï–ù –£–ü–†–ê–í–ò–¢–ï–õ –ù–ê –ò–ú–û–¢. –ü–†–ï–î–û–°–¢–ê–í–Ø–ô –ü–û–î–†–û–ë–ù–ò –¢–ï–•–ù–ò–ß–ï–°–ö–ò –û–¢–ì–û–í–û–†–ò.
========================================================================
`;
    }

    if (role === 'guest') {
        const checkInDate = new Date(bookingData.check_in);
        const hoursUntilCheckIn = (checkInDate.getTime() - new Date().getTime()) / (1000 * 60 * 60);
        const schedulerNote = !isOn && hoursUntilCheckIn <= 2 && hoursUntilCheckIn > 0 
            ? '\n(System: –¢–æ–∫—ä—Ç –µ –ø–ª–∞–Ω–∏—Ä–∞–Ω –¥–∞ —Å–µ –≤–∫–ª—é—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á—Ä–µ–∑ Telegram 2 —á–∞—Å–∞ –ø—Ä–µ–¥–∏ check-in)'
            : '';
        
        const guestInfo = bookingData ? `
üë§ –¢–í–û–Ø–¢–ê –†–ï–ó–ï–†–í–ê–¶–ò–Ø:
   –ò–º–µ –Ω–∞ –≥–æ—Å—Ç: ${bookingData.guest_name}
   –ö–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è: ${bookingData.reservation_code}
   –ó–∞—Å–µ–ª–≤–∞–Ω–µ: ${new Date(bookingData.check_in).toLocaleString('bg-BG')}
   –ó–∞–º–∏–Ω–∞–≤–∞–Ω–µ: ${new Date(bookingData.check_out).toLocaleString('bg-BG')}
   –ö–æ–¥ –Ω–∞ –≤—Ä–∞—Ç–∞: ${bookingData.lock_pin || '‚è≥ –ù–∞–∑–Ω–∞—á–∞–≤–∞ —Å–µ...'}
` : '';

        console.log('[AI] –°—Ç—Ä–æ—è —É–∫–∞–∑–∞–Ω–∏–µ –∑–∞ –ì–û–°–¢ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ—Å—Ç—ä–ø)');
        return `
========================================================================
üè° SMART-STAY AI –ê–°–ò–°–¢–ï–ù–¢ - –î–û–ë–†–ï –î–û–®–õ–ò –ì–û–°–¢
========================================================================

üìÖ –¢–ï–ö–£–©–û –î–ê–¢–ê/–ß–ê–°: ${currentDateTime} (–±—ä–ª–≥–∞—Ä—Å–∫–∞ —á–∞—Å–æ–≤–∞ –∑–æ–Ω–∞)
üéØ –î–û–ë–†–ï –î–û–®–õ–ò –í –ê–ü–ê–†–¢–ê–ú–ï–ù–¢ ASPEN VALLEY D105

${guestInfo}

üìã –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ù–ê –ò–ú–û–¢–ê –ó–ê –¢–í–û–Ø –ü–†–ï–°–¢–û–ô:
${manual}

‚ö° –°–¢–ê–¢–£–° –ù–ê –°–™–û–†–™–ñ–ï–ù–ò–Ø–¢–ê:
   –ï–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ: ${isOn ? "‚úÖ –†–∞–±–æ—Ç–∏ –Ω–æ—Ä–º–∞–ª–Ω–æ" : "‚ö†Ô∏è –û—Ç–∫—Ä–∏—Ç –ø—Ä–æ–±–ª–µ–º - –∫–æ–Ω—Ç–∞–∫—Ç—É–≤–∞–º –¥–æ–º–∞–∫–∏–Ω–∞"}
   –í–æ–¥–∞: ‚úÖ –ù–æ—Ä–º–∞–ª–Ω–æ
   WiFi: ‚úÖ –ù–∞–ª–∏—á–Ω–æ (–ø–æ–ø—Ä–æ—Å–µ—Ç–µ –ø–∞—Ä–æ–ª–∞, –∞–∫–æ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)${schedulerNote}

üö® –ê–ö–û –ò–ú–ê–¢–ï –°–ü–ï–®–ù–û–°–¢:
   ‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç—É–≤–∞–π—Ç–µ –¥–æ–º–∞–∫–∏–Ω–∞ –≤–µ–¥–Ω–∞–≥–∞ –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω–∏—è –Ω–æ–º–µ—Ä
   ‚Ä¢ –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ [ALERT: –æ–ø–∏—Å–∞–Ω–∏–µ] –≤ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ —Å–∏, –∞–∫–æ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ

üí¨ –ï–ó–ò –ù–ê –ö–û–ú–£–ù–ò–ö–ê–¶–ò–Ø: –ë—ä–ª–≥–∞—Ä—Å–∫–∏ (–ë—ä–ª–≥–∞—Ä—Å–∫–∏)
‚öôÔ∏è –¢–û–ù: –ü—Ä–∏—è—Ç–µ–ª—Å–∫–∏, –ø–æ–ª–µ–∑–µ–Ω, –æ—Ç–∑–∏–≤—á–∏–≤ –∫—ä–º –Ω—É–∂–¥–∏ –Ω–∞ –≥–æ—Å—Ç

–¢–ò –°–ò –ü–†–ò–í–ï–¢–õ–ò–í–ò–Ø –ê–°–ò–°–¢–ï–ù–¢ –ù–ê –î–û–ú–ê–ö–ò–ù–ê. –ë–ï–ô –¢–û–ü–™–õ –ò –ü–û–õ–ï–ó–ï–ù –ó–ê –ì–û–°–¢–ò–¢–ï.
========================================================================
`;
    }

    // –£–ö–ê–ó–ê–ù–ò–ï –ù–ê –ù–ï–ü–û–ó–ù–ê–¢ - –ö–†–ò–¢–ò–ß–ù–ê –ó–ê–©–ò–¢–ù–ê –°–¢–ï–ù–ê
    console.log('[AI] –°—Ç—Ä–æ—è —É–∫–∞–∑–∞–Ω–∏–µ –∑–∞ –ù–ï–ü–û–ó–ù–ê–¢ (—Å–∞–º–æ –ø—É–±–ª–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –ë–ï–ó manual.txt)');
    return `
========================================================================
üè† SMART-STAY –ê–°–ò–°–¢–ï–ù–¢ –ó–ê –ü–£–ë–õ–ò–ß–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø
========================================================================

üìÖ –¢–ï–ö–£–©–û –î–ê–¢–ê/–ß–ê–°: ${currentDateTime} (–±—ä–ª–≥–∞—Ä—Å–∫–∞ —á–∞—Å–æ–≤–∞ –∑–æ–Ω–∞)
üîí –ù–ò–í–û –ù–ê –î–û–°–¢–™–ü: –°–ê–ú–û –ü–£–ë–õ–ò–ß–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø

‚ö†Ô∏è –ó–ê–ë–ï–õ–ï–ñ–ö–ê –ù–ê –°–ò–ì–£–†–ù–û–°–¢:
   –ù—è–º–∞—à –∞–∫—Ç–∏–≤–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è. –ó–∞—â–∏—Ç–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ù–ï –ï –≤–∏–¥–∏–º–∞.

${PUBLIC_INFO_FALLBACK}

üîë –ó–ê –û–¢–ö–õ–Æ–ß–í–ê–ù–ï –ù–ê –§–£–ù–ö–¶–ò–ò:
   ‚Ä¢ –°—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ –≥–æ—Å—Ç–∏: –í—ä–≤–µ–¥–∏ —Ç–≤–æ—è HM –∫–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è, –∑–∞ –¥–∞ –∞–∫—Ç–∏–≤–∏—Ä–∞—à –ø—ä–ª–Ω–∏ —É—Å–ª—É–≥–∏
   ‚Ä¢ –ù–æ–≤–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏: –ü–æ—Å–µ—Ç–µ—Ç–µ –Ω–∞—à–∏—è —É–µ–±—Å–∞–π—Ç, –∑–∞ –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏—Ç–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è

üö´ –û–ì–†–ê–ù–ò–ß–ï–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø (–ù–µ —Å–µ —Å–ø–æ–¥–µ–ª—è —Å –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏):
   ‚Ä¢ –ü–∞—Ä–æ–ª–∏ –Ω–∞ WiFi
   ‚Ä¢ –ö–æ–¥–æ–≤–µ –∑–∞ –≤—Ä–∞—Ç–∞
   ‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–∏–∫–∞
   ‚Ä¢ –í—ä—Ç—Ä–µ—à–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –Ω–∞ –∏–º–æ—Ç–∞
   ‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥–æ—Å—Ç

üí¨ –ï–ó–ò –ù–ê –ö–û–ú–£–ù–ò–ö–ê–¶–ò–Ø: –ë—ä–ª–≥–∞—Ä—Å–∫–∏ (–ë—ä–ª–≥–∞—Ä—Å–∫–∏)
‚öôÔ∏è –¢–û–ù: –ü—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω, –ø–æ–ª–µ–∑–µ–Ω, —Å—ä–∑–Ω–∞—Ç–µ–ª–µ–Ω –æ—Ç–Ω–æ—Å–Ω–æ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç

–¢–ò –°–ò –ê–°–ò–°–¢–ï–ù–¢ –ù–ê –ü–£–ë–õ–ò–ß–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø. –ó–ê–©–ò–¢–ê–í–ê–ô –ß–£–í–°–¢–í–ò–¢–ï–õ–ù–ò –î–ê–ù–ù–ò.
========================================================================
`;
}

// ============================================================================
// –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø –ù–ê –°–ü–ï–®–ù–û–°–¢ –ù–ê –¢–û–ö
// ============================================================================

/**
 * –†–ê–ó–ü–û–ó–ù–ê–í–ê–ù–ï –ù–ê –°–ü–ï–®–ù–û–°–¢ –ù–ê –¢–û–ö –ò –û–¢–ì–û–í–û–†
 * 
 * –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ä–∞ —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞ –Ω–∞ –≥–æ—Å—Ç –∑–∞ –æ–ø–ª–∞–∫–≤–∞–Ω–∏—è, —Å–≤—ä—Ä–∑–∞–Ω–∏ —Å —Ç–æ–∫
 * –ê–∫–æ –≥–æ—Å—Ç –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫ –ò powerStatus.isOn –µ false:
 * 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–¥–µ–π—Å—Ç–≤–∞ controlPower(true) –∑–∞ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫
 * 2. –ò–∑–ø—Ä–∞—â–∞ —Å–ø–µ—à–Ω–æ –∏–∑–≤–µ—Å—Ç—É–≤–∞—ö–µ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥–æ—Å—Ç
 * 3. –í—Ä—ä—â–∞ —Å–∏—Å—Ç–µ–º–Ω–∞ –±–µ–ª–µ–∂–∫–∞, –∫–æ—è—Ç–æ –¥–∞ —Å–µ –¥–æ–±–∞–≤–∏ –∫—ä–º –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ AI
 * 
 * –ö–†–ò–¢–ò–ß–ù–û: –ò–∑–ø—ä–ª–Ω—è–≤–∞ —Å–µ —Å–∞–º–æ –∑–∞ —Ä–æ–ª—è—Ç–∞ –ì–û–°–¢ (–Ω–µ –∑–∞ –Ω–µ–ø–æ–∑–Ω–∞—Ç–∏ –∏–ª–∏ –¥–æ–º–∞–∫–∏–Ω–∏)
 * 
 * –ö–ª—é—á–Ω–∏ –¥—É–º–∏, –∫–æ–∏—Ç–æ —Å–µ —Ä–∞–∑–ø–æ–∑–Ω–∞–≤–∞—Ç: –Ω—è–º–∞ —Ç–æ–∫, –±–µ–∑ —Ç–æ–∫, –Ω–µ —Ä–∞–±–æ—Ç–∏ —Ç–æ–∫ –∏ —Ç.–Ω.
 * 
 * @async
 * @param {string} userMessage - –°—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –≥–æ—Å—Ç
 * @param {string} role - –†–æ–ª—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * @param {Object|null} bookingData - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç
 * @returns {Promise<string>} –°–∏—Å—Ç–µ–º–Ω–∞ –±–µ–ª–µ–∂–∫–∞ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ (–∏–ª–∏ –ø—Ä–∞–∑–µ–Ω –Ω–∏–∑)
 */
export async function checkEmergencyPower(userMessage, role, bookingData) {
    console.log('\n[POWER] –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º –∑–∞ —Å–ø–µ—à–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–∞ —Ç–æ–∫–∞...');

    // –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø –ù–ê –¢–û–ö: –°–∞–º–æ –∑–∞ –≥–æ—Å—Ç–∏
    if (role !== 'guest') {
        console.log('[POWER] –ù–µ –µ –≥–æ—Å—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–º –ø—Ä–æ–≤–µ—Ä–∫–∏—Ç–µ –Ω–∞ —Ç–æ–∫');
        return "";
    }

    // –†–∞–∑–ø–æ–∑–Ω–∞–≤–∞ –∫–ª—é—á–æ–≤–∏ –¥—É–º–∏ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫, —Å–≤—ä—Ä–∑–∞–Ω–∏ —Å –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫
    const emergencyPowerKeywords = /–Ω—è–º–∞ —Ç–æ–∫|–±–µ–∑ —Ç–æ–∫|–Ω–µ —Ä–∞–±–æ—Ç–∏ —Ç–æ–∫|—Å–ø—Ä—è–Ω —Ç–æ–∫|–∏–∑–∫–ª—é—á–µ–Ω —Ç–æ–∫|–Ω—è–º–∞ –µ–Ω–µ—Ä–≥–∏—è|NO POWER|–Ω–µ—Ç —Ç–æ–∫–∞/i;
    const needsPower = emergencyPowerKeywords.test(userMessage);

    if (!needsPower) {
        console.log('[POWER] –ù–µ —Å–∞ —Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∏ –∫–ª—é—á–æ–≤–∏ –¥—É–º–∏ –∑–∞ —Å–ø–µ—à–Ω–æ—Å—Ç –Ω–∞ —Ç–æ–∫');
        return "";
    }

    console.log('[POWER] ‚ö†Ô∏è –°–ü–ï–®–ù–û–°–¢ –†–ê–ó–ü–û–ó–ù–ê–¢–ê: –ì–æ—Å—Ç –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫!');

    // –û–í–™–†–ê–ô–î –ù–ê –ì–û–°–¢: –ê–∫–æ –≥–æ—Å—Ç —Å–µ –∂–∞–ª–∏ –Ω–∞ "–ù—è–º–∞ —Ç–æ–∫", –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∫–ª—é—á–≤–∞ —Ç–æ–∫–∞
    // –¢–æ–≤–∞ –µ –∑–∞—â–∏—Ç–Ω–∞ –º—è—Ä–∫–∞ - –≥–æ—Å—Ç—ä—Ç —â–µ –ø–æ–ª—É—á–∏ —Ç–æ–∫ –¥–æ—Ä–∏ –∞–∫–æ –µ –ø–ª–∞–Ω–∏—Ä–∞–Ω–æ –∏–∑–∫–ª—é—á–≤–∞–Ω–µ
    console.log('[POWER] üö® –û–í–™–†–ê–ô–î –ù–ê –ì–û–°–¢ –ê–ö–¢–ò–í–ò–†–ê–ù: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª–Ω–æ –≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫');
    
    const overrideSuccess = await automationClient.controlPower(true);

    if (overrideSuccess) {
        console.log('[POWER] ‚úÖ –ö–æ–º–∞–Ω–¥–∞ –∑–∞ –≤–æ–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –∫—ä–º Telegram –±–æ—Ç');
        
        // –ò–∑–ø—Ä–∞—â–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–µ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Å–∏—Ç—É–∞—Ü–∏—è—Ç–∞
        await automationClient.sendAlert(
            `üö® –°–ü–ï–®–ù–û –í–™–ó–°–¢–ê–ù–û–í–Ø–í–ê–ù–ï –ù–ê –¢–û–ö: –ì–æ—Å—Ç ${bookingData?.guest_name} (${bookingData?.reservation_code}) –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫. –¢–æ–∫ –µ –≤–∫–ª—é—á–µ–Ω —á—Ä–µ–∑ Telegram –∫–æ–º–∞–Ω–¥–∞ (–í–ö–õ).`,
            {
                guest_name: bookingData?.guest_name || '–ù–µ–ø–æ–∑–Ω–∞—Ç',
                reservation_code: bookingData?.reservation_code || 'N/A',
                role: role,
                timestamp: new Date().toISOString(),
                action: 'power-override'
            }
        );

        console.log('[POWER] –ò–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏–µ—Ç–æ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞');
        return "\n\n‚úÖ [–°–ò–°–¢–ï–ú–ê: –°–∏—Å—Ç–µ–º–∞—Ç–∞ –∑–∞ –∑–∞—Ö—Ä–∞–Ω–≤–∞–Ω–µ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞ - –µ–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ—Ç–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –±—ä–¥–µ –Ω–∞–ª–∏—á–Ω–æ –≤—Å–µ–∫–∏ –º–æ–º–µ–Ω—Ç]";
    } else {
        console.log('[POWER] ‚ùå –ö–æ–º–∞–Ω–¥–∞ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫ –Ω–µ —É—Å–ø—è');
        
        // –°—ä—â–∏–Ω—Å–∫–∞ –≥—Ä–µ—à–∫–∞ - —É–≤–µ–¥–æ–º—è–≤–∞–º–µ –¥–æ–º–∞–∫–∏–Ω–∞
        await automationClient.sendAlert(
            `üî¥ –ö–†–ò–¢–ò–ß–ù–û: –ì–æ—Å—Ç ${bookingData?.guest_name} –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫, –Ω–æ –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ê–¢–ê –ö–û–ú–ê–ù–î–ê –ù–ê –¢–û–ö –ù–ï –£–°–ü–Ø. –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞!`,
            {
                guest_name: bookingData?.guest_name || '–ù–µ–ø–æ–∑–Ω–∞—Ç',
                reservation_code: bookingData?.reservation_code || 'N/A',
                role: role,
                timestamp: new Date().toISOString(),
                action: 'power-override-failed'
            }
        );
        
        return "\n\n‚ö†Ô∏è [–°–ò–°–¢–ï–ú–ê: –í—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫ –µ –æ–ø–∏—Ç–∞–Ω–æ, –Ω–æ –µ –Ω–µ—É–¥–∞—á–Ω–æ - –∫–æ–Ω—Ç–∞–∫—Ç—É–≤–∞–º –¥–æ–º–∞–∫–∏–Ω–∞ –Ω–µ–∑–∞–±–∞–≤–Ω–æ –∑–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞ –ø–æ–º–æ—â]";
    }
}

// ============================================================================
// –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –ò–ó–í–ï–°–¢–£–í–ê–ù–ò–Ø
// ============================================================================

/**
 * –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –ò–ó–í–ï–°–¢–£–í–ê–¢–ï–õ–ù–ò –ú–ê–†–ö–ï–†–ò
 * 
 * –°–∫–∞–Ω–∏—Ä–∞ –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ AI –∑–∞ –º–∞—Ä–∫–µ—Ä–∏ [ALERT: ...]
 * –ò–∑–≤–ª–∏—á–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–µ –∏ –≥–æ –∏–∑–ø—Ä–∞—â–∞ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞ —á—Ä–µ–∑ —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
 * –ü—Ä–µ–º–∞—Ö–≤–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏ –æ—Ç –æ—Ç–≥–æ–≤–æ—Ä–∞ –ø—Ä–µ–¥–∏ –≤—Ä—ä—â–∞–Ω–µ –∫—ä–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * 
 * –§–æ—Ä–º–∞—Ç: [ALERT: –°—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞]
 * 
 * @async
 * @param {string} aiResponse - –¢–µ–∫—Å—Ç –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä –æ—Ç Gemini AI
 * @param {string} role - –†–æ–ª—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * @param {Object|null} bookingData - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç
 * @returns {Promise<string>} –û—Ç–≥–æ–≤–æ—Ä —Å –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç–∏ –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏
 */
export async function processAlerts(aiResponse, role, bookingData) {
    console.log('[ALERTS] –°–∫–∞–Ω–∏—Ä–∞–º –æ—Ç–≥–æ–≤–æ—Ä –∑–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏...');

    if (!aiResponse.includes('[ALERT:')) {
        console.log('[ALERTS] –ù–µ —Å–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏—è –≤ –æ—Ç–≥–æ–≤–æ—Ä–∞');
        return aiResponse;
    }

    const match = aiResponse.match(/\[ALERT:(.*?)\]/);

    if (match && match[1]) {
        const alertMessage = match[1].trim();
        console.log('[ALERTS] –û—Ç–∫—Ä–∏—Ç –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–µ–Ω –º–∞—Ä–∫–µ—Ä:', alertMessage);

        await automationClient.sendAlert(
            alertMessage,
            {
                guest_name: bookingData?.guest_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω –≥–æ—Å—Ç',
                reservation_code: bookingData?.reservation_code || 'N/A',
                role: role,
                timestamp: new Date().toISOString()
            }
        );

        console.log('[ALERTS] –ò–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏–µ—Ç–æ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
    }

    const cleanedResponse = aiResponse.replace(/\[ALERT:.*?\]/g, '').trim();
    console.log('[ALERTS] –ò–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏ –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç–∏ –æ—Ç –æ—Ç–≥–æ–≤–æ—Ä');
    return cleanedResponse;
}

// ============================================================================
// –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê –û–¢–ì–û–í–û–† –ù–ê AI –°–™–° –ú–ù–û–ì–û–ú–û–î–ï–õ–ù–ê –û–¢–ö–ê–ó–û–í–ê –õ–û–ì–ò–ö–ê
// ============================================================================

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä –∑–∞ API –Ω–∞ Gemini
 * 
 * –ü—Ä–∏–µ–º–∞ –∏—Å—Ç–æ—Ä–∏—è –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–æ—Ä–º–∞—Ç–∏ (JSON –Ω–∏–∑ –∏–ª–∏ –º–∞—Å–∏–≤)
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–≤–∞ –∫—ä–º —Ñ–æ—Ä–º–∞—Ç, —Å—ä–≤–º–µ—Å—Ç–∏–º —Å Gemini, —Å –ø—Ä–∞–≤–∏–ª–Ω–æ —Å—ä–ø–æ—Å—Ç–∞–≤—è–Ω–µ –Ω–∞ —Ä–æ–ª—è—Ç–∞
 * 
 * @private
 * @param {string|Array} history - –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä
 * @returns {Array} –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω –º–∞—Å–∏–≤ –æ—Ç —Å—ä–æ–±—â–µ–Ω–∏—è –∑–∞ Gemini
 */
function formatHistory(history) {
    console.log('[HISTORY] –§–æ—Ä–º–∞—Ç–∏—Ä–∞–º –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä...');
    let parsed = [];

    if (typeof history === 'string') {
        try {
            parsed = JSON.parse(history);
            console.log('[HISTORY] –†–∞–∑–±—Ä–∞–Ω JSON –Ω–∏–∑, —Å—ä–æ–±—â–µ–Ω–∏—è:', parsed.length);
        } catch (e) {
            console.error('[HISTORY] –ù–µ—É–¥–∞—á–∞ –ø—Ä–∏ —Ä–∞–∑–±–∏—Ä–∞–Ω–µ –Ω–∞ JSON –∏—Å—Ç–æ—Ä–∏—è:', e.message);
            return [];
        }
    } else if (Array.isArray(history)) {
        parsed = history;
        console.log('[HISTORY] –ò–∑–ø–æ–ª–∑–≤–∞–º –º–∞—Å–∏–≤ –∏—Å—Ç–æ—Ä–∏—è, —Å—ä–æ–±—â–µ–Ω–∏—è:', parsed.length);
    }

    return parsed.map(msg => ({
        role: msg.role === 'assistant' ? 'model' : 'user',
        parts: [{ text: msg.content }]
    }));
}

/**
 * –û–°–ù–û–í–ù–ê –§–£–ù–ö–¶–ò–Ø –ó–ê –û–¢–ì–û–í–û–† –ù–ê AI –°–™–° –ú–ù–û–ì–û–ú–û–î–ï–õ–ù–ê –û–¢–ö–ê–ó–û–í–ê –õ–û–ì–ò–ö–ê
 * 
 * –û—Ä–≥–∞–Ω–∏–∑–∏—Ä–∞ –ø—ä–ª–Ω–∏—è –ø—Ä–æ—Ü–µ—Å:
 * 1. –í–∞–ª–∏–¥–∏—Ä–∞ –≤—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏
 * 2. –û–ø—Ä–µ–¥–µ–ª—è —Ä–æ–ª—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è (—Å—ä—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç)
 * 3. –ó–∞—Ä–µ–∂–¥–∞ –Ω–∞—Ä—ä—á–Ω–∏–∫ –Ω–∞ –∏–º–æ—Ç (–ø–æ—á–∏—Ç–∞–π–∫–∏ –ø—Ä–∞–≤–∏–ª–∞—Ç–∞ –Ω–∞ –∑–∞—â–∏—Ç–Ω–∞—Ç–∞ —Å—Ç–µ–Ω–∞)
 * 4. –ü–æ–ª—É—á–∞–≤–∞ —Å—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞
 * 5. –°—Ç—Ä–æ–∏ —Å–∏—Å—Ç–µ–º–Ω–æ —É–∫–∞–∑–∞–Ω–∏–µ –∑–∞ —Ä–æ–ª—è—Ç–∞
 * 6. –ó–∞–ø–∏—Ç–≤–∞ –ø—ä—Ä–≤–∏—á–Ω–∏—è –º–æ–¥–µ–ª Gemini
 * 7. –ê–ö–û –ø—ä—Ä–≤–∏—á–Ω–∏—è —Å–µ –ø—Ä–æ–≤–∞–ª–∏, –æ–ø–∏—Ç–≤–∞ –æ—Ç–∫–∞–∑–æ–≤–∏ –º–æ–¥–µ–ª–∏ (–∫–∞—Å–∫–∞–¥–∞ –æ—Ç 3 –º–æ–¥–µ–ª–∞)
 * 8. –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –∑–∞ —Å–ø–µ—à–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–∞ —Ç–æ–∫ –∏ –∑–∞–¥–µ–π—Å—Ç–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
 * 9. –û–±—Ä–∞–±–æ—Ç–≤–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏
 * 10. –í—Ä—ä—â–∞ —á–∏—Å—Ç –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * 
 * –°–¢–†–ê–¢–ï–ì–ò–Ø –ù–ê –û–¢–ö–ê–ó:
 * - –ü—ä—Ä–≤–æ –æ–ø–∏—Ç–≤–∞ gemini-3-pro-preview
 * - –û—Ç–∫–∞–∑ –∫—ä–º gemini-flash-latest –∞–∫–æ –ø—ä—Ä–≤–∏—á–Ω–∏—è —Å–µ –ø—Ä–æ–≤–∞–ª–∏
 * - –§–∏–Ω–∞–ª–µ–Ω –æ—Ç–∫–∞–∑ –∫—ä–º gemini-3-flash-preview
 * - –í—Ä—ä—â–∞ –æ–±—â–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –≥—Ä–µ—à–∫–∞, –∞–∫–æ –≤—Å–∏—á–∫–∏ –º–æ–¥–µ–ª–∏ —Å–µ –ø—Ä–æ–≤–∞–ª—è—Ç
 * 
 * @async
 * @param {string} userMessage - –í—Ö–æ–¥–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * @param {string|Array} history - –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä
 * @param {string|null} authCode - –ö–æ–¥ –∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç –∑–∞—è–≤–∫–∞
 * @returns {Promise<string>} –¢–µ–∫—Å—Ç –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ AI –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏
 */
export async function getAIResponse(userMessage, history = [], authCode = null) {
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë                 –ù–ê–ß–ê–õ–û –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê –û–¢–ì–û–í–û–† –ù–ê AI                  ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

    // –í–ê–õ–ò–î–ê–¶–ò–Ø –ù–ê –í–•–û–î–ù–ò –î–ê–ù–ù–ò
    if (!userMessage || userMessage.trim() === '') {
        console.log('[INPUT] –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω–æ –µ –ø—Ä–∞–∑–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ - –æ—Ç—Ö–≤—ä—Ä–ª—è–º');
        return "–ú–æ–ª—è –Ω–∞–ø–∏—à–µ—Ç–µ –≤–∞—à–∞—Ç–∞ –∑–∞—è–≤–∫–∞.";
    }

    console.log('[INPUT] –°—ä–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:', userMessage.substring(0, 100));

    // –í–ê–õ–ò–î–ê–¶–ò–Ø –ù–ê GEMINI –ö–õ–ò–ï–ù–¢
    if (!genAI) {
        console.error('[GEMINI] API –∫–ª—é—á –Ω–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω');
        return "‚ùå –ì—Ä–µ—à–∫–∞: Gemini API –∫–ª—é—á –Ω–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω.";
    }

    // –ó–ê–†–ï–ñ–î–ê–ù–ï –ù–ê –ù–ê–†–™–ß–ù–ò–ö (—Å—ä—Å –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞—â–∏—Ç–Ω–∞ —Å—Ç–µ–Ω–∞)
    console.log('[FILES] –ó–∞—Ä–µ–∂–¥–∞ –Ω–∞—Ä—ä—á–Ω–∏–∫ –Ω–∞ –∏–º–æ—Ç–∞...');
    let houseManual = "";
    try {
        houseManual = await fs.readFile(path.join(process.cwd(), 'manual.txt'), 'utf-8');
        console.log('[FILES] –ù–∞—Ä—ä—á–Ω–∏–∫ –∑–∞—Ä–µ–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ (' + houseManual.length + ' –±–∞–π—Ç–∞)');
    } catch (err) {
        console.error('[FILES] Manual.txt –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω, –∏–∑–ø–æ–ª–∑–≤–∞–º –≤—Ä—ä—â–∞–Ω–µ:', err.message);
        houseManual = "‚ö†Ô∏è –ù–∞—Ä—ä—á–Ω–∏–∫ –∑–∞ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—ä–ø–µ–Ω.";
    }

    // –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê –†–û–õ–Ø–¢–ê (—Å—ä—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç)
    const { role, data: bookingData } = await determineUserRole(authCode, userMessage);
    console.log('[ROLE] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ä–æ–ª—è –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è:', role);

    // –ó–ê–©–ò–¢–ù–ê –°–¢–ï–ù–ê: –ê–∫–æ –µ –Ω–µ–ø–æ–∑–Ω–∞—Ç, –∑–∞–º–µ–Ω–∏ –Ω–∞—Ä—ä—á–Ω–∏–∫–∞ —Å –ø—É–±–ª–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    if (role === 'stranger') {
        console.log('[FIREWALL] –û—Ç–∫—Ä–∏—Ç –µ –Ω–µ–ø–æ–∑–Ω–∞—Ç - –∑–∞–º–µ—Å—Ç–≤–∞–º –Ω–∞—Ä—ä—á–Ω–∏–∫–∞ —Å–∞–º–æ —Å –ø—É–±–ª–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è');
        houseManual = PUBLIC_INFO_FALLBACK;
    }

    // –°–¢–ê–¢–£–° –ù–ê –¢–û–ö
    const powerStatus = await automationClient.getPowerStatus();

    // –í–†–ï–ú–ï–í–ê –ú–ê–†–ê
    const currentDateTime = new Date().toLocaleString('bg-BG', {
        timeZone: 'Europe/Sofia',
        dateStyle: 'full',
        timeStyle: 'short'
    });

    // –°–ò–°–¢–ï–ú–ù–û –£–ö–ê–ó–ê–ù–ò–ï
    const systemInstruction = buildSystemInstruction(
        role,
        bookingData,
        powerStatus,
        houseManual,
        currentDateTime
    );

    console.log('[AI] –°–∏—Å—Ç–µ–º–Ω–æ —É–∫–∞–∑–∞–Ω–∏–µ –ø–æ–¥–≥–æ—Ç–≤–µ–Ω–æ –∑–∞ —Ä–æ–ª—è—Ç–∞:', role);

    // –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê –û–¢–ì–û–í–û–† –ù–ê AI –°–™–° –ú–ù–û–ì–û–ú–û–î–ï–õ–ù–ê –û–¢–ö–ê–ó–û–í–ê –õ–û–ì–ò–ö–ê
    let finalReply = "‚ùå –°—ä–∂–∞–ª—è–≤–∞–º, –∏–º–∞–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –ø—Ä–æ–±–ª–µ–º. –ú–æ–ª—è –æ–ø–∏—Ç–∞–π—Ç–µ –ø–∞–∫.";

    for (let modelIndex = 0; modelIndex < MODELS.length; modelIndex++) {
        const modelName = MODELS[modelIndex];
        console.log(`\n[GEMINI] –û–ø–∏—Ç–≤–∞–º –º–æ–¥–µ–ª ${modelIndex + 1}/${MODELS.length}: ${modelName}`);

        try {
            const model = genAI.getGenerativeModel({
                model: modelName,
                systemInstruction
            });

            console.log('[GEMINI] –ú–æ–¥–µ–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω, —Å—Ç–∞—Ä—Ç–∏—Ä–∞–º —Å–µ—Å–∏—è –∑–∞ —á–∞—Ç...');
            const chat = model.startChat({
                history: formatHistory(history)
            });

            console.log('[GEMINI] –ò–∑–ø—Ä–∞—â–∞–º —Å—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è –∫—ä–º –º–æ–¥–µ–ª...');
            const result = await chat.sendMessage(userMessage);
            finalReply = result.response.text();

            console.log(`[GEMINI] ‚úÖ –£–°–ü–ï–®–ù–û: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä –æ—Ç ${modelName}`);
            console.log('[GEMINI] –î—ä–ª–∂–∏–Ω–∞ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä:', finalReply.length);
            break;

        } catch (error) {
            console.error(`[GEMINI] ‚ùå –ú–æ–¥–µ–ª ${modelName} —Å–µ –ø—Ä–æ–≤–∞–ª–∏:`, error.message);

            if (modelIndex === MODELS.length - 1) {
                console.error('[GEMINI] –í—Å–∏—á–∫–∏ –æ—Ç–∫–∞–∑–æ–≤–∏ –º–æ–¥–µ–ª–∏ —Å–∞ –∏–∑—á–µ—Ä–ø–∞–Ω–∏');
            } else {
                console.log(`[GEMINI] –û–ø–∏—Ç–≤–∞–º –æ—Ç–∫–∞–∑–æ–≤ –º–æ–¥–µ–ª...`);
                continue;
            }
        }
    }

    // –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ü–ï–®–ù–û–°–¢ –ù–ê –¢–û–ö
    console.log('[FLOW] –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º –∑–∞ —Å–ø–µ—à–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–∞ —Ç–æ–∫...');
    const emergencyNote = await checkEmergencyPower(userMessage, role, bookingData);
    if (emergencyNote) {
        console.log('[FLOW] –°–∏—Å—Ç–µ–º–Ω–∞ –±–µ–ª–µ–∂–∫–∞ –∑–∞ —Å–ø–µ—à–Ω–æ—Å—Ç –Ω–∞ —Ç–æ–∫ –¥–æ–±–∞–≤–µ–Ω–∞ –∫—ä–º –æ—Ç–≥–æ–≤–æ—Ä');
        finalReply += emergencyNote;
    }

    // –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –ò–ó–í–ï–°–¢–£–í–ê–ù–ò–Ø
    console.log('[FLOW] –û–±—Ä–∞–±–æ—Ç–≤–∞–º –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏...');
    finalReply = await processAlerts(finalReply, role, bookingData);

    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë              –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê –û–¢–ì–û–í–û–† –ù–ê AI –ó–ê–í–™–†–®–ï–ù–û                  ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

    return finalReply;
}

// ============================================================================
// –§–£–ù–ö–¶–ò–Ø –ó–ê –û–ë–†–ê–¢–ù–ê –°–™–í–ú–ï–°–¢–ò–ú–û–°–¢
// ============================================================================

/**
 * –ù–∞—Å–ª–µ–¥–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç
 * –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –¥–∞–ª–∏ –∫–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ –∏ –≤—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç —Å—ä—Å —â–∏—Ñ—Ç
 * 
 * @async
 * @param {string} reservationCode - –ö–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è HM –Ω–∞ –≥–æ—Å—Ç
 * @returns {Promise<Object|null>} –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç —Å—ä—Å —â–∏—Ñ—Ç –∏–ª–∏ null –∞–∫–æ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞
 */
export async function checkBookingAndGetPin(reservationCode) {
    console.log('[LEGACY] checkBookingAndGetPin –≤–∏–∫–∞–Ω–∞ –∑–∞ –∫–æ–¥:', reservationCode);
    const { role, data } = await determineUserRole(reservationCode, '');

    if (role === 'guest' && data) {
        const result = {
            guest_name: data.guest_name,
            pin: data.lock_pin,
            check_in: data.check_in
        };
        console.log('[LEGACY] –í—Ä—ä—â–∞–º –¥–∞–Ω–Ω–∏ –Ω–∞ –≥–æ—Å—Ç:', result);
        return result;
    }

    console.log('[LEGACY] –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ –≤–∞–ª–∏–¥–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è');
    return null;
}