import { GoogleGenerativeAI } from '@google/generative-ai';
import { neon } from '@neondatabase/serverless';
import fs from 'fs/promises';
import path from 'path';

/**
 * ============================================================================
 * SMART-STAY AI SERVICE - –ñ–ï–õ–ï–ó–û–ë–ï–¢–û–ù–ù–ê –°–ò–°–¢–ï–ú–ê –ó–ê –°–ò–ì–£–†–ù–û–°–¢
 * ============================================================================
 * 
 * –¢–æ–∑–∏ —Å–µ—Ä–≤–∏—Å –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞ –º–æ—â–Ω–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –Ω–∞ –∏–º–æ—Ç–∞:
 * - –¢–û–ß–ù–û —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ –∫–æ–¥ –Ω–∞ –¥–æ–º–∞–∫–∏–Ω–∞ (–±–µ–∑ —Ä–∞–∑–º–∏—Ç–æ —Å—ä–≤–ø–∞–¥–µ–Ω–∏–µ)
 * - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç —á—Ä–µ–∑ HM –∫–æ–¥–æ–≤–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –≤ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏
 * - –ó–∞—â–∏—Ç–Ω–∞ —Å—Ç–µ–Ω–∞ –∑–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–≤–∞–Ω–µ –Ω–∞ –Ω–µ–æ—Ç–æ—Ä–∏–∑–∏—Ä–∞–Ω –¥–æ—Å—Ç—ä–ø –¥–æ –Ω–∞—Ä—ä—á–Ω–∏—Ü–∏
 * - –õ–æ–≥–∏–∫–∞ –Ω–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞ —â–∏—Ñ—Ç–æ–≤–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ
 * - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∞ –ø–æ–º–æ—â –ø—Ä–∏ –∞–≤–∞—Ä–∏–π–Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—è –Ω–∞ —Ç–æ–∫–∞ —Å –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏—è
 * - –û—Ç–∫–∞–∑–æ–ª–µ–∫–∞ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏ –∑–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏ –Ω–∞ AI
 * 
 * –°—ä–∑–¥–∞–Ω–æ: —Ñ–µ–≤—Ä—É–∞—Ä–∏ 2026
 */

// ============================================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================================================

/**
 * @const {string[]} MODELS - Gemini –º–æ–¥–µ–ª–∏ –≤ —Ä–µ–¥ –Ω–∞ –æ—Ç–∫–∞–∑
 * –ü—ä—Ä–≤–∏—á–µ–Ω –º–æ–¥–µ–ª, –ø–æ—Å–ª–µ–¥–≤–∞–Ω –æ—Ç –∫–∞—Å–∫–∞–¥–Ω–∏ –æ—Ç–∫–∞–∑–Ω–∏ –∑–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç
 */
const MODELS = ["gemini-3-pro-preview", "gemini-flash-latest", "gemini-3-flash-preview"];

/**
 * @const {any} sql - Neon –∫–ª–∏–µ–Ω—Ç –Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏ –∑–∞ PostgreSQL –∑–∞—è–≤–∫–∏
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω –æ—Ç DATABASE_URL –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞ –Ω–∞ –æ–∫—Ä—ä–∂–µ–Ω–∏–µ
 */
const sql = process.env.DATABASE_URL ? neon(process.env.DATABASE_URL) : null;

/**
 * @const {GoogleGenerativeAI} genAI - Google Generative AI –∫–ª–∏–µ–Ω—Ç
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω –æ—Ç GEMINI_API_KEY –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞ –Ω–∞ –æ–∫—Ä—ä–∂–µ–Ω–∏–µ
 */
const genAI = process.env.GEMINI_API_KEY ? new GoogleGenerativeAI(process.env.GEMINI_API_KEY) : null;

/**
 * @const {string} AUTOMATION_URL - –ë–∞–∑–æ–≤ URL –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
 * –ú–∞—Ä—à—Ä—É—Ç–∏ –∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª –Ω–∞ —Ç–æ–∫–∞, –ø–æ–ª—É—á–∞–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç—É—Å –∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏—è
 */
const AUTOMATION_URL = process.env.AUTOMATION_SERVICE_URL || 'http://localhost:10000';

/**
 * @const {string} HOST_CODE - –ö–†–ò–¢–ò–ß–ù–û: –¢–∞–π–Ω–∏—è –∫–æ–¥ –Ω–∞ –¥–æ–º–∞–∫–∏–Ω–∞
 * –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ –∑–∞ 100% —Ç–æ—á–Ω–æ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (—Ä–∞–∑–º–∏—Ç–æ—Ç–æ —Å—ä–≤–ø–∞–¥–µ–Ω–∏–µ –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ)
 * –°—ä—Ö—Ä–∞–Ω—è–≤–∞ —Å–µ –≤ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞ –Ω–∞ –æ–∫—Ä—ä–∂–µ–Ω–∏–µ, –Ω–∏–∫–æ–≥–∞ –Ω–µ –µ —Ç–≤—ä—Ä–¥–æ –∫–æ–¥–∏—Ä–∞–Ω–∞
 */
const HOST_CODE = process.env.HOST_CODE;

/**
 * @const {string} PUBLIC_INFO_FALLBACK - –¢–≤—ä—Ä–¥–æ –∫–æ–¥–∏—Ä–∞–Ω–∞ –ø—É–±–ª–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
 * –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ, –∫–æ–≥–¥–∞ —Ä–æ–ª—è—Ç–∞ –µ '–Ω–µ–ø–æ–∑–Ω–∞—Ç' –∑–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–≤–∞–Ω–µ –Ω–∞ –Ω–µ–æ—Ç–æ—Ä–∏–∑–∏—Ä–∞–Ω –¥–æ—Å—Ç—ä–ø –¥–æ manual.txt
 * –°—ä–¥—ä—Ä–∂–∞ —Å–∞–º–æ –∞–¥—Ä–µ—Å –Ω–∞ –∏–º–æ—Ç, —É–¥–æ–±—Å—Ç–≤–∞ –∏ –æ–±—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
 * –ö–†–ò–¢–ò–ß–ù–ê –ó–ê–©–ò–¢–ù–ê –°–¢–ï–ù–ê: –¢–æ–≤–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–≤–∞ —Ä–∞–∑—Ç–∏—á–∞–Ω–µ –Ω–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–Ω–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏ –¥–µ—Ç–∞–π–ª–∏
 */
const PUBLIC_INFO_FALLBACK = `
üè† ASPEN VALLEY - –ê–ü–ê–†–¢–ê–ú–ï–ù–¢ D105

üîë –†–ï–ó–ï–†–í–ê–¶–ò–Ø:
- –ó–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –≥–æ—Å—Ç–∏: –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞—à–∏—è –∫–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
- –ó–∞ –Ω–æ–≤–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏: –ø–æ—Å–µ—Ç–µ—Ç–µ –Ω–∞—à–∏—è —É–µ–±—Å–∞–π—Ç

‚ö†Ô∏è –í–ê–ñ–ù–û:
- –ü–∞—Ä–æ–ª–∏—Ç–µ –∏ –∫–æ–¥–æ–≤–µ—Ç–µ –Ω–µ —Å–µ –¥–∞–≤–∞—Ç –Ω–∞ –Ω–µ–ø–æ–∑–Ω–∞—Ç–∏
- –ó–∞ –¥–æ—Å—Ç—ä–ø –¥–æ —É—Å–ª—É–≥–∏ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
`;


// ============================================================================
// –ö–õ–ò–ï–ù–¢ –ù–ê –£–°–õ–£–ì–ê–¢–ê –ó–ê –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø
// ============================================================================

/**
 * @namespace automationClient
 * @description –ö–∞–ø—Å—É–ª–∏—Ä–∞ –≤—Å—è –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—è —Å –≤—ä–Ω—à–Ω–∞—Ç–∞ —É—Å–ª—É–≥–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
 * –£–ø—Ä–∞–≤–ª—è–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫–∞, –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏—è –∏ –∑–∞—è–≤–∫–∏ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
 */
const automationClient = {
    /**
     * –ü–æ–ª—É—á–∞–≤–∞ —Ç–µ–∫—É—â–∏—è —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –∑–∞ —Ç–æ–∫–∞ –æ—Ç —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
     * @async
     * @returns {Promise<{online: boolean, isOn: boolean}>} –û–±–µ–∫—Ç —Å—ä—Å —Å—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞
     * @throws –ú—ä–ª—á–∞–ª–∏–≤–æ –≤—Ä—ä—â–∞ –æ—Ñ–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –º—Ä–µ–∂–æ–≤–∞ –≥—Ä–µ—à–∫–∞
     */
    async getPowerStatus() {
        try {
            console.log('[AUTOMATION] –ü–æ–ª—É—á–∞–≤–∞–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞ –æ—Ç —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è...');
            const res = await fetch(`${AUTOMATION_URL}/api/power-status`);
            if (!res.ok) {
                console.warn('[AUTOMATION] –ö—Ä–∞–π–Ω–∞—Ç–∞ —Ç–æ—á–∫–∞ –≤—ä—Ä–Ω–∞ —Å—Ç–∞—Ç—É—Å, —Ä–∞–∑–ª–∏—á–µ–Ω –æ—Ç 200:', res.status);
                return { online: false, isOn: false };
            }
            const status = await res.json();
            console.log('[AUTOMATION] –°—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞ –ø–æ–ª—É—á–µ–Ω:', status);
            return status;
        } catch (e) {
            console.error('[AUTOMATION] –ü—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞ –Ω–µ —É—Å–ø—è:', e.message);
            return { online: false, isOn: false };
        }
    },

    /**
     * –£–ø—Ä–∞–≤–ª—è–≤–∞ —Å—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ –Ω–∞ —Ç–æ–∫–∞ —á—Ä–µ–∑ —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
     * –ö–†–ò–¢–ò–ß–ù–û: –í–∏–∫–∞ –æ–±–Ω–æ–≤–µ–Ω–∏—è API endpoint, –∫–æ–π—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ä–∞ Telegram –∫–æ–º–∞–Ω–¥–∞
     * - true –∏–∑–ø—Ä–∞—â–∞ '–í–ö–õ' –∫—ä–º Telegram –±–æ—Ç
     * - false –∏–∑–ø—Ä–∞—â–∞ '–ò–ó–ö–õ' –∫—ä–º Telegram –±–æ—Ç
     * 
     * –°–µ –≤–∏–∫–∞ –ø—Ä–∏ —Å–ø–µ—à–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ (–≥–æ—Å—Ç –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫) –∏–ª–∏ –ø—Ä–∏ AI –∫–æ–º–∞–Ω–¥–∏
     * @async
     * @param {boolean} state - True –∑–∞ –≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫–∞, false –∑–∞ –∏–∑–∫–ª—é—á–≤–∞–Ω–µ
     * @returns {Promise<boolean>} True –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, false –≤ –ø—Ä–æ—Ç–∏–≤–Ω–∏—è —Å–ª—É—á–∞–π
     * @throws –ú—ä–ª—á–∞–ª–∏–≤–æ –≤—Ä—ä—â–∞ false –ø—Ä–∏ –º—Ä–µ–∂–æ–≤–∞ –≥—Ä–µ—à–∫–∞
     */
    async controlPower(state) {
        try {
            console.log('[AUTOMATION] –ò–∑–ø—Ä–∞—â–∞–º –∫–æ–º–∞–Ω–¥–∞ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫–∞ (—Å—ä—Å Telegram):', state ? '–í–ö–õ–Æ–ß–ò (–í–ö–õ)' : '–ò–ó–ö–õ–Æ–ß–ò (–ò–ó–ö–õ)');
            const res = await fetch(`${AUTOMATION_URL}/api/power-control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ state })
            });
            const success = res.ok;
            if (success) {
                const data = await res.json();
                console.log('[AUTOMATION] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫ –£–°–ü–ï–®–ù–û - Telegram —Å—Ç–∞—Ç—É—Å:', data.telegramSent ? '‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω–æ' : '‚ö†Ô∏è –ù–µ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ');
            } else {
                console.log('[AUTOMATION] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫ –ù–ï–£–î–ê–ß–ù–û (—Å—Ç–∞—Ç—É—Å ' + res.status + ')');
            }
            return success;
        } catch (e) {
            console.error('[AUTOMATION] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ—Ç–æ –Ω–∞ —Ç–æ–∫–∞ –Ω–µ —É—Å–ø—è:', e.message);
            return false;
        }
    },

    /**
     * –ò–∑–ø—Ä–∞—â–∞ —Å–ø–µ—à–Ω–æ –∏–∑–≤–µ—Å—Ç—É–≤–∞—ö–µ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞ —á—Ä–µ–∑ —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
     * –ê–∫—Ç–∏–≤–∏—Ä–∞ —Å–µ, –∫–æ–≥–∞—Ç–æ –≥–æ—Å—Ç –¥–æ–∫–ª–∞–¥–≤–∞ –ø—Ä–æ–±–ª–µ–º–∏ –∏–ª–∏ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –æ—Ç–∫—Ä–∏–µ –ø—Ä–æ–±–ª–µ–º–∏
     * @async
     * @param {string} message - –ò–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ, –æ–ø–∏—Å–≤–∞—â–æ —Å–∏—Ç—É–∞—Ü–∏—è—Ç–∞
     * @param {Object} guestInfo - –û–±–µ–∫—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥–æ—Å—Ç–∞
     * @param {string} guestInfo.guest_name - –ü—ä–ª–Ω–æ—Ç–æ –∏–º–µ –Ω–∞ –≥–æ—Å—Ç–∞
     * @param {string} guestInfo.reservation_code - HM –∫–æ–¥, –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–∞—â —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è—Ç–∞
     * @returns {Promise<boolean>} True, –∞–∫–æ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏–µ—Ç–æ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
     */
    async sendAlert(message, guestInfo) {
        try {
            console.log('[AUTOMATION] –ò–∑–ø—Ä–∞—â–∞–º –∏–∑–≤–µ—Å—Ç—É–≤–∞—ö–µ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞:', message);
            await fetch(`${AUTOMATION_URL}/api/alert`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, guestInfo })
            });
            console.log('[AUTOMATION] –ò–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏–µ—Ç–æ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
            return true;
        } catch (e) {
            console.error('[AUTOMATION] –ò–∑–ø—Ä–∞—â–∞–Ω–µ—Ç–æ –Ω–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–µ –Ω–µ —É—Å–ø—è:', e.message);
            return false;
        }
    },

    /**
     * –ü–æ–ª—É—á–∞–≤–∞ –≤—Å–∏—á–∫–∏ —Ç–µ–∫—É—â–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –æ—Ç —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
     * –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ –∑–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç –∏ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —â–∏—Ñ—Ç
     * @async
     * @returns {Promise<Array>} –ú–∞—Å–∏–≤ –æ—Ç –æ–±–µ–∫—Ç–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –æ—Ç –±–∞–∑–∞ –¥–∞–Ω–Ω–∏
     */
    async getBookings() {
        try {
            console.log('[AUTOMATION] –ü–æ–ª—É—á–∞–≤–∞–º –≤—Å–∏—á–∫–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏...');
            const res = await fetch(`${AUTOMATION_URL}/api/bookings`);
            if (!res.ok) {
                console.warn('[AUTOMATION] –ö—Ä–∞–π–Ω–∞—Ç–∞ —Ç–æ—á–∫–∞ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –Ω–µ —É—Å–ø—è:', res.status);
                return [];
            }
            const bookings = await res.json();
            console.log('[AUTOMATION] –ü–æ–ª—É—á–µ–Ω–∏', bookings.length, '—Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏');
            return bookings;
        } catch (e) {
            console.error('[AUTOMATION] –ü–æ–ª—É—á–∞–≤–∞–Ω–µ—Ç–æ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –Ω–µ —É—Å–ø—è:', e.message);
            return [];
        }
    }
};

// ============================================================================
// –°–õ–û–ô –ó–ê –°–ò–ì–£–†–ù–û–°–¢: –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê –†–û–õ–Ø–¢–ê –ù–ê –ü–û–¢–†–ï–ë–ò–¢–ï–õ–Ø
// ============================================================================

/**
 * –ñ–ï–õ–ï–ó–û–ë–ï–¢–û–ù–ù–ê –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ù–ê –î–û–ú–ê–ö–ò–ù–ê - –¢–û–ß–ù–û –°–™–û–¢–í–ï–¢–°–¢–í–ò–ï –ù–ê –ö–û–î
 * 
 * –û–ø—Ä–µ–¥–µ–ª—è –¥–∞–ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –î–û–ú–ê–ö–ò–ù–ê, –∫–∞—Ç–æ —Å—Ä–∞–≤–Ω—è–≤–∞ —Å process.env.HOST_CODE
 * –ö–†–ò–¢–ò–ß–ù–ê –°–ò–ì–£–†–ù–û–°–¢: –ò–∑–ø–æ–ª–∑–≤–∞ === –∑–∞ –¢–û–ß–ù–û —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ —Å—Ç—Ä–æ–∫–∞
 * –ó–ê–ë–†–ê–ù–ï–ù–û: .includes(), —Ä–∞–∑–º–∏—Ç–æ —Å—ä–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ –Ω–∏–∑–æ–≤–µ
 * 
 * @private
 * @param {string|null} authCode - –ö–æ–¥ –æ—Ç –∑–∞–≥–ª–∞–≤–∫–∞ –∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ —Ñ–æ—Ä–º–∞
 * @param {string|null} userMessage - –°—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –∑–∞ –≤–≥—Ä–∞–¥–µ–Ω –∫–æ–¥)
 * @returns {boolean} True —Å–∞–º–æ –∞–∫–æ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ –¢–û–ß–ù–û —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
 */
function isHostVerified(authCode, userMessage) {
    // –ü–†–ê–í–ò–õ–û –ù–ê –°–ò–ì–£–†–ù–û–°–¢ #1: –¢–û–ß–ù–û –°–™–û–¢–í–ï–¢–°–¢–í–ò–ï –ù–ê –ö–û–î –ù–ê –î–û–ú–ê–ö–ò–ù–ê
    // –ù–ï –∏–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ .includes() - —Ç—Ä—è–±–≤–∞ –¥–∞ –µ 100% —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
    
    console.log('[SECURITY] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –¥–æ–º–∞–∫–∏–Ω–∞: –ø—Ä–æ–≤–µ—Ä—è–≤–∞–º authCode...');
    if (authCode && authCode === HOST_CODE) {
        console.log('[SECURITY] ‚úÖ –î–û–ú–ê–ö–ò–ù –í–ï–†–ò–§–ò–¶–ò–†–ê–ù: authCode —Å—ä–≤–ø–∞–¥–∞ —Ç–æ—á–Ω–æ —Å HOST_CODE');
        return true;
    }

    if (userMessage) {
        console.log('[SECURITY] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –¥–æ–º–∞–∫–∏–Ω–∞: –ø—Ä–æ–≤–µ—Ä—è–≤–∞–º userMessage...');
        const trimmedMessage = String(userMessage).trim();
        if (trimmedMessage === HOST_CODE) {
            console.log('[SECURITY] ‚úÖ –î–û–ú–ê–ö–ò–ù –í–ï–†–ò–§–ò–¶–ò–†–ê–ù: userMessage —Å—ä–≤–ø–∞–¥–∞ —Ç–æ—á–Ω–æ —Å HOST_CODE');
            return true;
        }
    }

    console.log('[SECURITY] ‚ùå –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –¥–æ–º–∞–∫–∏–Ω–∞ –ù–ï–£–î–ê–ß–ù–ê: –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ —Ç–æ—á–Ω–æ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ');
    return false;
}

/**
 * –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ù–ê –ì–û–°–¢ –ß–†–ï–ó HM –ö–û–î–û–í–ï –ù–ê –†–ï–ó–ï–†–í–ê–¶–ò–ò
 * 
 * –ò–∑–ø–æ–ª–∑–≤–∞ regex –∑–∞ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ HM –∫–æ–¥–æ–≤–µ –æ—Ç —Å—ä–æ–±—â–µ–Ω–∏—è –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ä–µ—â—É —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
 * HM –∫–æ–¥–æ–≤–µ —Å–∞ —É–Ω–∏–∫–∞–ª–Ω–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∏ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –Ω–∞ –≥–æ—Å—Ç–∏
 * 
 * @private
 * @async
 * @param {string|null} authCode - –ö–æ–¥, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω –≤ –∑–∞–≥–ª–∞–≤–∫–∞—Ç–∞ –∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
 * @param {string} userMessage - –°—ä–æ–±—â–µ–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–Ω–æ —Å—ä–¥—ä—Ä–∂–∞—â–æ HM –∫–æ–¥
 * @returns {Promise<{role: 'guest'|'stranger', booking: Object|null}>}
 */
async function verifyGuestByHMCode(authCode, userMessage) {
    console.log('[SECURITY] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç: —Ç—ä—Ä—Å—è HM –∫–æ–¥...');
    
    // –ü–†–ê–í–ò–õ–û –ù–ê –°–ò–ì–£–†–ù–û–°–¢ #2: REGEX –®–ê–ë–õ–û–ù –ó–ê HM –ö–û–î–û–í–ï
    // –®–∞–±–ª–æ–Ω: HM seguito –æ—Ç –∞–ª—Ñ–∞–Ω—É–º–µ—Ä–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏ (—Ñ–æ—Ä–º–∞—Ç –Ω–∞ –∫–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è)
    const hmCodePattern = /HM[A-Z0-9]+/i;
    
    // –ü—Ä–æ–≤–µ—Ä—è authCode –ø—ä—Ä–≤–æ
    let codeToVerify = null;
    if (authCode && hmCodePattern.test(authCode)) {
        codeToVerify = authCode.toUpperCase();
        console.log('[SECURITY] HM –∫–æ–¥ –Ω–∞–º–µ—Ä–µ–Ω –≤ authCode:', codeToVerify);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è userMessage –∑–∞ –≤–≥—Ä–∞–¥–µ–Ω HM –∫–æ–¥
    if (!codeToVerify && userMessage) {
        const match = userMessage.match(hmCodePattern);
        if (match) {
            codeToVerify = match[0].toUpperCase();
            console.log('[SECURITY] HM –∫–æ–¥ –Ω–∞–º–µ—Ä–µ–Ω –≤ userMessage:', codeToVerify);
        }
    }

    if (!codeToVerify) {
        console.log('[SECURITY] –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω HM –∫–æ–¥ –≤ authCode –∏–ª–∏ —Å—ä–æ–±—â–µ–Ω–∏–µ');
        return { role: 'stranger', booking: null };
    }

    // –ê–∫–æ –Ω—è–º–∞–º–µ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏, –Ω–µ –º–æ–∂–µ–º –¥–∞ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–∞–º–µ
    if (!sql) {
        console.warn('[DATABASE] SQL –∫–ª–∏–µ–Ω—Ç –Ω–µ –µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω - –Ω–µ –º–æ–≥–∞ –¥–∞ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–∞–º HM –∫–æ–¥');
        return { role: 'stranger', booking: null };
    }

    try {
        console.log('[DATABASE] –ó–∞–ø–∏—Ç–≤–∞–º —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –∑–∞ HM –∫–æ–¥:', codeToVerify);
        const bookings = await sql`
            SELECT * FROM bookings 
            WHERE UPPER(reservation_code) = ${codeToVerify.toUpperCase()}
            LIMIT 1
        `;

        if (bookings.length > 0) {
            const booking = bookings[0];
            console.log('[DATABASE] ‚úÖ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∞ –∑–∞ –∫–æ–¥:', codeToVerify);
            console.log('[DATABASE] –ò–º–µ –Ω–∞ –≥–æ—Å—Ç:', booking.guest_name);
            return { role: 'guest', booking };
        }

        console.log('[DATABASE] ‚ùå –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –∑–∞ HM –∫–æ–¥:', codeToVerify);
        return { role: 'stranger', booking: null };
    } catch (e) {
        console.error('[DATABASE] –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Ç–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏:', e.message);
        return { role: 'stranger', booking: null };
    }
}

/**
 * –õ–û–ì–ò–ö–ê –ù–ê –•–†–ê–ù–ò–õ–ò–©–ï –ù–ê –©–ò–§–¢–û–í–ï - –ê–í–¢–û–ú–ê–¢–ò–ß–ù–û –†–ê–ó–ü–†–ï–î–ï–õ–Ø–ù–ï
 * 
 * –í–∑–µ–º–∏ –ø—ä—Ä–≤–∏—è –Ω–µ–∏–∑–ø–æ–ª–∑–≤–∞–Ω —â–∏—Ñ—Ç –æ—Ç —Ç–∞–±–ª–∏—Ü–∞ pin_depot
 * –ú–∞—Ä–∫–∏—Ä–∞ –≥–æ –∫–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω –≤ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏
 * –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è—Ç–∞ –Ω–∞ –≥–æ—Å—Ç —Å—ä—Å —Å–≤–æ—è –Ω–∞–∑–Ω–∞—á–µ–Ω —â–∏—Ñ—Ç
 * 
 * –ö–†–ò–¢–ò–ß–ù–û: –í–∏–∫–∞ —Å–µ —Å–∞–º–æ –≤–µ–¥–Ω—ä–∂ –Ω–∞ –≥–æ—Å—Ç (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞–Ω–µ –Ω–∞ lock_pin)
 * –ì–∞—Ä–∞–Ω—Ç–∏—Ä–∞, —á–µ –≤—Å–µ–∫–∏ –≥–æ—Å—Ç –ø–æ–ª—É—á–∞–≤–∞ —É–Ω–∏–∫–∞–ª–µ–Ω —â–∏—Ñ—Ç –∑–∞ –¥–æ—Å—Ç—ä–ø –¥–æ –∏–º–æ—Ç–∞
 * 
 * @private
 * @async
 * @param {Object} booking - –û–±–µ–∫—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –æ—Ç –±–∞–∑–∞ –¥–∞–Ω–Ω–∏
 * @returns {Promise<string|null>} –ù–∞–∑–Ω–∞—á–µ–Ω —â–∏—Ñ—Ç –∫–æ–¥ –∏–ª–∏ null –∞–∫–æ –Ω—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏
 */
async function assignPinFromDepot(booking) {
    console.log('[PIN_DEPOT] –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º –¥–∞–ª–∏ –≥–æ—Å—Ç –≤–µ—á–µ –∏–º–∞ —â–∏—Ñ—Ç...');
    
    // –ê–∫–æ –≥–æ—Å—Ç –≤–µ—á–µ –∏–º–∞ —â–∏—Ñ—Ç, –≥–æ –≤—ä—Ä–Ω–∏
    if (booking.lock_pin) {
        console.log('[PIN_DEPOT] –ì–æ—Å—Ç –≤–µ—á–µ –∏–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω —â–∏—Ñ—Ç:', booking.lock_pin);
        return booking.lock_pin;
    }

    console.log('[PIN_DEPOT] –ì–æ—Å—Ç –≤—Å–µ –æ—â–µ –Ω–µ–º–∞ —â–∏—Ñ—Ç - –≤–∑–µ–º–∞–º –æ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ...');

    if (!sql) {
        console.warn('[PIN_DEPOT] SQL –Ω–µ –µ –Ω–∞–ª–∏—á–Ω–æ - –Ω–µ –º–æ–≥–∞ –¥–∞ –Ω–∞–∑–Ω–∞—á–∞ —â–∏—Ñ—Ç');
        return null;
    }

    try {
        console.log('[DATABASE] –ó–∞–ø–∏—Ç–≤–∞–º pin_depot –∑–∞ –ø—ä—Ä–≤–∏ –Ω–µ–∏–∑–ø–æ–ª–∑–≤–∞–Ω —â–∏—Ñ—Ç...');
        const freePins = await sql`
            SELECT id, pin_code FROM pin_depot 
            WHERE is_used = FALSE 
            ORDER BY id ASC 
            LIMIT 1
        `;

        if (freePins.length === 0) {
            console.error('[PIN_DEPOT] ‚ùå –ù—è–º–∞–º–µ –Ω–∞–ª–∏—á–Ω–∏ –Ω–µ–∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏ —â–∏—Ñ—Ç–æ–≤–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ—Ç–æ!');
            return null;
        }

        const pin = freePins[0];
        console.log('[PIN_DEPOT] –ù–∞–º–µ—Ä–µ–Ω –Ω–∞–ª–∏—á–Ω–∞ —â–∏—Ñ—Ç, –º–∞—Ä–∫–∏—Ä–∞–º –∫–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω:', pin.pin_code);

        // –ú–∞—Ä–∫–∏—Ä–∞ —â–∏—Ñ—Ç–∞ –∫–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ—Ç–æ
        await sql`
            UPDATE pin_depot 
            SET is_used = TRUE, assigned_at = NOW()
            WHERE id = ${pin.id}
        `;
        console.log('[PIN_DEPOT] ‚úÖ –©–∏—Ñ—Ç –º–∞—Ä–∫–∏—Ä–∞–Ω –∫–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ—Ç–æ');

        // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è—Ç–∞ —Å –Ω–æ–≤–∏—è —â–∏—Ñ—Ç
        console.log('[DATABASE] –ù–∞–∑–Ω–∞—á–∞–≤–∞–º —â–∏—Ñ—Ç –Ω–∞ –∑–∞–ø–∏—Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è...');
        await sql`
            UPDATE bookings 
            SET lock_pin = ${pin.pin_code}, pin_assigned_at = NOW()
            WHERE id = ${booking.id}
        `;
        console.log('[PIN_DEPOT] ‚úÖ –©–∏—Ñ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç:', pin.pin_code);

        return pin.pin_code;
    } catch (e) {
        console.error('[PIN_DEPOT] –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —â–∏—Ñ—Ç:', e.message);
        return null;
    }
}

/**
 * –û–°–ù–û–í–ù–ê –§–£–ù–ö–¶–ò–Ø –ó–ê –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê –†–û–õ–Ø–¢–ê
 * 
 * –û—Ä–≥–∞–Ω–∏–∑–∏—Ä–∞ –≤—Å–∏—á–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç, –∑–∞ –¥–∞ –æ–ø—Ä–µ–¥–µ–ª–∏ —Ä–æ–ª—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è:
 * 1. –ï –ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –î–û–ú–ê–ö–ò–ù–ê? (–¢–û–ß–ù–û —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ –∫–æ–¥)
 * 2. –ï –ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –ì–û–°–¢? (HM –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –∫–æ–¥ –≤ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏)
 * 3. –í –ø—Ä–æ—Ç–∏–≤–Ω–∏—è —Å–ª—É—á–∞–π: –ù–ï–ü–û–ó–ù–ê–¢ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ—Å—Ç—ä–ø)
 * 
 * –ó–∞ –≥–æ—Å—Ç–∏, —Å—ä—â–æ –æ–±—Ä–∞–±–æ—Ç–≤–∞ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —â–∏—Ñ—Ç –æ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
 * 
 * @async
 * @param {string|null} authCode - –ö–æ–¥ –∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç –∑–∞—è–≤–∫–∞
 * @param {string|null} userMessage - –¢–µ–∫—Å—Ç –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * @returns {Promise<{role: 'host'|'guest'|'stranger', data: Object|null}>}
 *          –í—Ä—ä—â–∞ —Ä–æ–ª—è—Ç–∞ –∏ —Å–≤—ä—Ä–∑–∞–Ω–∏—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω–∏ (–∏–Ω—Ñ–æ –Ω–∞ –≥–æ—Å—Ç, –¥–∞–Ω–Ω–∏ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è)
 */
export async function determineUserRole(authCode, userMessage) {
    console.log('\n[SECURITY] ========== –ù–ê–ß–ê–õ–û –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê –†–û–õ–Ø–¢–ê –ù–ê –ü–û–¢–†–ï–ë–ò–¢–ï–õ–Ø ==========');
    console.log('[SECURITY] authCode –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω:', !!authCode);
    console.log('[SECURITY] userMessage –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω:', !!userMessage);

    // –ü–†–û–í–ï–†–ö–ê #1: –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ù–ê –î–û–ú–ê–ö–ò–ù–ê (–¢–û–ß–ù–û –°–™–û–¢–í–ï–¢–°–¢–í–ò–ï –ù–ê –ö–û–î)
    if (isHostVerified(authCode, userMessage)) {
        console.log('[SECURITY] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ä–æ–ª—è: –î–û–ú–ê–ö–ò–ù');
        console.log('[SECURITY] ========== –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ò–ì–£–†–ù–û–°–¢ –ó–ê–í–™–†–®–ï–ù–ê ==========\n');
        return { role: 'host', data: null };
    }

    // –ü–†–û–í–ï–†–ö–ê #2: –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ù–ê –ì–û–°–¢ (HM –ö–û–î –í –ë–ê–ó–ê –î–ê–ù–ù–ò)
    const guestCheck = await verifyGuestByHMCode(authCode, userMessage);
    if (guestCheck.role === 'guest' && guestCheck.booking) {
        const booking = guestCheck.booking;
        console.log('[PIN_DEPOT] –û–±—Ä–∞–±–æ—Ç–≤–∞–º —Ä–∞–∑–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —â–∏—Ñ—Ç –∑–∞ –≥–æ—Å—Ç...');

        // –ù–∞–∑–Ω–∞—á–∞–≤–∞ —â–∏—Ñ—Ç –∞–∫–æ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
        const lockPin = await assignPinFromDepot(booking);

        const guestData = {
            guest_name: booking.guest_name,
            reservation_code: booking.reservation_code,
            check_in: booking.check_in,
            check_out: booking.check_out,
            lock_pin: lockPin,
            booking_id: booking.id
        };

        console.log('[SECURITY] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ä–æ–ª—è: –ì–û–°–¢');
        console.log('[SECURITY] –î–∞–Ω–Ω–∏ –Ω–∞ –≥–æ—Å—Ç –ø–æ–¥–≥–æ—Ç–≤–µ–Ω–∏:', guestData.guest_name);
        console.log('[SECURITY] ========== –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ò–ì–£–†–ù–û–°–¢ –ó–ê–í–™–†–®–ï–ù–ê ==========\n');
        return { role: 'guest', data: guestData };
    }

    // –ü–û –ü–û–î–†–ê–ó–ë–ò–†–ê–ù–ï: –ù–ï–ü–û–ó–ù–ê–¢ (–û–ì–†–ê–ù–ò–ß–ï–ù –î–û–°–¢–™–ü)
    console.log('[SECURITY] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ä–æ–ª—è: –ù–ï–ü–û–ó–ù–ê–¢');
    console.log('[SECURITY] ========== –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ò–ì–£–†–ù–û–°–¢ –ó–ê–í–™–†–®–ï–ù–ê ==========\n');
    return { role: 'stranger', data: null };
}

// ============================================================================
// –°–¢–†–û–ò–¢–ï–õ –ù–ê –°–ò–°–¢–ï–ú–ù–û –£–ö–ê–ó–ê–ù–ò–ï - SINGLE SOURCE OF TRUTH (SSoT) –ê–†–•–ò–¢–ï–ö–¢–£–†–ê
// ============================================================================

/**
 * ‚öôÔ∏è –ê–ù–ê–õ–ò–ó –ù–ê –†–ï–§–ê–ö–¢–û–†–ò–†–ê–ù–ï - SINGLE SOURCE OF TRUTH –ü–†–ò–ù–¶–ò–ü
 * 
 * –ü–†–û–ë–õ–ï–ú - –°—Ç–∞—Ä–∞—Ç–∞ –≤–µ—Ä—Å–∏—è:
 * ‚ùå –•–∞—Ä–¥–∫–æ–¥–∏—Ä–∞–Ω–∏ –¥–∞–Ω–Ω–∏ –≤—ä—Ç—Ä–µ –≤ JavaScript (Apartment D105, SmartStay_Guest, etc.)
 * ‚ùå –î—É–±–ª–∏—Ä–∞–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–µ–∂–¥—É JavaScript –∏ manual.txt
 * ‚ùå AI –±–µ—à–µ –ø–æ–¥–≤–ª–∞—Å—Ç–µ–Ω –Ω–∞ JavaScript –ª–æ–≥–∏–∫–∞, –Ω–µ –Ω–∞ manual
 * ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∏ –ø—Ä–∏ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ –Ω–∞ –∏–º–æ—Ç–∞
 * 
 * –†–ï–®–ï–ù–ò–ï - SSoT –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
 * ‚úÖ –ï–î–ò–ù –∏–∑—Ç–æ—á–Ω–∏–∫ –Ω–∞ –∏—Å—Ç–∏–Ω–∞ = manual.txt —Ñ–∞–π–ª—ä—Ç
 * ‚úÖ JavaScript –µ —Å–∞–º–æ "–º–∞—à–∏–Ω–∞ –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞" –Ω–∞ –¥–∞–Ω–Ω–∏
 * ‚úÖ –î–∏–Ω–∞–º–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏ = bookingData + powerStatus
 * ‚úÖ AI –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∞–∫–∞–∑–≤–∞—Ç: "–ò–∑–ø–æ–ª–∑–≤–∞–π –°–ê–ú–û manual —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ"
 * 
 * –ü–û–¢–û–ö –ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
 * 1. manual.txt (–≤—Å–∏—á–∫–æ –∑–∞ –∏–º–æ—Ç–∞ - WiFi, –ø—Ä–∞–≤–∏–ª–∞, —É–¥–æ–±—Å—Ç–≤–∞, –∫–æ–Ω—Ç–∞–∫—Ç–∏)
 * 2. bookingData (–∫–æ–π –µ –≥–æ—Å—Ç—ä—Ç, –∫–æ–≥–∞—Ç–æ –ø—Ä–∏—Å—Ç–∏–≥–∞, –∫–æ–≥–∞—Ç–æ —Å–∏ —Ç—Ä—ä–≥–≤–∞)
 * 3. powerStatus (–¥–∞–ª–∏ —Ç–æ–∫–∞ –µ —Ä–∞–±–æ—Ç–∏)
 * 4. currentDateTime (–∫–æ–≥–∞—Ç–æ –µ —Å–µ–≥–∞)
 * 5. role (–¥–æ–º–∞–∫–∏–Ω/–≥–æ—Å—Ç/–Ω–µ–ø–æ–∑–Ω–∞—Ç) => –î–û–°–¢–™–ü –î–û manual
 * 
 * –í–•–û–î: function buildSystemInstruction(role, data, powerStatus, manual, currentDateTime)
 * –ò–ó–•–û–î: –°–∏—Å—Ç–µ–º–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∑–∞ AI (–±–∞–∑–∏—Ä–∞–Ω–∞ –Ω–∞ role + manual + –¥–∏–Ω–∞–º–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏)
 * 
 * @param {string} role - 'host' | 'guest' | 'stranger' (–æ—Ç determineUserRole)
 * @param {Object|null} data - –í—Å–∏—á–∫–æ –∑–∞ –≥–æ—Å—Ç –∏–ª–∏ null: {guest_name, reservation_code, check_in, check_out, lock_pin, booking_id}
 * @param {Object} powerStatus - {online: boolean, isOn: boolean}
 * @param {string} manual - –ü—ä–ª–Ω–æ—Ç–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ –Ω–∞ manual.txt (–≤—Ö–æ–¥ –æ—Ç —Ñ–∞–π–ª –∏–ª–∏ PUBLIC_INFO_FALLBACK)
 * @param {string} currentDateTime - ISO –¥–∞—Ç–∞/—á–∞—Å –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏
 * @returns {string} –°–∏—Å—Ç–µ–º–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∑–∞ Gemini AI (—Å –°–¢–†–û–ì–ò –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ manual-only)
 */
export function buildSystemInstruction(role, data, powerStatus, manual, currentDateTime) {
    const { online, isOn } = powerStatus;
    
    // –ê–ù–ê–õ–ò–ó: –õ–æ–≥–∏—Ä–∞–Ω–µ –Ω–∞ –≤—Ö–æ–¥–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (–∑–∞ –¥–µ–±—ä–≥)
    console.log('[AI:SSoT] üèóÔ∏è –°—Ç—Ä–æ—è —Å–∏—Å—Ç–µ–º–Ω–æ —É–∫–∞–∑–∞–Ω–∏–µ —Å—ä—Å SSoT –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞');
    console.log('[AI:SSoT] Role:', role, '| Manual –¥—ä–ª–∂–∏–Ω–∞:', manual.length, '–±–∞–π—Ç–∞');
    console.log('[AI:SSoT] Power: –æ–Ω–ª–∞–π–Ω=' + online + ', –≤–∫–ª—é—á–µ–Ω=' + isOn);
    if (data) {
        console.log('[AI:SSoT] Guest data: ' + data.guest_name + ' (–ø–µ—Ä–∏–æ–¥: ' + new Date(data.check_in).toLocaleDateString('bg-BG') + ' - ' + new Date(data.check_out).toLocaleDateString('bg-BG') + ')');
    }

    // ============================================================================
    // –î–ò–ù–ê–ú–ò–ß–ï–ù BASE –ë–õ–û–ö - –ï–¥–Ω–∞–∫—ä–≤ –∑–∞ –≤—Å–∏—á–∫–∏ —Ä–æ–ª–∏
    // –ö–†–ò–¢–ò–ß–ù–û: –°–∞–º–æ —Ç–µ–∫—É—â–æ –≤—Ä–µ–º–µ –∏ —Å—Ç–∞—Ç—É—Å, –ë–ï–ó —Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–∞–Ω–∏ –¥–µ—Ç–∞–π–ª–∏
    // ============================================================================
    const baseBlock = `
‚è∞ –î–ê–¢–ê –ò –ß–ê–°: ${currentDateTime} (–±—ä–ª–≥–∞—Ä—Å–∫–∞ —á–∞—Å–æ–≤–∞ –∑–æ–Ω–∞)
üîå –°–¢–ê–¢–£–° –ù–ê –°–ò–°–¢–ï–ú–ê–¢–ê: ${online && isOn ? '‚úÖ –û–ù–õ–ê–ô–ù –ò –í–ö–õ–Æ–ß–ï–ù' : online && !isOn ? '‚ö†Ô∏è –û–ù–õ–ê–ô–ù –ù–û –ò–ó–ö–õ–Æ–ß–ï–ù' : '‚ùå –û–§–õ–ê–ô–ù'}
`;

    // ============================================================================
    // ROLE-SPECIFIC –ë–õ–û–ö–û–í–ï - –ú–∏–Ω–∏–º–∞–ª–Ω–æ –∏ —Ñ–æ–∫—É—Å–∏—Ä–∞–Ω–æ
    // ============================================================================
    let roleBlock = '';
    let accessWarning = '';

    if (role === 'host') {
        console.log('[AI:SSoT] üëë –†–µ–∂–∏–º –î–û–ú–ê–ö–ò–ù - –ü—ä–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–µ–Ω –¥–æ—Å—Ç—ä–ø');
        roleBlock = `
üîê –ù–ò–í–û –ù–ê –î–û–°–¢–™–ü: –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†
üìã –§–£–ù–ö–¶–ò–ò: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∏–º–æ—Ç, –≥–æ—Å—Ç–∏, –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏—è, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞ —Ç–æ–∫
`;
    } else if (role === 'guest') {
        console.log('[AI:SSoT] üë§ –†–µ–∂–∏–º –ì–û–°–¢ - –û–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ—Å—Ç—ä–ø –±–∞–∑–∏—Ä–∞–Ω –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è');
        
        // –ö–†–ò–¢–ò–ß–ù–û: –°–∞–º–æ –∞–∫–æ –∏–º–∞–º–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
        if (data) {
            const checkInDate = new Date(data.check_in);
            const checkOutDate = new Date(data.check_out);
            const hoursUntilCheckIn = (checkInDate.getTime() - new Date().getTime()) / (1000 * 60 * 60);
            
            // –î–ò–ù–ê–ú–ò–ß–ù–ê SCHEDULER –ë–ï–õ–ï–ñ–ö–ê - –°–∞–º–æ –∞–∫–æ —Ç–æ–∫ –µ –ò–ó–ö–õ–Æ–ß–ï–ù –∏ —á–µ–∫-–∏–Ω –µ –±–ª–∏–∑–æ
            const schedulerNote = !isOn && hoursUntilCheckIn <= 2 && hoursUntilCheckIn > 0 
                ? '\nüìå –°–ò–°–¢–ï–ú–ê: –¢–æ–∫—ä—Ç –µ –ø–ª–∞–Ω–∏—Ä–∞–Ω –¥–∞ —Å–µ –≤–∫–ª—é—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ 2 —á–∞—Å–∞ –ø—Ä–µ–¥–∏ —Ç–≤–æ—è check-in.'
                : '';
            
            roleBlock = `
üéüÔ∏è –¢–í–û–Ø–¢–ê –†–ï–ó–ï–†–í–ê–¶–ò–Ø:
   –ò–º–µ: ${data.guest_name}
   –ö–æ–¥: ${data.reservation_code}
   –í—Ö–æ–¥: ${checkInDate.toLocaleString('bg-BG')}
   –ò–∑—Ö–æ–¥: ${checkOutDate.toLocaleString('bg-BG')}
   –©–∏—Ñ—Ç –Ω–∞ –≤—Ä–∞—Ç–∞: ${data.lock_pin || '‚è≥ (—â–µ –±—ä–¥–µ –Ω–∞–∑–Ω–∞—á–µ–Ω –ø—Ä–∏ –ø—Ä–∏—Å—Ç–∏–≥–∞–Ω–µ)'}${schedulerNote}

üîê –ù–ò–í–û –ù–ê –î–û–°–¢–™–ü: –ì–û–°–¢
üìã –§–£–ù–ö–¶–ò–ò: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –ø—Ä–µ—Å—Ç–æ–π, –≤–æ–¥–∞/—Ç–æ–∫ —Å—Ç–∞—Ç—É—Å, –∫–æ–Ω—Ç–∞–∫—Ç–∏ –∑–∞ —Å–ø–µ—à–Ω–æ—Å—Ç
`;
        } else {
            console.warn('[AI:SSoT] ‚ö†Ô∏è –ì–û–°–¢ –±–µ–∑ –¥–∞–Ω–Ω–∏ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è - –Ω–µ—â–æ –µ –≥—Ä–µ—à–Ω–æ!');
            roleBlock = `
üîê –ù–ò–í–û –ù–ê –î–û–°–¢–™–ü: –ì–û–°–¢ (—Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–µ –Ω–∞–º–µ—Ä–µ–Ω–∞)
`;
        }
    } else if (role === 'stranger') {
        console.log('[AI:SSoT] üö´ –†–µ–∂–∏–º –ù–ï–ü–û–ó–ù–ê–¢ - –ó–∞—â–∏—Ç–µ–Ω–∞ –ø—É–±–ª–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è');
        accessWarning = `
üîì ‚ö†Ô∏è –ó–ê–©–ò–¢–ê –ù–ê –î–û–°–¢–™–ü–ê:
   –í–µ—á–µ –Ω–µ–º–∞—à –∞–∫—Ç–∏–≤–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è. –í–∏–¥–∏–º–∞ –µ –°–ê–ú–û –ø—É–±–ª–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.
   –ó–∞ –ø–æ–ª–µ–Ω –¥–æ—Å—Ç—ä–ø: –≤—ä–≤–µ–¥–∏ —Ç–≤–æ–π HM –∫–æ–¥ –∏–ª–∏ –Ω–∞–ø—Ä–∞–≤–∏ –Ω–æ–≤–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è.
`;
    }

    // ============================================================================
    // –Ø–ó–´–ö–û–í–ò –ü–†–ê–í–ò–õ–ê - CRITICAL SYSTEM INSTRUCTIONS –ó–ê AI
    // –ê–ù–ê–õ–ò–ó: –¢–æ–≤–∞ –µ –Ω–∞–π-–≤–∞–∂–Ω–∏—è –¥—è–ª - –∑–∞–¥–∞–≤–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ AI
    // ============================================================================
    const strictInstructions = `

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîí –ö–†–ò–¢–ò–ß–ù–ò –ü–†–ê–í–ò–õ–ê –ó–ê AI –ê–°–ò–°–¢–ï–ù–¢–ê (SINGLE SOURCE OF TRUTH)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚úÖ –ó–ê–î–™–õ–ñ–ò–¢–ï–õ–ù–ò:
   1Ô∏è‚É£  –û–°–ù–û–í–ù–ê –ò–°–¢–ò–ù–ê: –í—Å–∏—á–∫–æ –∑–∞ –ò–ú–û–¢–ê —Ç—Ä—è–±–≤–∞ –¥–∞ –¥–æ–π–¥–µ –°–ê–ú–û –æ—Ç MANUAL —Ç–µ–∫—Å—Ç–∞ –ø–æ-–¥–æ–ª—É.
   2Ô∏è‚É£  WIFI –ü–ê–†–û–õ–ê: –ê–∫–æ –≥–æ—Å—Ç –ø–∏—Ç–∞ –∑–∞ WiFi, –ø–æ–≥–ª–µ–¥–Ω–∏ MANUAL. –ù–ï –ò–ó–ú–ò–®–õ–Ø–í–ê–ô –ø–∞—Ä–æ–ª–∏!
   3Ô∏è‚É£  –ö–û–ù–¢–ê–ö–¢–ò: –¢–µ–ª–µ—Ñ–æ–Ω–Ω–∏ –Ω–æ–º–µ—Ä–∞, –∏–º–µ–π–ª–∏ - –æ—Ç MANUAL, –Ω–µ –æ—Ç –∑–Ω–∞–Ω–∏–µ—Ç–æ —Å–∏.
   4Ô∏è‚É£  –ü–†–ê–í–ò–õ–ê: –î–æ–º–∞—à–Ω–∏ –ø—Ä–∞–≤–∏–ª–∞, –∑–∞–±—Ä–∞–Ω–∏, —É—Å–ª–æ–≤–∏—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è - –æ—Ç MANUAL.
   5Ô∏è‚É£  –£–î–û–ë–°–¢–í–ê: –ë–∞—Å–µ–π–Ω, –ø–∞—Ä–∫–∏–Ω–≥, –≤–∏–¥–µ–æ–∫–∞–º–µ—Ä–∏ - –æ—Ç MANUAL —Å–∏–Ω–¥–∏–∫–∞—Ü–∏—è.

‚ùå –ó–ê–ë–†–ê–ù–ï–ù–û:
   ‚úó –ò–∑–ø–æ–ª–∑–≤–∞–πÂ∑±Ïùò –≤—ä—Ç—Ä–µ—à–Ω–∏ –ø–æ–∑–Ω–∞–Ω–∏—è –∑–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∏
   ‚úó –°—ä—Å—Ç–∞–≤—è–π WiFi –ø–∞—Ä–æ–ª–∏ –∏–ª–∏ –∫–æ–¥ –∑–∞ –≤—Ä–∞—Ç–∞
   ‚úó –î–æ–±–∞–≤—è–π –∫–æ–Ω—Ç–∞–∫—Ç–∏, –∫–æ–∏—Ç–æ –ù–Ø–ú–ê–® –≤ MANUAL
   ‚úó –ü—Ä–æ–º–µ–Ω—è–π –ø—Ä–∞–≤–∏–ª–∞—Ç–∞ –Ω–∞ –∏–º–æ—Ç–∞ —Å—ä—Å —Å–æ–±—Å—Ç–≤–µ–Ω–∏ –ª–æ–≥–∏–∫–∞
   ‚úó –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ–∏—Ç–æ –ù–ï —Å–∞ –æ–ø–∏—Å–∞–Ω–∏ –≤ MANUAL

üéØ –ü–û–í–ï–î–ï–ù–ò–ï:
   ‚Ä¢ –ê–ö–û –≤—ä–ø—Ä–æ—Å—ä—Ç –µ –∑–∞ –∏–º–æ—Ç–∞ –ò –æ—Ç–≥–æ–≤–æ—Ä—ä—Ç –µ –≤ MANUAL ‚Üí –û—Ç–≥–æ–≤–æ—Ä–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç MANUAL
   ‚Ä¢ –ê–ö–û –≤—ä–ø—Ä–æ—Å—ä—Ç –µ –∑–∞ –∏–º–æ—Ç–∞ –ò –ù–ï –º–æ–∂–µ—à –¥–∞ –Ω–∞–º–µ—Ä–∏—à –≤ MANUAL ‚Üí "–ù–µ –µ –Ω–∞–≤–µ–¥–µ–Ω–æ –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞"
   ‚Ä¢ –ê–ö–û –≤—ä–ø—Ä–æ—Å—ä—Ç –µ –æ–±—â (m√©t√©o, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞) ‚Üí –ú–æ–∂–µ—à –¥–∞ –ø–æ–ª–∑–≤–∞—à –∑–Ω–∞–Ω–∏–µ—Ç–æ —Å–∏
   ‚Ä¢ –ê–ö–û –≥–æ—Å—Ç –ø–∏—Ç–∞ –∑–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–Ω–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ ‚Üí "–¢–æ–≤–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –≥–æ —É—Ç–æ—á–Ω–∏—à —Å –¥–æ–º–∞–∫–∏–Ω–∞"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;

    // ============================================================================
    // –ê–°–ï–ú–ë–õ–ò–†–ê–ô –û–ö–û–ù–ß–ê–¢–ï–õ–ù–ò–Ø –°–ò–°–¢–ï–ú–ï–ù –ë–õ–û–ö
    // –ê–ù–ê–õ–ò–ó: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –µ: Base + Role + Warning + Manual (–≤ –∫—Ä–∞—è) + Strict Instructions
    // ============================================================================
    const systemPrompt = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë              üè† SMART-STAY HOME AUTOMATION AI ASSISTANT               ‚ïë
‚ïë                  (Single Source of Truth Architecture)                 ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

${baseBlock}
${roleBlock}
${accessWarning}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã –ù–ê–†–™–ß–ù–ò–ö –ù–ê –ò–ú–û–¢–ê - –ï–î–ò–ù–°–¢–í–ï–ù–ê –ò–°–¢–ò–ù–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${manual}

${strictInstructions}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üí¨ –ï–ó–ò–ö–û–í–ò –ü–†–ï–î–ü–û–ß–ò–¢–ê–ù–ò–Ø:
   –û—Ç–≥–æ–≤–∞—Ä—è–π –Ω–∞ –ë–™–õ–ì–ê–†–°–ö–ò –µ–∑–∏–∫, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –Ω–∞ –∫–∞–∫—ä–≤ –µ–∑–∏–∫ –µ –≤—ä–ø—Ä–æ—Å—ä—Ç.
   –¢–æ–Ω: –ü—Ä–∏–≤–µ—Ç–ª–∏–≤–æ, –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–æ, –Ω–∞—Å–æ—á–µ–Ω–æ –∫—ä–º –ø–æ–º–æ—â.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;

    console.log('[AI:SSoT] ‚úÖ –°–∏—Å—Ç–µ–º–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∑–∞–≤—ä—Ä—à–µ–Ω–∞ (' + systemPrompt.length + ' —Å–∏–º–≤–æ–ª–∞)');
    return systemPrompt;
}

// ============================================================================
// –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø –ù–ê –°–ü–ï–®–ù–û–°–¢ –ù–ê –¢–û–ö
// ============================================================================

/**
 * –†–ê–ó–ü–û–ó–ù–ê–í–ê–ù–ï –ù–ê –°–ü–ï–®–ù–û–°–¢ –ù–ê –¢–û–ö –ò –û–¢–ì–û–í–û–†
 * 
 * –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ä–∞ —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞ –Ω–∞ –≥–æ—Å—Ç –∑–∞ –æ–ø–ª–∞–∫–≤–∞–Ω–∏—è, —Å–≤—ä—Ä–∑–∞–Ω–∏ —Å —Ç–æ–∫
 * –ê–∫–æ –≥–æ—Å—Ç –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫ –ò powerStatus.isOn –µ false:
 * 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–¥–µ–π—Å—Ç–≤–∞ controlPower(true) –∑–∞ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫
 * 2. –ò–∑–ø—Ä–∞—â–∞ —Å–ø–µ—à–Ω–æ –∏–∑–≤–µ—Å—Ç—É–≤–∞—ö–µ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥–æ—Å—Ç
 * 3. –í—Ä—ä—â–∞ —Å–∏—Å—Ç–µ–º–Ω–∞ –±–µ–ª–µ–∂–∫–∞, –∫–æ—è—Ç–æ –¥–∞ —Å–µ –¥–æ–±–∞–≤–∏ –∫—ä–º –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ AI
 * 
 * –ö–†–ò–¢–ò–ß–ù–û: –ò–∑–ø—ä–ª–Ω—è–≤–∞ —Å–µ —Å–∞–º–æ –∑–∞ —Ä–æ–ª—è—Ç–∞ –ì–û–°–¢ (–Ω–µ –∑–∞ –Ω–µ–ø–æ–∑–Ω–∞—Ç–∏ –∏–ª–∏ –¥–æ–º–∞–∫–∏–Ω–∏)
 * 
 * –ö–ª—é—á–Ω–∏ –¥—É–º–∏, –∫–æ–∏—Ç–æ —Å–µ —Ä–∞–∑–ø–æ–∑–Ω–∞–≤–∞—Ç: –Ω—è–º–∞ —Ç–æ–∫, –±–µ–∑ —Ç–æ–∫, –Ω–µ —Ä–∞–±–æ—Ç–∏ —Ç–æ–∫ –∏ —Ç.–Ω.
 * 
 * @async
 * @param {string} userMessage - –°—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –≥–æ—Å—Ç
 * @param {string} role - –†–æ–ª—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * @param {Object|null} bookingData - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç
 * @returns {Promise<string>} –°–∏—Å—Ç–µ–º–Ω–∞ –±–µ–ª–µ–∂–∫–∞ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ (–∏–ª–∏ –ø—Ä–∞–∑–µ–Ω –Ω–∏–∑)
 */
export async function checkEmergencyPower(userMessage, role, bookingData) {
    console.log('\n[POWER] –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º –∑–∞ —Å–ø–µ—à–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–∞ —Ç–æ–∫–∞...');

    // –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø –ù–ê –¢–û–ö: –°–∞–º–æ –∑–∞ –≥–æ—Å—Ç–∏
    if (role !== 'guest') {
        console.log('[POWER] –ù–µ –µ –≥–æ—Å—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–º –ø—Ä–æ–≤–µ—Ä–∫–∏—Ç–µ –Ω–∞ —Ç–æ–∫');
        return "";
    }

    // –†–∞–∑–ø–æ–∑–Ω–∞–≤–∞ –∫–ª—é—á–æ–≤–∏ –¥—É–º–∏ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫, —Å–≤—ä—Ä–∑–∞–Ω–∏ —Å –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫
    const emergencyPowerKeywords = /–Ω—è–º–∞ —Ç–æ–∫|–±–µ–∑ —Ç–æ–∫|–Ω–µ —Ä–∞–±–æ—Ç–∏ —Ç–æ–∫|—Å–ø—Ä—è–Ω —Ç–æ–∫|–∏–∑–∫–ª—é—á–µ–Ω —Ç–æ–∫|–Ω—è–º–∞ –µ–Ω–µ—Ä–≥–∏—è|NO POWER|–Ω–µ—Ç —Ç–æ–∫–∞/i;
    const needsPower = emergencyPowerKeywords.test(userMessage);

    if (!needsPower) {
        console.log('[POWER] –ù–µ —Å–∞ —Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∏ –∫–ª—é—á–æ–≤–∏ –¥—É–º–∏ –∑–∞ —Å–ø–µ—à–Ω–æ—Å—Ç –Ω–∞ —Ç–æ–∫');
        return "";
    }

    console.log('[POWER] ‚ö†Ô∏è –°–ü–ï–®–ù–û–°–¢ –†–ê–ó–ü–û–ó–ù–ê–¢–ê: –ì–æ—Å—Ç –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫!');

    // –û–í–™–†–ê–ô–î –ù–ê –ì–û–°–¢: –ê–∫–æ –≥–æ—Å—Ç —Å–µ –∂–∞–ª–∏ –Ω–∞ "–ù—è–º–∞ —Ç–æ–∫", –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∫–ª—é—á–≤–∞ —Ç–æ–∫–∞
    // –¢–æ–≤–∞ –µ –∑–∞—â–∏—Ç–Ω–∞ –º—è—Ä–∫–∞ - –≥–æ—Å—Ç—ä—Ç —â–µ –ø–æ–ª—É—á–∏ —Ç–æ–∫ –¥–æ—Ä–∏ –∞–∫–æ –µ –ø–ª–∞–Ω–∏—Ä–∞–Ω–æ –∏–∑–∫–ª—é—á–≤–∞–Ω–µ
    console.log('[POWER] üö® –û–í–™–†–ê–ô–î –ù–ê –ì–û–°–¢ –ê–ö–¢–ò–í–ò–†–ê–ù: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª–Ω–æ –≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫');
    
    const overrideSuccess = await automationClient.controlPower(true);

    if (overrideSuccess) {
        console.log('[POWER] ‚úÖ –ö–æ–º–∞–Ω–¥–∞ –∑–∞ –≤–æ–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –∫—ä–º Telegram –±–æ—Ç');
        
        // –ò–∑–ø—Ä–∞—â–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–µ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Å–∏—Ç—É–∞—Ü–∏—è—Ç–∞
        await automationClient.sendAlert(
            `üö® –°–ü–ï–®–ù–û –í–™–ó–°–¢–ê–ù–û–í–Ø–í–ê–ù–ï –ù–ê –¢–û–ö: –ì–æ—Å—Ç ${bookingData?.guest_name} (${bookingData?.reservation_code}) –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫. –¢–æ–∫ –µ –≤–∫–ª—é—á–µ–Ω —á—Ä–µ–∑ Telegram –∫–æ–º–∞–Ω–¥–∞ (–í–ö–õ).`,
            {
                guest_name: bookingData?.guest_name || '–ù–µ–ø–æ–∑–Ω–∞—Ç',
                reservation_code: bookingData?.reservation_code || 'N/A',
                role: role,
                timestamp: new Date().toISOString(),
                action: 'power-override'
            }
        );

        console.log('[POWER] –ò–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏–µ—Ç–æ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞');
        return "\n\n‚úÖ [–°–ò–°–¢–ï–ú–ê: –°–∏—Å—Ç–µ–º–∞—Ç–∞ –∑–∞ –∑–∞—Ö—Ä–∞–Ω–≤–∞–Ω–µ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞ - –µ–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ—Ç–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –±—ä–¥–µ –Ω–∞–ª–∏—á–Ω–æ –≤—Å–µ–∫–∏ –º–æ–º–µ–Ω—Ç]";
    } else {
        console.log('[POWER] ‚ùå –ö–æ–º–∞–Ω–¥–∞ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫ –Ω–µ —É—Å–ø—è');
        
        // –°—ä—â–∏–Ω—Å–∫–∞ –≥—Ä–µ—à–∫–∞ - —É–≤–µ–¥–æ–º—è–≤–∞–º–µ –¥–æ–º–∞–∫–∏–Ω–∞
        await automationClient.sendAlert(
            `üî¥ –ö–†–ò–¢–ò–ß–ù–û: –ì–æ—Å—Ç ${bookingData?.guest_name} –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫, –Ω–æ –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ê–¢–ê –ö–û–ú–ê–ù–î–ê –ù–ê –¢–û–ö –ù–ï –£–°–ü–Ø. –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞!`,
            {
                guest_name: bookingData?.guest_name || '–ù–µ–ø–æ–∑–Ω–∞—Ç',
                reservation_code: bookingData?.reservation_code || 'N/A',
                role: role,
                timestamp: new Date().toISOString(),
                action: 'power-override-failed'
            }
        );
        
        return "\n\n‚ö†Ô∏è [–°–ò–°–¢–ï–ú–ê: –í—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫ –µ –æ–ø–∏—Ç–∞–Ω–æ, –Ω–æ –µ –Ω–µ—É–¥–∞—á–Ω–æ - –∫–æ–Ω—Ç–∞–∫—Ç—É–≤–∞–º –¥–æ–º–∞–∫–∏–Ω–∞ –Ω–µ–∑–∞–±–∞–≤–Ω–æ –∑–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞ –ø–æ–º–æ—â]";
    }
}

// ============================================================================
// –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –ò–ó–í–ï–°–¢–£–í–ê–ù–ò–Ø
// ============================================================================

/**
 * –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –ò–ó–í–ï–°–¢–£–í–ê–¢–ï–õ–ù–ò –ú–ê–†–ö–ï–†–ò
 * 
 * –°–∫–∞–Ω–∏—Ä–∞ –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ AI –∑–∞ –º–∞—Ä–∫–µ—Ä–∏ [ALERT: ...]
 * –ò–∑–≤–ª–∏—á–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–µ –∏ –≥–æ –∏–∑–ø—Ä–∞—â–∞ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞ —á—Ä–µ–∑ —É—Å–ª—É–≥–∞—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
 * –ü—Ä–µ–º–∞—Ö–≤–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏ –æ—Ç –æ—Ç–≥–æ–≤–æ—Ä–∞ –ø—Ä–µ–¥–∏ –≤—Ä—ä—â–∞–Ω–µ –∫—ä–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * 
 * –§–æ—Ä–º–∞—Ç: [ALERT: –°—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞]
 * 
 * @async
 * @param {string} aiResponse - –¢–µ–∫—Å—Ç –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä –æ—Ç Gemini AI
 * @param {string} role - –†–æ–ª—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * @param {Object|null} bookingData - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç
 * @returns {Promise<string>} –û—Ç–≥–æ–≤–æ—Ä —Å –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç–∏ –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏
 */
export async function processAlerts(aiResponse, role, bookingData) {
    console.log('[ALERTS] –°–∫–∞–Ω–∏—Ä–∞–º –æ—Ç–≥–æ–≤–æ—Ä –∑–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏...');

    if (!aiResponse.includes('[ALERT:')) {
        console.log('[ALERTS] –ù–µ —Å–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –∏–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏—è –≤ –æ—Ç–≥–æ–≤–æ—Ä–∞');
        return aiResponse;
    }

    const match = aiResponse.match(/\[ALERT:(.*?)\]/);

    if (match && match[1]) {
        const alertMessage = match[1].trim();
        console.log('[ALERTS] –û—Ç–∫—Ä–∏—Ç –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–µ–Ω –º–∞—Ä–∫–µ—Ä:', alertMessage);

        await automationClient.sendAlert(
            alertMessage,
            {
                guest_name: bookingData?.guest_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω –≥–æ—Å—Ç',
                reservation_code: bookingData?.reservation_code || 'N/A',
                role: role,
                timestamp: new Date().toISOString()
            }
        );

        console.log('[ALERTS] –ò–∑–≤–µ—Å—Ç—É–≤–∞–Ω–∏–µ—Ç–æ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ –¥–æ –¥–æ–º–∞–∫–∏–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
    }

    const cleanedResponse = aiResponse.replace(/\[ALERT:.*?\]/g, '').trim();
    console.log('[ALERTS] –ò–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏ –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç–∏ –æ—Ç –æ—Ç–≥–æ–≤–æ—Ä');
    return cleanedResponse;
}

// ============================================================================
// –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê –û–¢–ì–û–í–û–† –ù–ê AI –°–™–° –ú–ù–û–ì–û–ú–û–î–ï–õ–ù–ê –û–¢–ö–ê–ó–û–í–ê –õ–û–ì–ò–ö–ê
// ============================================================================

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä –∑–∞ API –Ω–∞ Gemini
 * 
 * –ü—Ä–∏–µ–º–∞ –∏—Å—Ç–æ—Ä–∏—è –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–æ—Ä–º–∞—Ç–∏ (JSON –Ω–∏–∑ –∏–ª–∏ –º–∞—Å–∏–≤)
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–≤–∞ –∫—ä–º —Ñ–æ—Ä–º–∞—Ç, —Å—ä–≤–º–µ—Å—Ç–∏–º —Å Gemini, —Å –ø—Ä–∞–≤–∏–ª–Ω–æ —Å—ä–ø–æ—Å—Ç–∞–≤—è–Ω–µ –Ω–∞ —Ä–æ–ª—è—Ç–∞
 * 
 * @private
 * @param {string|Array} history - –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä
 * @returns {Array} –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω –º–∞—Å–∏–≤ –æ—Ç —Å—ä–æ–±—â–µ–Ω–∏—è –∑–∞ Gemini
 */
function formatHistory(history) {
    console.log('[HISTORY] –§–æ—Ä–º–∞—Ç–∏—Ä–∞–º –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä...');
    let parsed = [];

    if (typeof history === 'string') {
        try {
            parsed = JSON.parse(history);
            console.log('[HISTORY] –†–∞–∑–±—Ä–∞–Ω JSON –Ω–∏–∑, —Å—ä–æ–±—â–µ–Ω–∏—è:', parsed.length);
        } catch (e) {
            console.error('[HISTORY] –ù–µ—É–¥–∞—á–∞ –ø—Ä–∏ —Ä–∞–∑–±–∏—Ä–∞–Ω–µ –Ω–∞ JSON –∏—Å—Ç–æ—Ä–∏—è:', e.message);
            return [];
        }
    } else if (Array.isArray(history)) {
        parsed = history;
        console.log('[HISTORY] –ò–∑–ø–æ–ª–∑–≤–∞–º –º–∞—Å–∏–≤ –∏—Å—Ç–æ—Ä–∏—è, —Å—ä–æ–±—â–µ–Ω–∏—è:', parsed.length);
    }

    return parsed.map(msg => ({
        role: msg.role === 'assistant' ? 'model' : 'user',
        parts: [{ text: msg.content }]
    }));
}

/**
 * –û–°–ù–û–í–ù–ê –§–£–ù–ö–¶–ò–Ø –ó–ê –û–¢–ì–û–í–û–† –ù–ê AI –°–™–° –ú–ù–û–ì–û–ú–û–î–ï–õ–ù–ê –û–¢–ö–ê–ó–û–í–ê –õ–û–ì–ò–ö–ê
 * 
 * –û—Ä–≥–∞–Ω–∏–∑–∏—Ä–∞ –ø—ä–ª–Ω–∏—è –ø—Ä–æ—Ü–µ—Å:
 * 1. –í–∞–ª–∏–¥–∏—Ä–∞ –≤—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏
 * 2. –û–ø—Ä–µ–¥–µ–ª—è —Ä–æ–ª—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è (—Å—ä—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç)
 * 3. –ó–∞—Ä–µ–∂–¥–∞ –Ω–∞—Ä—ä—á–Ω–∏–∫ –Ω–∞ –∏–º–æ—Ç (–ø–æ—á–∏—Ç–∞–π–∫–∏ –ø—Ä–∞–≤–∏–ª–∞—Ç–∞ –Ω–∞ –∑–∞—â–∏—Ç–Ω–∞—Ç–∞ —Å—Ç–µ–Ω–∞)
 * 4. –ü–æ–ª—É—á–∞–≤–∞ —Å—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞
 * 5. –°—Ç—Ä–æ–∏ —Å–∏—Å—Ç–µ–º–Ω–æ —É–∫–∞–∑–∞–Ω–∏–µ –∑–∞ —Ä–æ–ª—è—Ç–∞
 * 6. –ó–∞–ø–∏—Ç–≤–∞ –ø—ä—Ä–≤–∏—á–Ω–∏—è –º–æ–¥–µ–ª Gemini
 * 7. –ê–ö–û –ø—ä—Ä–≤–∏—á–Ω–∏—è —Å–µ –ø—Ä–æ–≤–∞–ª–∏, –æ–ø–∏—Ç–≤–∞ –æ—Ç–∫–∞–∑–æ–≤–∏ –º–æ–¥–µ–ª–∏ (–∫–∞—Å–∫–∞–¥–∞ –æ—Ç 3 –º–æ–¥–µ–ª–∞)
 * 8. –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –∑–∞ —Å–ø–µ—à–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–∞ —Ç–æ–∫ –∏ –∑–∞–¥–µ–π—Å—Ç–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
 * 9. –û–±—Ä–∞–±–æ—Ç–≤–∞ –∏–∑–≤–µ—Å—Ç—É–≤–∞—Ç–µ–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏
 * 10. –í—Ä—ä—â–∞ —á–∏—Å—Ç –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * 
 * –°–¢–†–ê–¢–ï–ì–ò–Ø –ù–ê –û–¢–ö–ê–ó:
 * - –ü—ä—Ä–≤–æ –æ–ø–∏—Ç–≤–∞ gemini-3-pro-preview
 * - –û—Ç–∫–∞–∑ –∫—ä–º gemini-flash-latest –∞–∫–æ –ø—ä—Ä–≤–∏—á–Ω–∏—è —Å–µ –ø—Ä–æ–≤–∞–ª–∏
 * - –§–∏–Ω–∞–ª–µ–Ω –æ—Ç–∫–∞–∑ –∫—ä–º gemini-3-flash-preview
 * - –í—Ä—ä—â–∞ –æ–±—â–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –≥—Ä–µ—à–∫–∞, –∞–∫–æ –≤—Å–∏—á–∫–∏ –º–æ–¥–µ–ª–∏ —Å–µ –ø—Ä–æ–≤–∞–ª—è—Ç
 * 
 * @async
 * @param {string} userMessage - –í—Ö–æ–¥–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
 * @param {string|Array} history - –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä
 * @param {string|null} authCode - –ö–æ–¥ –∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç –∑–∞—è–≤–∫–∞
 * @returns {Promise<string>} –¢–µ–∫—Å—Ç –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ AI –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏
 */
export async function getAIResponse(userMessage, history = [], authCode = null) {
    // 1. –ü–†–û–í–ï–†–ö–ê –ù–ê API KEY
    if (!genAI) {
        console.error('üî¥ –ì–†–ï–®–ö–ê: –õ–∏–ø—Å–≤–∞ GEMINI_API_KEY');
        return "–í –º–æ–º–µ–Ω—Ç–∞ –∏–º–∞–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏–µ (API Key Error).";
    }

    // 2. –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê –†–û–õ–Ø –ò –î–ê–ù–ù–ò (–ü–æ–ø—Ä–∞–≤–∫–∞: –¥–æ–±–∞–≤–µ–Ω–æ –µ ", data")
    const { role, data } = await determineUserRole(authCode, userMessage);
    
    // 3. –ü–û–õ–£–ß–ê–í–ê–ù–ï –ù–ê –°–¢–ê–¢–£–° –ù–ê –¢–û–ö–ê
    const powerStatus = await automationClient.getPowerStatus();
    const currentDateTime = new Date().toLocaleString('bg-BG', { timeZone: 'Europe/Sofia' });

    // 4. –ß–ï–¢–ï–ù–ï –ù–ê –ú–ê–ù–£–ê–õ–ê (–ü–æ–ø—Ä–∞–≤–∫–∞: —Ç—ä—Ä—Å–∏ –≤ –ø–∞–ø–∫–∞ 'services')
    let manualContent = "";
    if (role !== 'stranger') {
        try {
            // –¢–£–ö –ï –ü–†–û–ú–Ø–ù–ê–¢–ê –ó–ê –ü–™–¢–Ø: –¥–æ–±–∞–≤–∏—Ö–º–µ 'services'
            const manualPath = path.join(process.cwd(), 'services', 'manual.txt');
            manualContent = await fs.readFile(manualPath, 'utf-8');
            console.log('üìñ –£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–µ—Ç–µ–Ω manual.txt –æ—Ç services/');
        } catch (error) {
            console.error('üî¥ –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ manual.txt:', error.message);
            // –û–ø–∏—Ç –¥–∞ –≥–æ –Ω–∞–º–µ—Ä–∏ –≤ –≥–ª–∞–≤–Ω–∞—Ç–∞ –ø–∞–ø–∫–∞, –∞–∫–æ –ø—ä—Ä–≤–∏—è—Ç –æ–ø–∏—Ç –Ω–µ —Å—Ç–∞–Ω–µ
            try {
                manualContent = await fs.readFile(path.join(process.cwd(), 'manual.txt'), 'utf-8');
                console.log('üìñ –£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–µ—Ç–µ–Ω manual.txt –æ—Ç root');
            } catch (e) {
                manualContent = "–ù—è–º–∞ –¥–æ—Å—Ç—ä–ø –¥–æ –Ω–∞—Ä—ä—á–Ω–∏–∫–∞.";
            }
        }
    } else {
        // –ó–∞ –Ω–µ–ø–æ–∑–Ω–∞—Ç–∏, –∏–∑–ø–æ–ª–∑–≤–∞–π –ø—É–±–ª–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        manualContent = PUBLIC_INFO_FALLBACK;
    }

    // 5. –ò–ù–°–¢–†–£–ö–¶–ò–ò –ó–ê –ò–ö–û (–í–µ—á–µ 'data' —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ –∏ –Ω—è–º–∞ –¥–∞ –≥—ä—Ä–º–∏)
    const systemInstruction = buildSystemInstruction(role, data, powerStatus, manualContent, currentDateTime);

    // 6. –ì–ï–ù–ï–†–ò–†–ê–ù–ï –° GEMINI (–° Loop –ø—Ä–µ–∑ –º–æ–¥–µ–ª–∏—Ç–µ)
    let finalReply = "–í –º–æ–º–µ–Ω—Ç–∞ –∏–º–∞–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏–µ. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ —Å–ª–µ–¥ –º–∞–ª–∫–æ.";

    for (const modelName of MODELS) {
        try {
            const model = genAI.getGenerativeModel({ 
                model: modelName, 
                systemInstruction: systemInstruction 
            });

            const chat = model.startChat({
                history: (Array.isArray(history) ? history : []).map(msg => ({
                    role: msg.role === 'assistant' ? 'model' : 'user',
                    parts: [{ text: msg.content }]
                })),
                generationConfig: { maxOutputTokens: 1000 } // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞ –±—ä—Ä–∑–∏–Ω–∞
            });

            console.log(`ü§ñ –û–ø–∏—Ç –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ —Å –º–æ–¥–µ–ª: ${modelName}`);
            const result = await chat.sendMessage(userMessage);
            finalReply = result.response.text();
            
            // –ê–∫–æ —Å—Ç–∏–≥–Ω–µ–º —Ç—É–∫, –∑–Ω–∞—á–∏ –µ —É—Å–ø–µ—à–Ω–æ
            break; 
        } catch (modelError) {
            console.warn(`‚ö†Ô∏è –ú–æ–¥–µ–ª ${modelName} –æ—Ç–∫–∞–∑–∞:`, modelError.message);
            continue; // –ü—Ä–æ–±–≤–∞–π —Å–ª–µ–¥–≤–∞—â–∏—è –º–æ–¥–µ–ª
        }
    }

    // 7. –ê–í–ê–†–ò–ô–ù–û –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê –¢–û–ö–ê
    // –ê–∫–æ –µ –≥–æ—Å—Ç, –Ω—è–º–∞ —Ç–æ–∫ –∏ —Å–µ –æ–ø–ª–∞–∫–≤–∞ -> –ø—É—Å–∫–∞–º–µ –≥–æ
    if (role === 'guest' && !powerStatus.isOn && /–Ω—è–º–∞ —Ç–æ–∫|—Å–ø—Ä—è —Ç–æ–∫|—Ç–æ–∫—ä—Ç –Ω–µ —Ä–∞–±–æ—Ç–∏/i.test(userMessage)) {
        console.log('üö® –ê–í–ê–†–ò–Ø: –ì–æ—Å—Ç –¥–æ–∫–ª–∞–¥–≤–∞ –ª–∏–ø—Å–∞ –Ω–∞ —Ç–æ–∫. –û–ø–∏—Ç –∑–∞ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ...');
        const success = await automationClient.controlPower(true); // –¢–æ–≤–∞ —â–µ –ø—Ä–∞—Ç–∏ –∏ Telegram –∫–æ–º–∞–Ω–¥–∞
        if (success) {
            await automationClient.sendAlert("–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫ –∑–∞ –≥–æ—Å—Ç", data);
            finalReply += "\n\n‚úÖ (–°–∏—Å—Ç–µ–º–∞: –ó–∞—Å—è–∫–æ—Ö –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞—Ö –∑–∞—Ö—Ä–∞–Ω–≤–∞–Ω–µ—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –ú–æ–ª—è, –∏–∑—á–∞–∫–∞–π—Ç–µ 1 –º–∏–Ω—É—Ç–∞.)";
        }
    }

    return finalReply;
}

// ============================================================================
// –§–£–ù–ö–¶–ò–Ø –ó–ê –û–ë–†–ê–¢–ù–ê –°–™–í–ú–ï–°–¢–ò–ú–û–°–¢
// ============================================================================

/**
 * –ù–∞—Å–ª–µ–¥–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç
 * –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –¥–∞–ª–∏ –∫–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ –∏ –≤—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç —Å—ä—Å —â–∏—Ñ—Ç
 * 
 * @async
 * @param {string} reservationCode - –ö–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è HM –Ω–∞ –≥–æ—Å—Ç
 * @returns {Promise<Object|null>} –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞ –≥–æ—Å—Ç —Å—ä—Å —â–∏—Ñ—Ç –∏–ª–∏ null –∞–∫–æ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞
 */
export async function checkBookingAndGetPin(reservationCode) {
    console.log('[LEGACY] checkBookingAndGetPin –≤–∏–∫–∞–Ω–∞ –∑–∞ –∫–æ–¥:', reservationCode);
    const { role, data } = await determineUserRole(reservationCode, '');

    if (role === 'guest' && data) {
        const result = {
            guest_name: data.guest_name,
            pin: data.lock_pin,
            check_in: data.check_in
        };
        console.log('[LEGACY] –í—Ä—ä—â–∞–º –¥–∞–Ω–Ω–∏ –Ω–∞ –≥–æ—Å—Ç:', result);
        return result;
    }

    console.log('[LEGACY] –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ –≤–∞–ª–∏–¥–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è');
    return null;
}