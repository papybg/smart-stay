<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Stay - –ö–æ–º–∞–Ω–¥–µ–Ω –¶–µ–Ω—Ç—ä—Ä</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* --- –û–°–ù–û–í–ù–ò –ù–ê–°–¢–†–û–ô–ö–ò --- */
        :root { 
            --primary: #0084ff; 
            --neon-cyan: hsl(190, 80%, 55%);
            --bg-light: #f4f6f8; 
            --bg-dark: #111827;
        }
        
        body { font-family: -apple-system, 'Inter', sans-serif; margin: 0; padding: 0; background: var(--bg-light); height: 100vh; display: flex; flex-direction: column; }
        
        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø (HEADER) --- */
        header { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .logo { font-weight: 800; font-size: 20px; color: #333; }
        
        .nav-tabs { display: flex; gap: 10px; }
        .nav-btn { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 15px; font-weight: 600; color: #666; border-radius: 8px; transition: 0.2s; }
        .nav-btn.active { background: var(--primary); color: white; }
        .nav-btn:hover:not(.active) { background: #eee; }

        /* --- –ù–û–í –ë–£–¢–û–ù –ó–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø --- */
        .sync-btn { 
            background: #6f42c1; color: white; border: none; padding: 8px 16px; 
            border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; 
            display: flex; align-items: center; gap: 6px; transition: background 0.2s; 
        }
        .sync-btn:hover { background: #59359a; }
        .sync-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* --- –ö–û–ù–¢–ï–ô–ù–ï–† --- */
        .main-wrapper { flex: 1; overflow-y: auto; position: relative; }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: block; }

        /* =========================================
           –¢–ê–ë 1: –†–ï–ó–ï–†–í–ê–¶–ò–ò (ADMIN STYLE)
           ========================================= */
        #bookings { padding: 20px; max-width: 1000px; margin: 0 auto; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { font-weight: 600; font-size: 13px; color: #555; display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        
        button.action-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        button.action-btn:hover { background: #006bcf; }

        /* –¢–∞–±–ª–∏—Ü–∞ */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; color: #666; font-size: 14px; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }
        
        .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-bottom: 4px; }
        .badge-res { background: #e1f0ff; color: #0084ff; }
        .badge-on { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .badge-off { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .delete-btn { color: red; background: none; border: none; cursor: pointer; font-weight: bold; font-size: 16px; }

        /* –õ–∏–Ω–∫ –∑–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä */
        .ics-link-container { text-align: right; margin-top: 10px; }
        .ics-link { color: var(--primary); text-decoration: none; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; }
        .ics-link:hover { text-decoration: underline; }

        /* =========================================
           –¢–ê–ë 2: –£–°–¢–†–û–ô–°–¢–í–ê (REMOTE NEON STYLE)
           ========================================= */
        #remote { 
            background-color: var(--bg-dark); 
            color: white; 
            display: none; 
            height: 100%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            flex-direction: column;
        }
        #remote.active { display: flex !important; }

        .neon-container { position: relative; display: flex; flex-direction: column; align-items: center; }
        
        .glow-effect {
            position: absolute; width: 16rem; height: 16rem;
            background: var(--neon-cyan); opacity: 0;
            border-radius: 50%; filter: blur(40px);
            transition: opacity 1s ease-in-out;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 0;
        }

        .main-btn {
            position: relative; z-index: 10;
            width: 12rem; height: 12rem;
            border-radius: 50%;
            background: rgba(31, 41, 55, 0.4);
            backdrop-filter: blur(4px);
            border: 8px solid #374151;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; outline: none; transition: all 0.3s ease;
        }
        
        .main-btn span { font-size: 80px !important; color: #4b5563; transition: color 0.3s; }

        /* –°–™–°–¢–û–Ø–ù–ò–ï: –í–ö–õ–Æ–ß–ï–ù–û (ON) */
        .system-on .glow-effect { opacity: 0.4; animation: pulse-glow 4s infinite ease-in-out; }
        .system-on .main-btn {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 12px var(--neon-cyan), 0 0 25px var(--neon-cyan);
        }
        .system-on .main-btn span { color: var(--neon-cyan); }
        .system-on #status-text { color: white; text-shadow: 0 0 10px rgba(255,255,255,0.5); }

        /* –°–™–°–¢–û–Ø–ù–ò–ï: –ì–†–ï–®–ö–ê */
        .system-error .main-btn { border-color: #ef4444; }
        .system-error .main-btn span { color: #ef4444; }
        .system-error #status-text { color: #ef4444; }

        @keyframes pulse-glow { 50% { transform: translate(-50%, -50%) scale(1.1); } }

        .remote-text { text-align: center; margin-top: 2rem; position: relative; z-index: 10; }
        .remote-text h2 { font-size: 1.25rem; font-weight: bold; letter-spacing: 0.05em; margin: 0; }
        .remote-text p { color: #9ca3af; font-size: 0.875rem; margin-top: 0.5rem; }

        /* –ú–æ–±–∏–ª–Ω–∏ –∫–æ—Ä–µ–∫—Ü–∏–∏ */
        @media (max-width: 600px) {
            header { flex-wrap: wrap; gap: 10px; justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            td, th { display: block; width: 100%; }
            tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">üè† Smart Stay Admin</div>
        
        <button class="sync-btn" onclick="manualSync()" id="syncBtn">
            üïµÔ∏è –ü—Ä–æ–≤–µ—Ä–∏ –ø–æ—â–∞
        </button>

        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('bookings', this)">üìÖ –†–µ–∑–µ—Ä–≤–∞—Ü–∏–∏</button>
            <button class="nav-btn" onclick="switchTab('remote', this)">‚ö° –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
        </div>
    </header>

    <div class="main-wrapper">
        
        <div id="bookings" class="tab-content active">
            <div class="card">
                <h3>–ù–æ–≤–∞ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è</h3>
                <div class="form-grid">
                    <div>
                        <label>–ò–º–µ –Ω–∞ –≥–æ—Å—Ç–∞</label>
                        <input type="text" id="guestName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                    </div>
                    <div>
                        <label>–ö–æ–¥ (HM...)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="resCode">
                            <button onclick="generateCode()" class="action-btn" style="width:50px; margin:0;">üé≤</button>
                        </div>
                    </div>
                    <div>
                        <label>–ù–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ (Check-in)</label>
                        <input type="datetime-local" id="checkIn">
                        <small style="color:#155724">‚ö° –¢–æ–∫—ä—Ç —Ç—Ä—ä–≥–≤–∞ 2 —á–∞—Å–∞ –ø–æ-—Ä–∞–Ω–æ</small>
                    </div>
                    <div>
                        <label>–ù–∞–ø—É—Å–∫–∞–Ω–µ (Check-out)</label>
                        <input type="datetime-local" id="checkOut">
                        <small style="color:#721c24">üåë –¢–æ–∫—ä—Ç —Å–ø–∏—Ä–∞ 1 —á–∞—Å –ø–æ-–∫—ä—Å–Ω–æ</small>
                    </div>
                </div>
                <div id="errorMsg" style="color:red; margin-top:10px; display:none;">‚ö†Ô∏è –ì—Ä–µ—à–∫–∞: –ó–∞—Å–∏—á–∞–Ω–µ –Ω–∞ –¥–∞—Ç–∏!</div>
                <button class="action-btn" onclick="addBooking()">‚ûï –î–æ–±–∞–≤–∏ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è</button>
            </div>

            <div class="card">
                <h3>–ì—Ä–∞—Ñ–∏–∫ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏—Ç–µ</h3>
                <table>
                    <thead>
                        <tr>
                            <th>–ì–æ—Å—Ç / –ö–æ–¥</th>
                            <th>‚ö° –í–ö–õ–Æ–ß–í–ê–ù–ï</th>
                            <th>üåë –ò–ó–ö–õ–Æ–ß–í–ê–ù–ï</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="bookingList"></tbody>
                </table>
                
                <div class="ics-link-container">
                    <a href="/feed.ics" class="ics-link" target="_blank">
                        üìÖ –°–≤–∞–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä –∑–∞ Airbnb (feed.ics)
                    </a>
                </div>
            </div>
        </div>

        <div id="remote" class="tab-content">
            <div class="neon-container" id="remote-container">
                <div class="glow-effect"></div>
                <button onclick="togglePower()" class="main-btn" id="main-btn">
                    <span class="material-symbols-outlined">power_settings_new</span>
                </button>
                <div class="remote-text">
                    <h2 id="status-text">CONNECTING...</h2>
                    <p>–†—ä—á–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∑–∞—Ö—Ä–∞–Ω–≤–∞–Ω–µ—Ç–æ</p>
                </div>
            </div>
        </div>

    </div>

<script>
    // --- UI NAVIGATION ---
    function switchTab(tabId, btnElement) {
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.remove('active');
            if(el.id === 'remote') el.style.display = ''; 
        });
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        const selectedTab = document.getElementById(tabId);
        selectedTab.classList.add('active');
        btnElement.classList.add('active');
        
        if(tabId === 'remote') checkPowerStatus();
    }

    // --- –ù–û–í–ê –§–£–ù–ö–¶–ò–Ø –ó–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ---
    async function manualSync() {
        const btn = document.getElementById('syncBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚è≥ ...';
        btn.disabled = true;

        try {
            const res = await fetch('/sync');
            const msg = await res.text();
            alert(msg); 
            loadBookings(); 
        } catch (err) {
            alert('‚ùå –ì—Ä–µ—à–∫–∞: ' + err.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // --- BOOKING LOGIC ---
    let currentBookings = [];
    
    function formatBG(dateStr) {
        if (!dateStr) return '---';
        return new Date(dateStr).toLocaleString('bg-BG', { 
            timeZone: 'UTC', // –î–æ–±–∞–≤–µ–Ω–æ –∑–∞ –∫–æ—Ä–µ–∫—Ç–µ–Ω —á–∞—Å
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
        });
    }

    function getPowerTimes(checkInStr, checkOutStr) {
        const checkIn = new Date(checkInStr);
        const checkOut = new Date(checkOutStr);
        return { 
            on: new Date(checkIn.getTime() - (2 * 60 * 60 * 1000)), 
            off: new Date(checkOut.getTime() + (1 * 60 * 60 * 1000)) 
        };
    }

    async function loadBookings() {
        try {
            const res = await fetch('/bookings');
            currentBookings = await res.json();
            const tbody = document.getElementById('bookingList');
            tbody.innerHTML = '';
            
            currentBookings.forEach(b => {
                // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ –¥–∏—Ä–µ–∫—Ç–Ω–æ —Å–º–µ—Ç–Ω–∞—Ç–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–∞ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞ –∞–∫–æ –≥–∏ –∏–º–∞,
                // –∏–ª–∏ –≥–∏ —Å–º—è—Ç–∞–º–µ —Ç—É–∫ –∑–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                let times;
                if(b.power_on_time && b.power_off_time) {
                     times = { on: b.power_on_time, off: b.power_off_time };
                } else {
                     times = getPowerTimes(b.check_in, b.check_out);
                }

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <b>${b.guest_name}</b><br>
                            <span class="badge badge-res">${b.reservation_code}</span><br>
                            <small>–ü–ò–ù: ${b.lock_pin || '–ù–Ø–ú–ê'}</small>
                        </td>
                        <td>
                            <span class="badge badge-on">‚ö° ${formatBG(times.on)}</span><br>
                            <small>–ß–µ–∫-–∏–Ω: ${formatBG(b.check_in)}</small>
                        </td>
                        <td>
                            <span class="badge badge-off">üåë ${formatBG(times.off)}</span><br>
                            <small>–ß–µ–∫-–∞—É—Ç: ${formatBG(b.check_out)}</small>
                        </td>
                        <td><button class="delete-btn" onclick="deleteBooking(${b.id})">‚ùå</button></td>
                    </tr>`;
            });
        } catch(e) { console.error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏—Ç–µ"); }
    }

    async function addBooking() {
        const name = document.getElementById('guestName').value;
        const code = document.getElementById('resCode').value;
        const inVal = document.getElementById('checkIn').value;
        const outVal = document.getElementById('checkOut').value;
        const errorEl = document.getElementById('errorMsg');
        
        if (!name || !code || !inVal || !outVal) return alert("–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!");
        
        const start = new Date(inVal);
        const end = new Date(outVal);

        if (start >= end) return alert("–ì—Ä–µ—à–∫–∞: –ù–∞–ø—É—Å–∫–∞–Ω–µ—Ç–æ –µ –ø—Ä–µ–¥–∏ –Ω–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ—Ç–æ!");

        const hasOverlap = currentBookings.some(b => {
             const bStart = new Date(b.check_in);
             const bEnd = new Date(b.check_out);
             return start < bEnd && end > bStart;
        });

        if(hasOverlap) {
            errorEl.style.display = 'block';
            return;
        }
        errorEl.style.display = 'none';

        await fetch('/add-booking', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                guest_name: name, reservation_code: code,
                check_in: start.toISOString(), check_out: end.toISOString()
            })
        });
        
        document.getElementById('guestName').value = '';
        document.getElementById('resCode').value = '';
        loadBookings();
    }

    function generateCode() {
        document.getElementById('resCode').value = 'HM' + (Math.floor(Math.random()*900000)+100000);
    }
    
    async function deleteBooking(id) {
        if(confirm('–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è—Ç–∞?')) { 
            await fetch(`/bookings/${id}`, {method:'DELETE'}); 
            loadBookings(); 
        }
    }

    // --- REMOTE LOGIC ---
    async function checkPowerStatus() {
        const container = document.getElementById('remote-container');
        const statusText = document.getElementById('status-text');
        
        try {
            const res = await fetch('/status');
            const data = await res.json();
            
            container.classList.remove('system-on', 'system-error');

            if (data.is_on) {
                container.classList.add('system-on');
                statusText.innerText = 'SYSTEM ON/–í–ö–õ–Æ–ß–ï–ù';
            } else {
                statusText.innerText = 'SYSTEM OFF/–ò–ó–ö–õ–Æ–ß–ï–ù';
            }
        } catch(e) {
            container.classList.add('system-error');
            statusText.innerText = 'CONNECTION LOST';
        }
    }

    async function togglePower() {
        const statusText = document.getElementById('status-text');
        statusText.innerText = 'SENDING...';
        
        try {
            const res = await fetch('/toggle');
            if(res.ok) {
                setTimeout(checkPowerStatus, 1000);
            } else {
                throw new Error("Toggle fail");
            }
        } catch(e) {
            document.getElementById('remote-container').classList.add('system-error');
            statusText.innerText = 'COMMAND FAILED';
        }
    }

    // Init
    loadBookings();
    setInterval(checkPowerStatus, 15000);

</script>
</body>
</html>