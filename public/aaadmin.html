<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Stay - –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* –°—Ç–∏–ª –∑–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ –∏ –±—É—Ç–æ–Ω–∞ */
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        h1 { color: #333; margin: 0; }
        
        /* –°–¢–ò–õ –ó–ê –õ–ò–õ–ê–í–ò–Ø –ë–£–¢–û–ù */
        .sync-btn { background: #6f42c1; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: background 0.2s; }
        .sync-btn:hover { background: #59359a; }
        .sync-btn:disabled { background: #ccc; cursor: not-allowed; }

        .form-group { margin-bottom: 15px; display: grid; gap: 5px; }
        label { font-weight: 600; font-size: 14px; color: #555; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button.add-btn { background: #0084ff; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold; }
        button.add-btn:hover { background: #006bcf; }

        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { text-align: left; padding: 10px; background: #f8f9fa; color: #666; font-size: 14px; border-bottom: 2px solid #ddd; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }
        
        .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-bottom: 4px; }
        .badge-res { background: #e1f0ff; color: #0084ff; }
        .badge-on { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .badge-off { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .delete-btn { color: red; background: none; border: none; cursor: pointer; font-weight: bold; }
        .error { color: red; font-size: 14px; margin-top: 5px; display: none; }
        
        @media (max-width: 600px) {
            .header-row { flex-direction: column; gap: 10px; align-items: flex-start; }
            td, th { display: block; width: 100%; box-sizing: border-box; }
            tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
            td { border-bottom: none; padding: 5px 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h1>üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ & –¢–æ–∫</h1>
        
        <button class="sync-btn" onclick="manualSync()" id="syncBtn">
            üïµÔ∏è –ü—Ä–æ–≤–µ—Ä–∏ –ü–æ—â–∞—Ç–∞ –°–µ–≥–∞
        </button>
        </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
            <label>–ò–º–µ –Ω–∞ –≥–æ—Å—Ç–∞</label>
            <input type="text" id="guestName" placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
        </div>
        <div class="form-group">
            <label>–ö–æ–¥ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="resCode" placeholder="–ö–æ–¥ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è">
                <button onclick="generateCode()" style="width: 50px;">üé≤</button>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
            <label>–ù–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ (Check-in)</label>
            <input type="datetime-local" id="checkIn">
            <small style="color:green">–¢–æ–∫—ä—Ç —â–µ —Ç—Ä—ä–≥–Ω–µ 2 —á–∞—Å–∞ –ø–æ-—Ä–∞–Ω–æ.</small>
        </div>
        <div class="form-group">
            <label>–ù–∞–ø—É—Å–∫–∞–Ω–µ (Check-out)</label>
            <input type="datetime-local" id="checkOut">
            <small style="color:red">–¢–æ–∫—ä—Ç —â–µ —Å–ø—Ä–µ 1 —á–∞—Å –ø–æ-–∫—ä—Å–Ω–æ.</small>
        </div>
    </div>

    <div id="errorMsg" class="error">‚ö†Ô∏è –ì—Ä–µ—à–∫–∞: –ó–∞—Å–∏—á–∞–Ω–µ –Ω–∞ –¥–∞—Ç–∏!</div>
    <button class="add-btn" onclick="addBooking()">‚ûï –î–æ–±–∞–≤–∏ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è</button>

    <hr>

    <h3>–ì—Ä–∞—Ñ–∏–∫ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏—Ç–µ</h3>
    <table>
        <thead>
            <tr>
                <th>–ì–æ—Å—Ç / –ö–æ–¥</th>
                <th>‚ö° –í–ö–õ–Æ–ß–í–ê–ù–ï</th>
                <th>üåë –ò–ó–ö–õ–Æ–ß–í–ê–ù–ï</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
        </thead>
        <tbody id="bookingList"></tbody>
    </table>
    
    <div style="margin-top: 20px; text-align: right;">
        <a href="/calendar.ics" target="_blank" style="text-decoration: none; color: #0084ff;">üìÖ –°–≤–∞–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä –∑–∞ Airbnb (feed.ics)</a>
    </div>
</div>

<script>
    let currentBookings = [];

    // –§–£–ù–ö–¶–ò–Ø–¢–ê –ó–ê –ë–£–¢–û–ù–ê
    async function manualSync() {
        const btn = document.getElementById('syncBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º...';
        btn.disabled = true;

        try {
            const res = await fetch('/sync');
            const msg = await res.text();
            alert(msg); 
            loadBookings(); 
        } catch (err) {
            alert('‚ùå –ì—Ä–µ—à–∫–∞: ' + err.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // –í–ê–ñ–ù–û: timeZone: 'UTC' –æ–ø—Ä–∞–≤—è —á–∞—Å–æ–≤–µ—Ç–µ
    function formatBG(dateStr) {
        if (!dateStr) return '---';
        const d = new Date(dateStr);
        return d.toLocaleString('bg-BG', { 
            timeZone: 'UTC', 
            day: '2-digit', month: '2-digit', 
            hour: '2-digit', minute: '2-digit' 
        });
    }

    function getPowerTimes(booking) {
        return { 
            on: booking.power_on_time, 
            off: booking.power_off_time 
        };
    }

    async function loadBookings() {
        const res = await fetch('/bookings');
        currentBookings = await res.json();
        renderTable(currentBookings);
    }

    function renderTable(bookings) {
        const tbody = document.getElementById('bookingList');
        tbody.innerHTML = '';
        bookings.forEach(b => {
            const times = getPowerTimes(b);
            
            const row = `
                <tr>
                    <td>
                        <b>${b.guest_name}</b><br>
                        <span class="badge badge-res">${b.reservation_code}</span><br>
                        <small>–ü–ò–ù: ${b.lock_pin || '–ù–Ø–ú–ê'}</small>
                    </td>
                    <td>
                        <span class="badge badge-on">‚ö° ${formatBG(times.on)}</span><br>
                        <small>–ß–µ–∫-–∏–Ω: ${formatBG(b.check_in)}</small>
                    </td>
                    <td>
                        <span class="badge badge-off">üåë ${formatBG(times.off)}</span><br>
                        <small>–ß–µ–∫-–∞—É—Ç: ${formatBG(b.check_out)}</small>
                    </td>
                    <td><button class="delete-btn" onclick="deleteBooking(${b.id})">‚ùå</button></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function generateCode() {
        const rnd = Math.floor(Math.random() * 900000) + 100000;
        document.getElementById('resCode').value = 'HM' + rnd;
    }

    function hasOverlap(newStart, newEnd) {
        return currentBookings.some(booking => {
            const bStart = new Date(booking.check_in);
            const bEnd = new Date(booking.check_out);
            return newStart < bEnd && newEnd > bStart;
        });
    }

    async function addBooking() {
        const name = document.getElementById('guestName').value;
        const code = document.getElementById('resCode').value;
        const inVal = document.getElementById('checkIn').value;
        const outVal = document.getElementById('checkOut').value;
        const errorEl = document.getElementById('errorMsg');

        if (!name || !code || !inVal || !outVal) {
            alert("–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!");
            return;
        }

        const start = new Date(inVal);
        const end = new Date(outVal);

        if (start >= end) {
            alert("–ì—Ä–µ—à–∫–∞: –ù–∞–ø—É—Å–∫–∞–Ω–µ—Ç–æ –µ –ø—Ä–µ–¥–∏ –Ω–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ—Ç–æ!");
            return;
        }

        if (hasOverlap(start, end)) {
            errorEl.style.display = 'block';
            errorEl.innerText = "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ó–∞—Å–∏—á–∞–Ω–µ —Å –¥—Ä—É–≥–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è!";
            return;
        }
        errorEl.style.display = 'none';

        try {
            const res = await fetch('/add-booking', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    guest_name: name,
                    reservation_code: code,
                    check_in: start.toISOString(),
                    check_out: end.toISOString()
                })
            });
            
            if (res.ok) {
                document.getElementById('guestName').value = '';
                document.getElementById('resCode').value = '';
                loadBookings();
            } else {
                alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å.");
            }
        } catch (e) { console.error(e); }
    }

    async function deleteBooking(id) {
        if(confirm('–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?')) {
            await fetch(`/bookings/${id}`, { method: 'DELETE' });
            loadBookings();
        }
    }

    loadBookings();
</script>

</body>
</html>