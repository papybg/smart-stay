<!DOCTYPE html>
<html lang="bg"><body style="font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px;">
    <h2>‚ûï –ù–æ–≤–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è (v2.1)</h2>
    <input type="text" id="guest" placeholder="–ò–º–µ">
    <input type="datetime-local" id="in">
    <input type="datetime-local" id="out">
    <input type="text" id="code" placeholder="–ö–æ–¥">
    <button onclick="add()" style="width:100%; padding:10px; background:green; color:white; margin-top:10px;">–ó–ê–ü–ò–®–ò –í NEON</button>
    
    <table id="list" style="width:100%; margin-top:20px; border-collapse: collapse;"></table>

    <script>
        const API = ''; // –û—Å—Ç–∞–≤—è–º–µ –ø—Ä–∞–∑–Ω–æ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–∞–∑–ø–æ–∑–Ω–∞–≤–∞–Ω–µ (localhost/render)

        async function add() {
            const inDate = new Date(document.getElementById('in').value);
            const outDate = new Date(document.getElementById('out').value);

            const body = {
                guest_name: document.getElementById('guest').value,
                check_in: inDate.toISOString(), // –¢–æ–≤–∞ –í–ê–î–ò 2 —á–∞—Å–∞ (14:00 -> 12:00 UTC)
                check_out: outDate.toISOString(), 
                reservation_code: document.getElementById('code').value
            };

            const res = await fetch(`${API}/add-booking`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)});
            const data = await res.json();
            
            if(data.success) { 
                alert("‚úÖ –£—Å–ø–µ—à–Ω–æ! –ü–ò–ù –∫–æ–¥: " + data.pin);
                // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞
                document.querySelectorAll('input').forEach(i => i.value = '');
                load(); // –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ —Å–∞–º–æ –Ω–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞, –±–µ–∑ —Ä–µ—Ñ—Ä–µ—à –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
            } else {
                alert("‚ùå –ì—Ä–µ—à–∫–∞: " + data.error);
            }
        }

        async function del(id) {
            if(!confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–∞–∑–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è?')) return;
            const res = await fetch(`${API}/bookings/${id}`, { method: 'DELETE' });
            if (res.ok) {
                load();
            } else {
                alert("‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ!");
            }
        }

        async function load() {
            // –î–æ–±–∞–≤—è–º–µ ?t=... –∑–∞ –¥–∞ —Å–º–µ —Å–∏–≥—É—Ä–Ω–∏, —á–µ –Ω–µ –≤–∑–∏–º–∞–º–µ –∫–µ—à–∏—Ä–∞–Ω —Å–ø–∏—Å—ä–∫
            const res = await fetch(`${API}/bookings?t=${Date.now()}`);
            const data = await res.json();
            
            const header = `
                <tr style="background:#333; color:white; text-align:left;">
                    <th style="padding:10px;">–ì–æ—Å—Ç</th>
                    <th>–ù–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ / –¢–æ–∫ ON</th>
                    <th>–ù–∞–ø—É—Å–∫–∞–Ω–µ / –¢–æ–∫ OFF</th>
                    <th>–ë—Ä–∞–≤–∞ (PIN)</th>
                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                </tr>`;
            
            // –§–∏–ª—Ç—Ä–∏—Ä–∞–º–µ —Å–∞–º–æ –∞–∫—Ç–∏–≤–Ω–∏—Ç–µ (–±—ä–¥–µ—â–∏ –∏ —Ç–µ–∫—É—â–∏) —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
            const activeData = data.filter(b => new Date(b.check_out) > new Date());

            document.getElementById('list').innerHTML = header + activeData.map(b => {
                // –õ–æ–≥–∏–∫–∞ –∑–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Å—Ç–∞—Ç—É—Å–∏—Ç–µ
                const checkInDate = new Date(b.check_in);
                const checkOutDate = new Date(b.check_out);
                const offTime = new Date(checkOutDate.getTime() + 3600000); // +1 —á–∞—Å

                const onStatus = b.power_on_time ? '‚úÖ <small style="color:green">–í–ö–õ–Æ–ß–ï–ù</small>' : '‚è≥ <small style="color:#888">–ß–ê–ö–ê</small>';
                const offStatus = b.power_off_time ? '‚úÖ <small style="color:red">–ò–ó–ö–õ–Æ–ß–ï–ù</small>' : '‚è≥ <small style="color:#888">–ß–ê–ö–ê</small>';

                return `
                <tr style="border-bottom:1px solid #ccc;">
                    <td style="padding:8px;">${b.guest_name}</td>
                    <td style="padding:8px;">
                        <div>üìÖ ${checkInDate.toLocaleString('bg-BG')}</div>
                        <div style="margin-top:4px;">‚ö° ${onStatus}</div>
                    </td>
                    <td style="padding:8px;">
                        <div>üìÖ ${checkOutDate.toLocaleString('bg-BG')}</div>
                        <div style="margin-top:4px;">üîå –ü–ª–∞–Ω–∏—Ä–∞–Ω–æ —Å–ø–∏—Ä–∞–Ω–µ: ${offTime.toLocaleTimeString('bg-BG', {hour:'2-digit', minute:'2-digit'})} ${offStatus}</div>
                    </td>
                    <td style="padding:8px;">
                        <div style="font-weight:bold; font-size:1.1em;">üîë ${b.lock_pin}</div>
                        <small style="color:#666">Res: ${b.reservation_code}</small>
                    </td>
                    <td style="padding:8px;"><button onclick="del(${b.id})" style="background:#d9534f; color:white; border:none; padding:5px 10px; cursor:pointer;">–ò–∑—Ç—Ä–∏–π</button></td>
                </tr>
            `}).join('');
        }
        load();
    </script>
</body></html>