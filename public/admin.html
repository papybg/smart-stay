<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Stay - –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        /* –§–æ—Ä–º–∞ */
        .form-group { margin-bottom: 15px; display: grid; gap: 5px; }
        label { font-weight: 600; font-size: 14px; color: #555; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button.add-btn { background: #0084ff; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold; }
        button.add-btn:hover { background: #006bcf; }

        /* –¢–∞–±–ª–∏—Ü–∞ */
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { text-align: left; padding: 10px; background: #f8f9fa; color: #666; font-size: 14px; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 15px; }
        .badge { background: #e1f0ff; color: #0084ff; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .delete-btn { color: red; background: none; border: none; cursor: pointer; font-weight: bold; }
        
        .error { color: red; font-size: 14px; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –†–µ–∑–µ—Ä–≤–∞—Ü–∏–∏</h1>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
            <label>–ò–º–µ –Ω–∞ –≥–æ—Å—Ç–∞</label>
            <input type="text" id="guestName" placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
        </div>
        <div class="form-group">
            <label>–ö–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è (HM...)</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="resCode" placeholder="HM123456">
                <button onclick="generateCode()" style="width: 50px;">üé≤</button>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
            <label>–ù–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ (Check-in)</label>
            <input type="datetime-local" id="checkIn">
        </div>
        <div class="form-group">
            <label>–ù–∞–ø—É—Å–∫–∞–Ω–µ (Check-out)</label>
            <input type="datetime-local" id="checkOut">
        </div>
    </div>

    <div id="errorMsg" class="error">‚ö†Ô∏è –ì—Ä–µ—à–∫–∞: –ò–º–∞ –∑–∞—Å–∏—á–∞–Ω–µ —Å –¥—Ä—É–≥–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –∑–∞ —Ç–µ–∑–∏ –¥–∞—Ç–∏!</div>
    <button class="add-btn" onclick="addBooking()">‚ûï –î–æ–±–∞–≤–∏ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è</button>

    <hr>

    <h3>–ê–∫—Ç–∏–≤–Ω–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏</h3>
    <table>
        <thead>
            <tr>
                <th>–ì–æ—Å—Ç</th>
                <th>–ü–µ—Ä–∏–æ–¥</th>
                <th>–ö–æ–¥–æ–≤–µ</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
        </thead>
        <tbody id="bookingList">
            </tbody>
    </table>
    
    <div style="margin-top: 20px; text-align: right;">
        <a href="/calendar.ics" target="_blank" style="text-decoration: none; color: #0084ff;">üìÖ –°–≤–∞–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä (ICS)</a>
    </div>
</div>

<script>
    let currentBookings = [];

    // 1. –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏—Ç–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç
    async function loadBookings() {
        const res = await fetch('/bookings');
        currentBookings = await res.json();
        renderTable(currentBookings);
    }

    function renderTable(bookings) {
        const tbody = document.getElementById('bookingList');
        tbody.innerHTML = '';
        bookings.forEach(b => {
            const start = new Date(b.check_in).toLocaleString('bg-BG');
            const end = new Date(b.check_out).toLocaleString('bg-BG');
            const row = `
                <tr>
                    <td><b>${b.guest_name}</b></td>
                    <td style="font-size: 13px;">–û—Ç: ${start}<br>–î–æ: ${end}</td>
                    <td>
                        <span class="badge">HM: ${b.reservation_code}</span><br>
                        <small>PIN: ${b.lock_pin}</small>
                    </td>
                    <td><button class="delete-btn" onclick="deleteBooking(${b.id})">–ò–∑—Ç—Ä–∏–π</button></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // 2. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Å–ª—É—á–∞–µ–Ω –∫–æ–¥
    function generateCode() {
        const rnd = Math.floor(Math.random() * 900000) + 100000;
        document.getElementById('resCode').value = 'HM' + rnd;
    }

    // 3. –ü–†–û–í–ï–†–ö–ê –ó–ê –ó–ê–°–ò–ß–ê–ù–ï (Conflict Check)
    function hasOverlap(newStart, newEnd) {
        return currentBookings.some(booking => {
            const bStart = new Date(booking.check_in);
            const bEnd = new Date(booking.check_out);
            
            // –õ–æ–≥–∏–∫–∞: –ù–æ–≤–∞—Ç–∞ –∑–∞–ø–æ—á–≤–∞ –ü–†–ï–î–ò —Å—Ç–∞—Ä–∞—Ç–∞ –¥–∞ —Å–≤—ä—Ä—à–∏ –ò —Å–≤—ä—Ä—à–≤–∞ –°–õ–ï–î –∫–∞—Ç–æ —Å—Ç–∞—Ä–∞—Ç–∞ –µ –∑–∞–ø–æ—á–Ω–∞–ª–∞
            return newStart < bEnd && newEnd > bStart;
        });
    }

    async function addBooking() {
        const name = document.getElementById('guestName').value;
        const code = document.getElementById('resCode').value;
        const inDate = document.getElementById('checkIn').value;
        const outDate = document.getElementById('checkOut').value;
        const errorEl = document.getElementById('errorMsg');

        if (!name || !code || !inDate || !outDate) {
            alert("–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!");
            return;
        }

        const start = new Date(inDate);
        const end = new Date(outDate);

        if (start >= end) {
            alert("–î–∞—Ç–∞—Ç–∞ –Ω–∞ –Ω–∞–ø—É—Å–∫–∞–Ω–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ —Å–ª–µ–¥ –Ω–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ—Ç–æ!");
            return;
        }

        // --- –¢–£–ö –ï –ó–ê–©–ò–¢–ê–¢–ê ---
        if (hasOverlap(start, end)) {
            errorEl.style.display = 'block';
            errorEl.innerText = "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ó–∞—Å–∏—á–∞–Ω–µ –Ω–∞ –¥–∞—Ç–∏! –ò–º–∞—Ç–µ –¥—Ä—É–≥–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –ø–æ —Ç–æ–≤–∞ –≤—Ä–µ–º–µ.";
            return; // –°–ø–∏—Ä–∞–º–µ –∑–∞–ø–∏—Å–∞
        }
        errorEl.style.display = 'none';
        // ---------------------

        try {
            const res = await fetch('/add-booking', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    guest_name: name,
                    reservation_code: code,
                    check_in: inDate,
                    check_out: outDate
                })
            });
            
            if (res.ok) {
                // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ —Ñ–æ—Ä–º–∞—Ç–∞
                document.getElementById('guestName').value = '';
                document.getElementById('resCode').value = '';
                loadBookings(); // –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–º–µ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
            } else {
                alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å –≤ –±–∞–∑–∞—Ç–∞.");
            }
        } catch (e) { console.error(e); }
    }

    async function deleteBooking(id) {
        if(confirm('–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?')) {
            await fetch(`/bookings/${id}`, { method: 'DELETE' });
            loadBookings();
        }
    }

    loadBookings();
</script>

</body>
</html>