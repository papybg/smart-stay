<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Stay Admin</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; background: #f4f4f4; }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        .control-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background: #218838; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th { background: #333; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        .live-status { font-weight: bold; padding: 10px; text-align: center; background: #ddd; margin-bottom: 20px; border-radius: 4px; }
        .status-on { background: #d4edda; color: #155724; }
        .status-off { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <div id="liveStatus" class="live-status">Checking System Status...</div>

    <div class="control-panel">
        <h2>‚ûï –ù–æ–≤–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è</h2>
        <input type="text" id="guest" placeholder="–ò–º–µ –Ω–∞ –≥–æ—Å—Ç–∞">
        <label><small>–ù–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ (Check-in):</small></label>
        <input type="datetime-local" id="in">
        <label><small>–ù–∞–ø—É—Å–∫–∞–Ω–µ (Check-out):</small></label>
        <input type="datetime-local" id="out">
        <input type="text" id="code" placeholder="–ö–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è (–Ω–∞–ø—Ä. HMA...)">
        <button onclick="add()">–ó–ê–ü–ò–®–ò –†–ï–ó–ï–†–í–ê–¶–ò–Ø–¢–ê</button>
    </div>
    
    <h3>üìÖ –ê–∫—Ç–∏–≤–Ω–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏</h3>
    <table id="list"></table>

    <script>
        const API = ''; // –û—Å—Ç–∞–≤—è–º–µ –ø—Ä–∞–∑–Ω–æ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–∞–∑–ø–æ–∑–Ω–∞–≤–∞–Ω–µ (localhost/render)

        // 1. –§—É–Ω–∫—Ü–∏—è –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ —Å –ö–û–†–ï–ö–¶–ò–Ø –ù–ê –ß–ê–°–û–í–ï–¢–ï
        async function add() {
            const guest = document.getElementById('guest').value;
            const inVal = document.getElementById('in').value;
            const outVal = document.getElementById('out').value;
            const code = document.getElementById('code').value;

            if(!guest || !inVal || !outVal || !code) {
                alert("–ú–æ–ª—è –ø–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!");
                return;
            }

            // –¢–£–ö –ï FIX-—ä—Ç: .toISOString() –ø—Ä–µ–≤—Ä—ä—â–∞ —Ç–≤–æ–µ—Ç–æ –≤—Ä–µ–º–µ –≤ UTC –∑–∞ —Å—ä—Ä–≤—ä—Ä–∞
            // –¢–∞–∫–∞ 14:00 –ë–ì —Å—Ç–∞–≤–∞ 12:00 UTC, –∏ –ø–æ—Å–ª–µ —Å–µ –≤—Ä—ä—â–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ
            const body = {
                guest_name: guest,
                check_in: new Date(inVal).toISOString(),
                check_out: new Date(outVal).toISOString(),
                reservation_code: code
            };

            try {
                const res = await fetch(`${API}/add-booking`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                
                if(data.success) { 
                    alert("‚úÖ –£—Å–ø–µ—à–Ω–æ! –ü–ò–ù –∫–æ–¥ –∑–∞ –≤—Ä–∞—Ç–∞—Ç–∞: " + data.pin);
                    // –ß–∏—Å—Ç–∏–º –ø–æ–ª–µ—Ç–∞—Ç–∞
                    document.getElementById('guest').value = '';
                    document.getElementById('code').value = '';
                    load(); 
                } else {
                    alert("‚ùå –ì—Ä–µ—à–∫–∞: " + data.error);
                }
            } catch (e) {
                alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞!");
            }
        }

        async function del(id) {
            if(!confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ? –¢–æ–≤–∞ —â–µ –∏–∑—Ç—Ä–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è—Ç–∞ –∑–∞–≤–∏–Ω–∞–≥–∏.')) return;
            await fetch(`${API}/bookings/${id}`, { method: 'DELETE' });
            load();
        }

        // 2. –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ü–†–ê–í–ò–õ–ù–ò —Å—Ç–∞—Ç—É—Å–∏
        async function load() {
            try {
                const res = await fetch(`${API}/bookings?t=${Date.now()}`); // –ë–µ–∑ –∫–µ—à
                const data = await res.json();
                
                const header = `
                    <tr>
                        <th>–ì–æ—Å—Ç / –ö–æ–¥</th>
                        <th>–ù–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ (ON)</th>
                        <th>–ù–∞–ø—É—Å–∫–∞–Ω–µ (OFF)</th>
                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>`;
                
                // –ü–æ–∫–∞–∑–≤–∞–º–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –¥–æ 24—á –Ω–∞–∑–∞–¥
                const activeData = data.filter(b => new Date(b.check_out) > new Date(Date.now() - 86400000));

                document.getElementById('list').innerHTML = header + activeData.map(b => {
                    const checkIn = new Date(b.check_in);
                    const checkOut = new Date(b.check_out);
                    
                    // –ü–ª–∞–Ω–∏—Ä–∞–Ω–æ—Ç–æ —Å–ø–∏—Ä–∞–Ω–µ –µ 1 —á–∞—Å —Å–ª–µ–¥ –Ω–∞–ø—É—Å–∫–∞–Ω–µ
                    const plannedOff = new Date(checkOut.getTime() + 3600000); 

                    // –°—Ç–∞—Ç—É—Å–∏ –æ—Ç –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏ (–∫–æ–≥–∞ —Ä–µ–∞–ª–Ω–æ –µ —Å—Ç–∞–Ω–∞–ª–æ)
                    const onStatus = b.power_on_time 
                        ? `<div style="color:green; font-weight:bold;">‚ö° –í–ö–õ–Æ–ß–ï–ù –≤ ${new Date(b.power_on_time).toLocaleTimeString('bg-BG')}</div>` 
                        : '<div style="color:#999;">‚è≥ –ß–∞–∫–∞ —Ç–∞–π–º–µ—Ä</div>';
                        
                    const offStatus = b.power_off_time 
                        ? `<div style="color:red; font-weight:bold;">üåë –ò–ó–ö–õ–Æ–ß–ï–ù</div>` 
                        : `<div style="color:#999;">‚è≥ –©–µ —Å–ø—Ä–µ –≤ ${plannedOff.toLocaleTimeString('bg-BG', {hour:'2-digit', minute:'2-digit'})}</div>`;

                    return `
                    <tr>
                        <td>
                            <b>${b.guest_name}</b><br>
                            <small>Res: ${b.reservation_code}</small><br>
                            <span style="background:#eee; padding:2px 5px; border-radius:3px;">üîë ${b.lock_pin}</span>
                        </td>
                        <td>
                            ${checkIn.toLocaleString('bg-BG')}<br>
                            ${onStatus}
                        </td>
                        <td>
                            ${checkOut.toLocaleString('bg-BG')}<br>
                            ${offStatus}
                        </td>
                        <td>
                            <button onclick="del(${b.id})" style="background:#dc3545; padding:5px;">–ò–∑—Ç—Ä–∏–π</button>
                        </td>
                    </tr>`;
                }).join('');

                // –û–±–Ω–æ–≤—è–≤–∞–º–µ –∏ –≥–ª–æ–±–∞–ª–Ω–∏—è —Å—Ç–∞—Ç—É—Å –Ω–∞–π-–≥–æ—Ä–µ
                checkSystemStatus();

            } catch (e) { console.error(e); }
        }

        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –ª–∞–º–ø–∞—Ç–∞ —Å–≤–µ—Ç–∏ –í –ú–û–ú–ï–ù–¢–ê (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏—Ç–µ)
        async function checkSystemStatus() {
            try {
                const res = await fetch(`${API}/status`);
                const data = await res.json();
                const div = document.getElementById('liveStatus');
                if (data.is_on) {
                    div.innerHTML = "‚ö° –í–ù–ò–ú–ê–ù–ò–ï: –¢–û–ö–™–¢ –í –ê–ü–ê–†–¢–ê–ú–ï–ù–¢–ê –ï –í–ö–õ–Æ–ß–ï–ù";
                    div.className = "live-status status-on";
                } else {
                    div.innerHTML = "üåë –¢–æ–∫—ä—Ç –≤ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –µ –∏–∑–∫–ª—é—á–µ–Ω";
                    div.className = "live-status status-off";
                }
            } catch(e) {}
        }

        // –ü—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        load();
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω —Ä–µ—Ñ—Ä–µ—à –Ω–∞ –≤—Å–µ–∫–∏ 30 —Å–µ–∫—É–Ω–¥–∏
        setInterval(load, 30000);

    </script>
</body>
</html>