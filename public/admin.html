<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Stay - –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        /* –§–æ—Ä–º–∞ */
        .form-group { margin-bottom: 15px; display: grid; gap: 5px; }
        label { font-weight: 600; font-size: 14px; color: #555; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button.add-btn { background: #0084ff; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold; }
        button.add-btn:hover { background: #006bcf; }

        /* –¢–∞–±–ª–∏—Ü–∞ */
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { text-align: left; padding: 10px; background: #f8f9fa; color: #666; font-size: 14px; border-bottom: 2px solid #ddd; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }
        
        .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-bottom: 4px; }
        .badge-res { background: #e1f0ff; color: #0084ff; }
        .badge-on { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .badge-off { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .delete-btn { color: red; background: none; border: none; cursor: pointer; font-weight: bold; }
        .error { color: red; font-size: 14px; margin-top: 5px; display: none; }
        
        /* –ó–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ */
        @media (max-width: 600px) {
            td, th { display: block; width: 100%; box-sizing: border-box; }
            tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
            td { border-bottom: none; padding: 5px 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ & –¢–æ–∫</h1>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
            <label>–ò–º–µ –Ω–∞ –≥–æ—Å—Ç–∞</label>
            <input type="text" id="guestName" placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
        </div>
        <div class="form-group">
            <label>–ö–æ–¥ (HM...)</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="resCode" placeholder="HM...">
                <button onclick="generateCode()" style="width: 50px;">üé≤</button>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
            <label>–ù–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ (Check-in)</label>
            <input type="datetime-local" id="checkIn">
            <small style="color:green">–¢–æ–∫—ä—Ç —â–µ —Ç—Ä—ä–≥–Ω–µ 2 —á–∞—Å–∞ –ø–æ-—Ä–∞–Ω–æ.</small>
        </div>
        <div class="form-group">
            <label>–ù–∞–ø—É—Å–∫–∞–Ω–µ (Check-out)</label>
            <input type="datetime-local" id="checkOut">
            <small style="color:red">–¢–æ–∫—ä—Ç —â–µ —Å–ø—Ä–µ 1 —á–∞—Å –ø–æ-–∫—ä—Å–Ω–æ.</small>
        </div>
    </div>

    <div id="errorMsg" class="error">‚ö†Ô∏è –ì—Ä–µ—à–∫–∞: –ó–∞—Å–∏—á–∞–Ω–µ –Ω–∞ –¥–∞—Ç–∏!</div>
    <button class="add-btn" onclick="addBooking()">‚ûï –î–æ–±–∞–≤–∏ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è</button>

    <hr>

    <h3>–ì—Ä–∞—Ñ–∏–∫ –Ω–∞ —Ç–æ–∫–∞</h3>
    <table>
        <thead>
            <tr>
                <th>–ì–æ—Å—Ç / –ö–æ–¥</th>
                <th>‚ö° –í–ö–õ–Æ–ß–í–ê–ù–ï (Check-in -2—á)</th>
                <th>üåë –ò–ó–ö–õ–Æ–ß–í–ê–ù–ï (Check-out +1—á)</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
        </thead>
        <tbody id="bookingList"></tbody>
    </table>
    
    <div style="margin-top: 20px; text-align: right;">
        <a href="/calendar.ics" target="_blank" style="text-decoration: none; color: #0084ff;">üìÖ –°–≤–∞–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä (ICS)</a>
    </div>
</div>

<script>
    let currentBookings = [];

    // –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –¥–∞—Ç–∞ –∑–∞ –ë–ì —Å—Ç–∞–Ω–¥–∞—Ä—Ç
    function formatBG(dateStr) {
        if (!dateStr) return '---';
        const d = new Date(dateStr);
        return d.toLocaleString('bg-BG', { 
            day: '2-digit', month: '2-digit', 
            hour: '2-digit', minute: '2-digit' 
        });
    }

    // –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –≤—Ä–µ–º–µ –∑–∞ —Ç–æ–∫
    function getPowerTimes(checkInStr, checkOutStr) {
        const checkIn = new Date(checkInStr);
        const checkOut = new Date(checkOutStr);
        
        // –í–∫–ª—é—á–≤–∞–Ω–µ: -2 —á–∞—Å–∞
        const powerOn = new Date(checkIn.getTime() - (2 * 60 * 60 * 1000));
        // –ò–∑–∫–ª—é—á–≤–∞–Ω–µ: +1 —á–∞—Å
        const powerOff = new Date(checkOut.getTime() + (1 * 60 * 60 * 1000));

        return { on: powerOn, off: powerOff };
    }

    async function loadBookings() {
        const res = await fetch('/bookings');
        currentBookings = await res.json();
        renderTable(currentBookings);
    }

    function renderTable(bookings) {
        const tbody = document.getElementById('bookingList');
        tbody.innerHTML = '';
        bookings.forEach(b => {
            const times = getPowerTimes(b.check_in, b.check_out);
            
            const row = `
                <tr>
                    <td>
                        <b>${b.guest_name}</b><br>
                        <span class="badge badge-res">${b.reservation_code}</span><br>
                        <small>–ü–ò–ù: ${b.lock_pin}</small>
                    </td>
                    <td>
                        <span class="badge badge-on">‚ö° ${formatBG(times.on)}</span><br>
                        <small>–ù–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ: ${formatBG(b.check_in)}</small>
                    </td>
                    <td>
                        <span class="badge badge-off">üåë ${formatBG(times.off)}</span><br>
                        <small>–ù–∞–ø—É—Å–∫–∞–Ω–µ: ${formatBG(b.check_out)}</small>
                    </td>
                    <td><button class="delete-btn" onclick="deleteBooking(${b.id})">‚ùå</button></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function generateCode() {
        const rnd = Math.floor(Math.random() * 900000) + 100000;
        document.getElementById('resCode').value = 'HM' + rnd;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∑–∞—Å–∏—á–∞–Ω–µ (Overlap)
    function hasOverlap(newStart, newEnd) {
        return currentBookings.some(booking => {
            const bStart = new Date(booking.check_in);
            const bEnd = new Date(booking.check_out);
            return newStart < bEnd && newEnd > bStart;
        });
    }

    async function addBooking() {
        const name = document.getElementById('guestName').value;
        const code = document.getElementById('resCode').value;
        const inVal = document.getElementById('checkIn').value;
        const outVal = document.getElementById('checkOut').value;
        const errorEl = document.getElementById('errorMsg');

        if (!name || !code || !inVal || !outVal) {
            alert("–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!");
            return;
        }

        const start = new Date(inVal);
        const end = new Date(outVal);

        if (start >= end) {
            alert("–ì—Ä–µ—à–∫–∞: –ù–∞–ø—É—Å–∫–∞–Ω–µ—Ç–æ –µ –ø—Ä–µ–¥–∏ –Ω–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ—Ç–æ!");
            return;
        }

        if (hasOverlap(start, end)) {
            errorEl.style.display = 'block';
            errorEl.innerText = "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ó–∞—Å–∏—á–∞–Ω–µ —Å –¥—Ä—É–≥–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è!";
            return;
        }
        errorEl.style.display = 'none';

        // –ò–ó–ü–†–ê–©–ê–ù–ï –ö–™–ú –°–™–†–í–™–†–ê (–ö–∞—Ç–æ ISO —Å—Ç—Ä–∏–Ω–≥, –∑–∞ –¥–∞ –∑–∞–ø–∞–∑–∏–º —á–∞—Å–∞)
        try {
            const res = await fetch('/add-booking', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    guest_name: name,
                    reservation_code: code,
                    check_in: start.toISOString(), // <-- –¢–û–í–ê –û–ü–†–ê–í–Ø –ß–ê–°–û–í–ò–¢–ï –ó–û–ù–ò
                    check_out: end.toISOString()
                })
            });
            
            if (res.ok) {
                document.getElementById('guestName').value = '';
                document.getElementById('resCode').value = '';
                loadBookings();
            } else {
                alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å.");
            }
        } catch (e) { console.error(e); }
    }

    async function deleteBooking(id) {
        if(confirm('–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?')) {
            await fetch(`/bookings/${id}`, { method: 'DELETE' });
            loadBookings();
        }
    }

    loadBookings();
</script>

</body>
</html>