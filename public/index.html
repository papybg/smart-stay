<!DOCTYPE html>
<html class="light" lang="bg">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Iko AI | Aspen Valley</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec5b",
                        "forest-green": "#1b3a27",
                        "background-light": "#f3f0e9",
                        "background-dark": "#101813",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem" },
                },
            },
        }
    </script>
    <style>
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∏ —Å—Ç–∏–ª–æ–≤–µ –æ—Ç —Ç–≤–æ—è –¥–∏–∑–∞–π–Ω */
        .glass-header {
            background: rgba(243, 240, 233, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .dark .glass-header {
            background: rgba(16, 24, 19, 0.85);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .organic-texture { background-color: #f3f0e9; }
        .glass-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞ —Ç–æ—á–∫–∏—Ç–µ (–∫–æ–≥–∞—Ç–æ –ò–∫–æ –ø–∏—à–µ) */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-[#111813] dark:text-white transition-colors duration-300">

<div class="relative flex h-[100dvh] w-full flex-col overflow-hidden organic-texture">
    
    <header class="glass-header sticky top-0 z-50 flex items-center p-4 pb-3 justify-between shadow-sm">
        <div class="flex items-center gap-3">
            <div class="flex size-10 items-center justify-center rounded-full bg-white/50 dark:bg-white/10 shadow-sm">
                <span class="material-symbols-outlined text-[#1b3a27] dark:text-primary">smart_toy</span>
            </div>
            <div>
                <h2 class="text-sm font-bold leading-tight tracking-tight">–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç D105</h2>
                <p class="text-[11px] font-medium uppercase tracking-widest text-[#61896f]">Aspen Valley</p>
            </div>
        </div>
        <div class="flex items-center bg-white/40 dark:bg-black/20 px-3 py-1 rounded-full border border-white/20">
            <div class="size-2 rounded-full bg-primary animate-pulse mr-2"></div>
            <span class="text-[10px] font-bold uppercase tracking-wider text-[#1b3a27] dark:text-white">ONLINE</span>
        </div>
    </header>

    <main id="chat-container" class="flex-1 overflow-y-auto px-4 py-6 space-y-6 scroll-smooth">
        <div class="flex justify-center">
            <span class="text-[10px] font-bold uppercase tracking-widest text-[#a1a8a3] bg-black/5 dark:bg-white/5 px-3 py-1 rounded-full">–î–Ω–µ—Å</span>
        </div>

        <div class="flex items-end gap-3 max-w-[90%]">
            <div class="bg-white dark:bg-[#25362a] flex items-center justify-center rounded-full w-9 h-9 shrink-0 shadow-sm border border-white/50">
                <span class="material-symbols-outlined text-[#1b3a27] dark:text-primary text-[20px]">smart_toy</span>
            </div>
            <div class="flex flex-col gap-1 items-start">
                <p class="text-[#61896f] text-[10px] font-bold uppercase tracking-wider ml-2">Iko AI</p>
                <div class="text-[15px] font-medium leading-relaxed rounded-2xl rounded-bl-none px-4 py-3 bg-white dark:bg-[#1e2d24] text-[#111813] dark:text-white shadow-sm border border-white/40">
                    –ó–¥—Ä–∞–≤–µ–π—Ç–µ! –ê–∑ —Å—ä–º –ò–∫–æ. üëã<br>
                    –ú–æ–≥–∞ –¥–∞ –≤–∏ –ø–æ–º–æ–≥–Ω–∞ —Å –Ω–∞—Å—Ç–∞–Ω—è–≤–∞–Ω–µ—Ç–æ, Wi-Fi –ø–∞—Ä–æ–ª–∞—Ç–∞ –∏–ª–∏ –¥–∞ –ø—É—Å–Ω–∞ –æ—Ç–æ–ø–ª–µ–Ω–∏–µ—Ç–æ. –°–∞–º–æ –º–∏ –∫–∞–∂–µ—Ç–µ –∫–æ–¥–∞ —Å–∏ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è.
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full bg-gradient-to-t from-background-light dark:from-background-dark via-background-light/95 dark:via-background-dark/95 to-transparent pt-4 z-40 pb-safe">
        
        <div class="flex gap-2 px-4 pb-4 overflow-x-auto no-scrollbar">
            <button onclick="sendQuickReply('–ö–∞–∫–≤–∞ –µ Wi-Fi –ø–∞—Ä–æ–ª–∞—Ç–∞?')" class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white dark:bg-[#1e2d24] px-4 shadow-sm border border-white/50 hover:border-primary active:scale-95 transition-all">
                <span class="material-symbols-outlined text-[18px] text-[#61896f]">wifi</span>
                <p class="text-[#111813] dark:text-white text-xs font-semibold whitespace-nowrap">Wi-Fi</p>
            </button>
            <button onclick="sendQuickReply('–ù—è–º–∞ —Ç–æ–∫')" class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white dark:bg-[#1e2d24] px-4 shadow-sm border border-white/50 hover:border-primary active:scale-95 transition-all">
                <span class="material-symbols-outlined text-[18px] text-[#61896f]">bolt</span>
                <p class="text-[#111813] dark:text-white text-xs font-semibold whitespace-nowrap">–¢–æ–∫</p>
            </button>
            <button onclick="sendQuickReply('–ö–æ–≥–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –æ—Å–≤–æ–±–æ–¥—è?')" class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white dark:bg-[#1e2d24] px-4 shadow-sm border border-white/50 hover:border-primary active:scale-95 transition-all">
                <span class="material-symbols-outlined text-[18px] text-[#61896f]">schedule</span>
                <p class="text-[#111813] dark:text-white text-xs font-semibold whitespace-nowrap">Check-out</p>
            </button>
        </div>

        <div class="px-4 pb-6">
            <div class="glass-input flex items-center rounded-full p-2 pr-2 pl-5 shadow-xl border border-white/50 ring-1 ring-black/5">
                <input id="user-input" class="flex-1 bg-transparent border-none focus:ring-0 text-[16px] placeholder-[#61896f]/60 text-[#111813] dark:text-white py-2" placeholder="–ü–∏—à–µ—Ç–µ —Ç—É–∫..." type="text" autocomplete="off"/>
                <button id="send-btn" class="flex size-10 items-center justify-center rounded-full bg-forest-green text-white shadow-lg hover:scale-105 active:scale-90 transition-all">
                    <span class="material-symbols-outlined font-bold text-[20px]">arrow_upward</span>
                </button>
            </div>
        </div>
    </footer>
</div>

<script>
    // --- JAVASCRIPT –õ–û–ì–ò–ö–ê (–í—Ä—ä–∑–∫–∞—Ç–∞ —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞) ---
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    let chatHistory = [];

    // –°–∫—Ä–æ–ª –¥–æ –¥–æ–ª—É
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –±–∞–ª–æ–Ω—á–µ –≤ —á–∞—Ç–∞
    function appendMessage(sender, text, isTyping = false) {
        const isUser = sender === 'user';
        const msgDiv = document.createElement('div');
        
        msgDiv.className = isUser 
            ? "flex items-end gap-3 justify-end ml-auto max-w-[90%]" 
            : "flex items-end gap-3 max-w-[90%]";

        if (isUser) {
            msgDiv.innerHTML = `
                <div class="flex flex-col gap-1 items-end">
                    <div class="text-[15px] font-medium leading-relaxed rounded-2xl rounded-br-none px-4 py-3 bg-forest-green text-white shadow-md">
                        ${text}
                    </div>
                </div>
            `;
        } else {
            let content = text;
            if (isTyping) {
                content = `
                <div class="flex gap-1 h-6 items-center">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>`;
            } else {
                content = content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            }

            msgDiv.innerHTML = `
                <div class="bg-white dark:bg-[#25362a] flex items-center justify-center rounded-full w-9 h-9 shrink-0 shadow-sm border border-white/50">
                    <span class="material-symbols-outlined text-[#1b3a27] dark:text-primary text-[20px]">smart_toy</span>
                </div>
                <div class="flex flex-col gap-1 items-start">
                    <p class="text-[#61896f] text-[10px] font-bold uppercase tracking-wider ml-2">Iko AI</p>
                    <div class="text-[15px] font-medium leading-relaxed rounded-2xl rounded-bl-none px-4 py-3 bg-white dark:bg-[#1e2d24] text-[#111813] dark:text-white shadow-sm border border-white/40">
                        ${content}
                    </div>
                </div>
            `;
        }

        chatContainer.appendChild(msgDiv);
        scrollToBottom();
        return msgDiv;
    }

    // –ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ
    async function handleSend() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage('user', text);
        userInput.value = '';
        sendBtn.disabled = true;

        const typingIndicator = appendMessage('iko', '', true);

        try {
            // –¢–£–ö –ï –í–†–™–ó–ö–ê–¢–ê –°–™–° –°–™–†–í–™–†–ê
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message: text,
                    history: chatHistory,
                    authCode: localStorage.getItem('guest_code') || '' 
                })
            });

            if (!response.ok) throw new Error('Server error');

            const data = await response.json();
            typingIndicator.remove();
            appendMessage('iko', data.reply);

            chatHistory.push({ role: 'user', parts: [{ text: text }] });
            chatHistory.push({ role: 'model', parts: [{ text: data.reply }] });

        } catch (error) {
            typingIndicator.remove();
            appendMessage('iko', '‚ö†Ô∏è –ó–∞–≥—É–±–∏—Ö –≤—Ä—ä–∑–∫–∞ —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞. –ú–æ–ª—è, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ —Å–∏ –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –ø–∞–∫.');
            console.error(error);
        } finally {
            sendBtn.disabled = false;
            userInput.focus();
        }
    }

    // –ë—ä—Ä–∑–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏
    function sendQuickReply(text) {
        userInput.value = text;
        handleSend();
    }

    // –°–ª—É—à–∞—Ç–µ–ª–∏
    sendBtn.addEventListener('click', handleSend);
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });

    // –ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –∫–æ–¥ –æ—Ç –ª–∏–Ω–∫–∞
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('code')) localStorage.setItem('guest_code', urlParams.get('code'));
</script>

</body>
</html>