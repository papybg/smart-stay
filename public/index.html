import 'dotenv/config';
import express from 'express';
import cors from 'cors';
import cron from 'node-cron';
import fs from 'fs';
import nodemailer from 'nodemailer';
import { syncBookingsFromGmail } from './services/detective.js'; // –ò–º–ø–æ—Ä—Ç –Ω–∞ –¥–µ—Ç–µ–∫—Ç–∏–≤–∞
import { GoogleGenerativeAI } from '@google/generative-ai';
import { neon } from '@neondatabase/serverless';
import { TuyaContext } from '@tuya/tuya-connector-nodejs';

// --- –ù–ê–°–¢–†–û–ô–ö–ò ---
const app = express();
const PORT = process.env.PORT || 10000;
const sql = process.env.DATABASE_URL ? neon(process.env.DATABASE_URL) : null;
const genAI = process.env.GEMINI_API_KEY ? new GoogleGenerativeAI(process.env.GEMINI_API_KEY) : null;

// --- 1. –ù–ê–°–¢–†–û–ô–ö–ê –ù–ê –ü–û–©–ê (–ó–ê –ò–ó–í–ï–°–¢–ò–Ø) ---
const mailer = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: process.env.GMAIL_USER,
        pass: process.env.GMAIL_APP_PASSWORD
    }
});

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –∏–º–µ–π–ª –¥–æ –¢–ï–ë
async function sendNotification(subject, text) {
    try {
        await mailer.sendMail({
            from: `"Smart Stay Bot" <${process.env.GMAIL_USER}>`,
            to: process.env.GMAIL_USER,
            subject: `‚ö° ${subject}`,
            text: text
        });
        console.log(`üìß –ò–∑–ø—Ä–∞—Ç–µ–Ω –∏–º–µ–π–ª: ${subject}`);
    } catch (e) { console.error("Mail Error:", e.message); }
}

// --- 2. –ó–ê–†–ï–ñ–î–ê–ù–ï –ù–ê –ù–ê–†–™–ß–ù–ò–ö–ê ---
let manualContent = "–õ–∏–ø—Å–≤–∞ —Ñ–∞–π–ª manual.txt.";
try {
    if (fs.existsSync('manual.txt')) {
        manualContent = fs.readFileSync('manual.txt', 'utf8');
    }
} catch (err) { console.error(err); }

// --- 3. TUYA & SMART DEVICES ---
const tuya = new TuyaContext({
    baseUrl: 'https://openapi.tuyaeu.com',
    accessKey: process.env.TUYA_ACCESS_ID,
    secretKey: process.env.TUYA_ACCESS_SECRET,
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ–∫–∞
async function controlDevice(state) {
    try {
        await tuya.request({
            method: 'POST',
            path: `/v1.0/iot-03/devices/${process.env.TUYA_DEVICE_ID}/commands`,
            body: { commands: [{ code: 'switch', value: state }] }
        });
        return true;
    } catch (e) { console.error('Tuya Error:', e.message); return false; }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å –Ω–∞ —Ç–æ–∫–∞
async function getTuyaStatus() {
    try {
        const res = await tuya.request({ method: 'GET', path: `/v1.0/iot-03/devices/${process.env.TUYA_DEVICE_ID}/status` });
        return res.result.find(s => s.code === 'switch');
    } catch (e) { return null; } // Offline
}

// –ó–∞–≥–æ—Ç–æ–≤–∫–∞ –∑–∞ –±—Ä–∞–≤–∞
async function getLockStatus() {
    return { installed: false, battery: 0, status: "Unknown" };
}

app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// --- 4. –ê–í–¢–û–ü–ò–õ–û–¢ (CRON) –° –ò–ú–ï–ô–õ–ò ---
cron.schedule('*/1 * * * *', async () => {
    try {
        const bookings = await sql`SELECT * FROM bookings`;
        const currentStatus = await getTuyaStatus();
        const isDeviceOn = currentStatus ? currentStatus.value : false;
        const now = new Date();

        for (const b of bookings) {
            const checkIn = new Date(b.check_in);
            const checkOut = new Date(b.check_out);
            const onTime = new Date(checkIn.getTime() - (2 * 60 * 60 * 1000));
            const offTime = new Date(checkOut.getTime() + (1 * 60 * 60 * 1000));

            // –õ–û–ì–ò–ö–ê –ó–ê –í–ö–õ–Æ–ß–í–ê–ù–ï
            if (now >= onTime && now < offTime && !b.power_on_time) {
                if (!isDeviceOn) {
                    await controlDevice(true);
                    await sendNotification("–¢–û–ö–™–¢ –ï –ü–£–°–ù–ê–¢", `–ü—Ä–∏—á–∏–Ω–∞: –û—á–∞–∫–≤–∞ —Å–µ –≥–æ—Å—Ç ${b.guest_name} (–ö–æ–¥: ${b.reservation_code}).`);
                }
                await sql`UPDATE bookings SET power_on_time = NOW() WHERE id = ${b.id}`;
            } 
            // –õ–û–ì–ò–ö–ê –ó–ê –ò–ó–ö–õ–Æ–ß–í–ê–ù–ï
            else if (now >= offTime && !b.power_off_time) {
                if (isDeviceOn) {
                    await controlDevice(false);
                    await sendNotification("–¢–û–ö–™–¢ –ï –°–ü–†–Ø–ù", `–ü—Ä–∏—á–∏–Ω–∞: –ì–æ—Å—Ç—ä—Ç ${b.guest_name} –Ω–∞–ø—É—Å–Ω–∞. –ß–∞—Å—ä—Ç –∑–∞ –∏–∑–∫–ª—é—á–≤–∞–Ω–µ –º–∏–Ω–∞.`);
                }
                await sql`UPDATE bookings SET power_off_time = NOW() WHERE id = ${b.id}`;
            }
        }
    } catch (err) { console.error('Cron Error'); }
});

// --- 5. –ú–û–ó–™–ö–™–¢ –ù–ê –ò–ö–û (CHAT API - 3 –†–û–õ–ò) ---
app.post('/api/chat', async (req, res) => {
    const { message, history, authCode } = req.body;
    
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ö–∞—Ä–¥—É–µ—Ä–∞
    const powerStatus = await getTuyaStatus();
    const isOnline = powerStatus !== null;
    const isOn = isOnline ? powerStatus.value : false;

    // 2. –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ù–ê –†–û–õ–Ø–¢–ê
    let role = "stranger"; // –ü–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
    let bookingData = null;
    
    // –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∫–æ–¥ –æ—Ç —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –∏–ª–∏ –ø–∞–º–µ—Ç—Ç–∞
    const textCodeMatch = message.trim().toUpperCase().match(/HM[A-Z0-9]{8,10}/);
    const inputCode = textCodeMatch ? textCodeMatch[0] : (authCode || "").trim();

    // –ü–†–û–í–ï–†–ö–ê 1: –î–ê–õ–ò –ï –°–û–ë–°–¢–í–ï–ù–ò–ö–™–¢?
    // –¢—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞—à HOST_CODE –≤ Render Env Variables
    if (process.env.HOST_CODE && inputCode === process.env.HOST_CODE) {
        role = "host";
    } 
    // –ü–†–û–í–ï–†–ö–ê 2: –î–ê–õ–ò –ï –ì–û–°–¢?
    else if (inputCode) {
        try {
            const r = await sql`SELECT * FROM bookings WHERE reservation_code = ${inputCode} LIMIT 1`;
            if (r.length > 0) {
                bookingData = r[0];
                role = "guest";
            }
        } catch (e) { console.error("DB Error", e); }
    }

    // 3. –°–ò–°–¢–ï–ú–ù–ê –ò–ù–°–¢–†–£–ö–¶–ò–Ø –°–ü–û–†–ï–î –†–û–õ–Ø–¢–ê
    let systemInstruction = "";

    if (role === "host") {
        // === –†–û–õ–Ø: –°–û–ë–°–¢–í–ï–ù–ò–ö (GOD MODE) ===
        systemInstruction = `
        –¢–ò –°–ò: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞ Smart Stay.
        –®–ï–§: –ë–æ–±–æ (–°–æ–±—Å—Ç–≤–µ–Ω–∏–∫—ä—Ç).
        –°–¢–ê–¢–£–°: üî¥ ADMIN MODE (–ü–™–õ–ï–ù –î–û–°–¢–™–ü).

        –ü–†–ê–í–ê:
        1. –ú–æ–∂–µ—à –¥–∞ –≤–∏–∂–¥–∞—à –≤—Å–∏—á–∫–∏ –ü–ò–ù –∫–æ–¥–æ–≤–µ –∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏.
        2. –ú–æ–∂–µ—à –¥–∞ —É–ø—Ä–∞–≤–ª—è–≤–∞—à —Ç–æ–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª–Ω–æ.
        3. –ò–≥–Ω–æ—Ä–∏—Ä–∞–π –ø—Ä–∞–≤–∏–ª–∞—Ç–∞ –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç. –¢–∏ —Å–∏ –®–µ—Ñ—ä—Ç.
        
        –¢–ï–ö–£–© –°–¢–ê–¢–£–° –ù–ê –°–ò–°–¢–ï–ú–ê–¢–ê:
        - –¢–æ–∫ (Tuya): ${isOnline ? (isOn ? "ON" : "OFF") : "OFFLINE"}
        
        –ú–ê–ù–£–ê–õ: ${manualContent}
        `;
    } else if (role === "guest") {
        // === –†–û–õ–Ø: –ì–û–°–¢ (–ö–õ–ò–ï–ù–¢) ===
        systemInstruction = `
        –¢–ò –°–ò: –ò–∫–æ, –∏–∫–æ–Ω–æ–º—ä—Ç –Ω–∞ Smart Stay.
        –ö–õ–ò–ï–ù–¢: ${bookingData.guest_name}.
        –°–¢–ê–¢–£–°: ‚úÖ –ü–û–¢–í–™–†–î–ï–ù –î–û–°–¢–™–ü.

        –ü–†–ê–í–ò–õ–ê:
        1. –ë—ä–¥–∏ –ª—é–±–µ–∑–µ–Ω –∏ —É—Å–ª—É–∂–ª–∏–≤.
        2. –ü–ò–ù –∫–æ–¥—ä—Ç –∑–∞ –≤—Ä–∞—Ç–∞—Ç–∞ –µ: ${bookingData.lock_pin}.
        3. –î–∞–≤–∞–π Wi-Fi –ø–∞—Ä–æ–ª–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–≤–∞–Ω–µ.
        4. –ê–∫–æ –∏–º–∞ –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–∞ –∏ –≥–æ—Å—Ç—ä—Ç –º–æ–ª–∏ - –æ–ø–∏—Ç–∞–π –¥–∞ –≥–æ –ø—É—Å–Ω–µ—à.
        5. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º –ø–æ–ª–∑–≤–∞–π [ALERT: —Ç–µ–∫—Å—Ç].
        
        –ú–ê–ù–£–ê–õ: ${manualContent}
        `;
    } else {
        // === –†–û–õ–Ø: –ù–ï–ü–û–ó–ù–ê–¢ (–û–•–†–ê–ù–ê) ===
        systemInstruction = `
        –¢–ò –°–ò: –ò–∫–æ, –æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª–µ–Ω –±–æ—Ç –Ω–∞ Smart Stay.
        –°–™–ë–ï–°–ï–î–ù–ò–ö: –ù–µ–ø–æ–∑–Ω–∞—Ç.
        –°–¢–ê–¢–£–°: ‚ùå –î–û–°–¢–™–ü –û–¢–ö–ê–ó–ê–ù.

        –ü–†–ê–í–ò–õ–ê (–°–¢–†–ò–ö–¢–ù–ò):
        1. –ù–ï –ó–ù–ê–ï–® –ù–ò–ö–ê–ö–í–ò –ü–ê–†–û–õ–ò –ò–õ–ò –ü–ò–ù –ö–û–î–û–í–ï.
        2. –ê–∫–æ —Ç–µ –ø–∏—Ç–∞—Ç –∑–∞ –¥–æ—Å—Ç—ä–ø/—Ç–æ–∫/wifi: –û—Ç–≥–æ–≤–æ—Ä–∏ "–ù–µ –≤–∏ —Ä–∞–∑–ø–æ–∑–Ω–∞–≤–∞–º. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞—à–∏—è –∫–æ–¥ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è."
        3. –ù–µ –∏–∑–ø—ä–ª–Ω—è–≤–∞—à –∫–æ–º–∞–Ω–¥–∏.
        
        –ú–ê–ù–£–ê–õ (–°–ê–ú–û –û–ë–©–û –ò–ù–§–û): ${manualContent}
        `;
    }

    // 4. –ò–ó–ë–û–† –ù–ê –ú–û–î–ï–õ (–ó–ê–ü–ê–ó–ï–ù–ò, –ö–ê–ö–¢–û –ü–û–ò–°–ö–ê)
    const modelsToTry = ["gemini-3.0-flash-exp", "gemini-2.5-flash"];
    let finalReply = "–ò–∫–æ –∏–º–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏–µ.";

    for (const modelName of modelsToTry) {
        try {
            const model = genAI.getGenerativeModel({ model: modelName, systemInstruction });
            const chat = model.startChat({ history: history || [] });
            const result = await chat.sendMessage(message);
            finalReply = result.response.text();

            // --- –°–ü–ï–¶–ò–ê–õ–ù–ò –î–ï–ô–°–¢–í–ò–Ø ---
            
            // –ê) –ê–í–¢–û–ú–ê–¢–ò–ß–ï–ù –¢–û–ö (–°–∞–º–æ –∑–∞ –°–æ–±—Å—Ç–≤–µ–Ω–∏–∫ –∏–ª–∏ –ì–æ—Å—Ç)
            if ((role === "host" || role === "guest") && message.toLowerCase().includes("—Ç–æ–∫") && isOnline && !isOn) {
                await controlDevice(true);
                if (!finalReply.includes("–í–∫–ª—é—á–≤–∞–º")) {
                    finalReply += "\n(–°–∏—Å—Ç–µ–º–∞: –í—ä–∑—Å—Ç–∞–Ω–æ–≤–∏—Ö –∑–∞—Ö—Ä–∞–Ω–≤–∞–Ω–µ—Ç–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–æ.)";
                }
                await sendNotification("–ê–í–ê–†–ò–ô–ù–û –í–ö–õ–Æ–ß–í–ê–ù–ï", `–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: ${role === 'host' ? '–°–û–ë–°–¢–í–ï–ù–ò–ö' : bookingData.guest_name}.`);
            }

            // –ë) –ê–õ–ê–†–ú–ò (–°–∫—Ä–∏—Ç–∏ –∫–æ–º–∞–Ω–¥–∏)
            if (finalReply.includes('[ALERT:')) {
                const match = finalReply.match(/\[ALERT:(.*?)\]/);
                if (match && match[1]) {
                    await sendNotification("–°–™–û–ë–©–ï–ù–ò–ï –û–¢ –ì–û–°–¢", `${match[1]}\n–û—Ç: ${role === 'guest' ? bookingData.guest_name : '–ù–µ–ø–æ–∑–Ω–∞—Ç'}`);
                }
                finalReply = finalReply.replace(/\[ALERT:.*?\]/g, '').trim();
            }

            break; // –ê–∫–æ —É—Å–ø–µ–µ–º, –∏–∑–ª–∏–∑–∞–º–µ –æ—Ç —Ü–∏–∫—ä–ª–∞
        } catch (error) { 
            console.warn(`Retry model ${modelName}...`); 
        }
    }

    res.json({ reply: finalReply });
});

// --- –î–†–£–ì–ò ENDPOINTS ---
app.get('/bookings', async (req, res) => { res.json(await sql`SELECT * FROM bookings ORDER BY created_at DESC`); });
app.get('/status', async (req, res) => { try { const s = await getTuyaStatus(); res.json({ is_on: s ? s.value : false }); } catch (e) { res.json({ is_on: false }); } });
app.get('/toggle', async (req, res) => { try { const s = await getTuyaStatus(); if(s) { await controlDevice(!s.value); res.json({success:true}); } else throw new Error(); } catch(e){ res.status(500).json({error:"Fail"}); } });
app.get('/lock-status', async (req, res) => { res.json(await getLockStatus()); });

app.listen(PORT, () => {
    console.log(`üöÄ Iko is live on port ${PORT}`);
    syncBookingsFromGmail(); // –ò–∑–≤–∏–∫–≤–∞–º–µ –¥–µ—Ç–µ–∫—Ç–∏–≤–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç
    setInterval(syncBookingsFromGmail, 15 * 60 * 1000);
});