<!DOCTYPE html>
<html class="light" lang="bg">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Iko AI | Aspen Valley D105</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec5b",
                        "forest-green": "#1b3a27",
                        "oatmeal": "#f3f0e9",
                        "background-light": "#f3f0e9",
                        "background-dark": "#101813",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "lg": "2rem",
                        "xl": "3rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .glass-header {
            background: rgba(243, 240, 233, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .dark .glass-header {
            background: rgba(16, 24, 19, 0.85);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .organic-texture {
            background-color: #f3f0e9; /* Fallback */
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .dark .glass-input {
            background: rgba(30, 45, 36, 0.9);
        }
        .ios-safe-area {
            padding-bottom: env(safe-area-inset-bottom);
        }
        /* –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–æ–ª–±–∞—Ä–∞ –∑–∞ —á–∏—Å—Ç –≤–∏–¥ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ (—Ç–æ—á–∫–∏—Ç–µ) */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-[#111813] dark:text-white transition-colors duration-300">

<div class="relative flex h-[100dvh] w-full flex-col overflow-hidden organic-texture">
    
    <header class="glass-header sticky top-0 z-50 flex items-center p-4 pb-3 justify-between shadow-sm">
        <div class="flex items-center gap-3">
            <div class="flex size-10 items-center justify-center rounded-full bg-white/50 dark:bg-white/10 shadow-sm">
                <span class="material-symbols-outlined text-[#1b3a27] dark:text-primary">home_app_logo</span>
            </div>
            <div>
                <h2 class="text-sm font-bold leading-tight tracking-tight">–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç D105</h2>
                <p class="text-[11px] font-medium uppercase tracking-widest text-[#61896f]">Aspen Valley</p>
            </div>
        </div>
        <div class="flex items-center bg-white/40 dark:bg-black/20 px-3 py-1 rounded-full border border-white/20">
            <div class="size-2 rounded-full bg-primary animate-pulse mr-2"></div>
            <span class="text-[10px] font-bold uppercase tracking-wider text-[#1b3a27] dark:text-white">Iko AI</span>
        </div>
    </header>

    <main id="chat-container" class="flex-1 overflow-y-auto px-4 py-6 space-y-6 scroll-smooth">
        <div class="flex justify-center">
            <span class="text-[10px] font-bold uppercase tracking-widest text-[#a1a8a3] bg-black/5 dark:bg-white/5 px-3 py-1 rounded-full">–î–Ω–µ—Å</span>
        </div>

        <div class="flex items-end gap-3 max-w-[90%]">
            <div class="bg-white dark:bg-[#25362a] flex items-center justify-center rounded-full w-9 h-9 shrink-0 shadow-sm border border-white/50">
                <span class="material-symbols-outlined text-[#1b3a27] dark:text-primary text-[20px]">smart_toy</span>
            </div>
            <div class="flex flex-col gap-1 items-start">
                <p class="text-[#61896f] text-[10px] font-bold uppercase tracking-wider ml-2">Iko AI</p>
                <div class="text-[15px] font-medium leading-relaxed rounded-2xl rounded-bl-none px-4 py-3 bg-white dark:bg-[#1e2d24] text-[#111813] dark:text-white shadow-sm border border-white/40">
                    –ó–¥—Ä–∞–≤–µ–π—Ç–µ! –ê–∑ —Å—ä–º –ò–∫–æ, –≤–∞—à–∏—è—Ç –¥–∏–≥–∏—Ç–∞–ª–µ–Ω –∏–∫–æ–Ω–æ–º –≤ Aspen Valley. üå≤<br><br>
                    –ú–æ–≥–∞ –¥–∞ —É–ø—Ä–∞–≤–ª—è–≤–∞–º —Ç–æ–∫–∞, –¥–∞ –≤–∏ –¥–∞–º –ø–∞—Ä–æ–ª–∞—Ç–∞ –∑–∞ Wi-Fi –∏–ª–∏ –¥–∞ –≤–∏ –ø—Ä–µ–ø–æ—Ä—ä—á–∞–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω—Ç. –ö–∞–∫ –º–æ–≥–∞ –¥–∞ –ø–æ–º–æ–≥–Ω–∞?
                </div>
            </div>
        </div>
    </main>

    <footer class="ios-safe-area w-full bg-gradient-to-t from-background-light dark:from-background-dark via-background-light/95 dark:via-background-dark/95 to-transparent pt-4 z-40">
        
        <div class="flex gap-2 px-4 pb-4 overflow-x-auto no-scrollbar" id="quick-replies">
            <button onclick="sendQuickReply('–ö–∞–∫–≤–∞ –µ –ø–∞—Ä–æ–ª–∞—Ç–∞ –∑–∞ Wi-Fi?')" class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white dark:bg-[#1e2d24] px-4 shadow-sm border border-white/50 hover:border-primary hover:bg-gray-50 transition-all active:scale-95">
                <span class="material-symbols-outlined text-[18px] text-[#61896f]">wifi</span>
                <p class="text-[#111813] dark:text-white text-xs font-semibold whitespace-nowrap">Wi-Fi</p>
            </button>
            <button onclick="sendQuickReply('–ù—è–º–∞ —Ç–æ–∫')" class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white dark:bg-[#1e2d24] px-4 shadow-sm border border-white/50 hover:border-primary hover:bg-gray-50 transition-all active:scale-95">
                <span class="material-symbols-outlined text-[18px] text-[#61896f]">bolt</span>
                <p class="text-[#111813] dark:text-white text-xs font-semibold whitespace-nowrap">–ü—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–∞</p>
            </button>
            <button onclick="sendQuickReply('–ö–æ–≥–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –æ—Å–≤–æ–±–æ–¥—è?')" class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white dark:bg-[#1e2d24] px-4 shadow-sm border border-white/50 hover:border-primary hover:bg-gray-50 transition-all active:scale-95">
                <span class="material-symbols-outlined text-[18px] text-[#61896f]">schedule</span>
                <p class="text-[#111813] dark:text-white text-xs font-semibold whitespace-nowrap">Check-out</p>
            </button>
             <button onclick="sendQuickReply('–ü—Ä–µ–ø–æ—Ä—ä—á–∞–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω—Ç')" class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white dark:bg-[#1e2d24] px-4 shadow-sm border border-white/50 hover:border-primary hover:bg-gray-50 transition-all active:scale-95">
                <span class="material-symbols-outlined text-[18px] text-[#61896f]">restaurant</span>
                <p class="text-[#111813] dark:text-white text-xs font-semibold whitespace-nowrap">–†–µ—Å—Ç–æ—Ä–∞–Ω—Ç–∏</p>
            </button>
        </div>

        <div class="px-4 pb-6">
            <div class="glass-input flex items-center rounded-full p-2 pr-2 pl-5 shadow-xl border border-white/50 ring-1 ring-black/5">
                <input id="user-input" class="flex-1 bg-transparent border-none focus:ring-0 text-[16px] placeholder-[#61896f]/60 text-[#111813] dark:text-white py-2" placeholder="–ü–æ–ø–∏—Ç–∞–π—Ç–µ –ò–∫–æ..." type="text" autocomplete="off"/>
                <button id="send-btn" class="flex size-10 items-center justify-center rounded-full bg-forest-green text-white shadow-lg hover:bg-opacity-90 transition-transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="material-symbols-outlined font-bold text-[20px]">arrow_upward</span>
                </button>
            </div>
        </div>
    </footer>
</div>

<script>
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    let chatHistory = [];

    // –§—É–Ω–∫—Ü–∏—è –∑–∞ —Å–∫—Ä–æ–ª–≤–∞–Ω–µ –Ω–∞–π-–¥–æ–ª—É
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ –≤ UI
    function appendMessage(sender, text, isTyping = false) {
        const isUser = sender === 'user';
        const msgDiv = document.createElement('div');
        
        // –ö–ª–∞—Å–æ–≤–µ –∑–∞ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–∞–Ω–µ
        msgDiv.className = isUser 
            ? "flex items-end gap-3 justify-end ml-auto max-w-[90%] fade-in-up" 
            : "flex items-end gap-3 max-w-[90%] fade-in-up";

        if (isUser) {
            // HTML –∑–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è (–ì–æ—Å—Ç)
            msgDiv.innerHTML = `
                <div class="flex flex-col gap-1 items-end">
                    <div class="text-[15px] font-medium leading-relaxed rounded-2xl rounded-br-none px-4 py-3 bg-forest-green text-white shadow-md">
                        ${text}
                    </div>
                </div>
                <div class="bg-gray-200 flex items-center justify-center rounded-full w-9 h-9 shrink-0 shadow-sm border-2 border-white overflow-hidden">
                     <span class="material-symbols-outlined text-gray-500 text-[20px]">person</span>
                </div>
            `;
        } else {
            // HTML –∑–∞ –ò–∫–æ
            let content = text;
            if (isTyping) {
                content = `
                <div class="flex gap-1 h-6 items-center">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>`;
            } else {
                // –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Bold —Ç–µ–∫—Å—Ç (–∞–∫–æ AI –≤—ä—Ä–Ω–µ markdown stars)
                content = content.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold">$1</span>');
                content = content.replace(/\n/g, '<br>');
            }

            msgDiv.innerHTML = `
                <div class="bg-white dark:bg-[#25362a] flex items-center justify-center rounded-full w-9 h-9 shrink-0 shadow-sm border border-white/50">
                    <span class="material-symbols-outlined text-[#1b3a27] dark:text-primary text-[20px]">smart_toy</span>
                </div>
                <div class="flex flex-col gap-1 items-start">
                    <p class="text-[#61896f] text-[10px] font-bold uppercase tracking-wider ml-2">Iko AI</p>
                    <div class="text-[15px] font-medium leading-relaxed rounded-2xl rounded-bl-none px-4 py-3 bg-white dark:bg-[#1e2d24] text-[#111813] dark:text-white shadow-sm border border-white/40">
                        ${content}
                    </div>
                </div>
            `;
        }

        chatContainer.appendChild(msgDiv);
        scrollToBottom();
        return msgDiv;
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞ –±—ä—Ä–∑–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏
    function sendQuickReply(text) {
        userInput.value = text;
        handleSend();
    }

    // –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–∞—â–∞–Ω–µ
    async function handleSend() {
        const text = userInput.value.trim();
        if (!text) return;

        // 1. –ü–æ–∫–∞–∑–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
        appendMessage('user', text);
        userInput.value = '';
        sendBtn.disabled = true;

        // 2. –ü–æ–∫–∞–∑–≤–∞–º–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ò–∫–æ –ø–∏—à–µ..."
        const typingIndicator = appendMessage('iko', '', true);

        try {
            // 3. –ü—Ä–∞—â–∞–º–µ –∫—ä–º —Å—ä—Ä–≤—ä—Ä–∞
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message: text,
                    history: chatHistory,
                    authCode: localStorage.getItem('guest_code') || '' // –ê–∫–æ –∏—Å–∫–∞—à –¥–∞ –ø–∞–∑–∏—à –∫–æ–¥–∞
                })
            });

            const data = await response.json();

            // 4. –ú–∞—Ö–∞–º–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∏ –ø–æ–∫–∞–∑–≤–∞–º–µ –æ—Ç–≥–æ–≤–æ—Ä–∞
            typingIndicator.remove();
            appendMessage('iko', data.reply);

            // 5. –û–±–Ω–æ–≤—è–≤–∞–º–µ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞
            chatHistory.push({ role: 'user', parts: [{ text: text }] });
            chatHistory.push({ role: 'model', parts: [{ text: data.reply }] });

        } catch (error) {
            typingIndicator.remove();
            appendMessage('iko', '–û–ø–∞, –∑–∞–≥—É–±–∏—Ö –≤—Ä—ä–∑–∫–∞. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –ø–∞–∫.');
            console.error(error);
        } finally {
            sendBtn.disabled = false;
            userInput.focus();
        }
    }

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –∑–∞ —Å—ä–±–∏—Ç–∏—è (Events)
    sendBtn.addEventListener('click', handleSend);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSend();
    });

    // –û–ø–∏—Ç –∑–∞ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∫–æ–¥ –æ—Ç URL (–∞–∫–æ –≥–æ—Å—Ç–∞ –æ—Ç–≤–æ—Ä–∏ link.com?code=HM123)
    const urlParams = new URLSearchParams(window.location.search);
    const urlCode = urlParams.get('code');
    if (urlCode) {
        localStorage.setItem('guest_code', urlCode);
    }
</script>

<style>
    /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞ –ø–æ—è–≤—è–≤–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞ */
    .fade-in-up {
        animation: fadeInUp 0.3s ease-out forwards;
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
</body>
</html>