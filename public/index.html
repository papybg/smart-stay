<!DOCTYPE html>
<html class="light" lang="bg">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Smart Stay | Aspen Valley</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec5b",
                        "forest-green": "#1b3a27",
                        "background-light": "#f3f0e9",
                        "background-dark": "#101813",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        .glass-header {
            background: rgba(243, 240, 233, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        /* –°–∫—Ä–∏–≤–∞–º–µ —Å–∫—Ä–æ–ª–±–∞—Ä–∞ –∑–∞ –ø–æ-—á–∏—Å—Ç –≤–∏–¥ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="font-display bg-background-light text-[#111813] h-[100dvh] flex flex-col overflow-hidden">

    <header class="glass-header sticky top-0 z-50 flex items-center p-4 justify-between shadow-sm">
        <div class="flex items-center gap-3">
            <div class="flex size-10 items-center justify-center rounded-full bg-white/50 shadow-sm">
                <span class="material-symbols-outlined text-[#1b3a27]">smart_toy</span>
            </div>
            <div>
                <h2 class="text-sm font-bold leading-tight">–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç D105</h2>
                <p class="text-[11px] font-medium uppercase tracking-widest text-[#61896f]">Aspen Valley</p>
            </div>
        </div>
        <div class="flex items-center bg-white/40 px-3 py-1 rounded-full border border-white/20">
            <div class="size-2 rounded-full bg-primary animate-pulse mr-2"></div>
            <span class="text-[10px] font-bold uppercase tracking-wider text-[#1b3a27]">ONLINE</span>
        </div>
    </header>

    <main id="chat-box" class="flex-1 overflow-y-auto px-4 py-6 space-y-4 scroll-smooth">
        <div class="flex items-end gap-3 max-w-[90%]">
            <div class="bg-white flex items-center justify-center rounded-full w-9 h-9 shrink-0 shadow-sm border border-white/50">
                <span class="material-symbols-outlined text-[#1b3a27] text-[20px]">smart_toy</span>
            </div>
            <div class="text-[15px] font-medium leading-relaxed rounded-2xl rounded-bl-none px-4 py-3 bg-white text-[#111813] shadow-sm border border-white/40">
                –ó–¥—Ä–∞–≤–µ–π—Ç–µ! –ê–∑ —Å—ä–º –ò–∫–æ. üëã<br>
                –ù–∞–ø–∏—à–µ—Ç–µ –∫–æ–¥–∞ —Å–∏ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤—ä–ø—Ä–æ—Å (–Ω–∞–ø—Ä. "Wi-Fi –ø–∞—Ä–æ–ª–∞", "–ù—è–º–∞ —Ç–æ–∫").
            </div>
        </div>
        <div id="loader" class="hidden flex items-end gap-3 max-w-[90%]">
             <div class="bg-white flex items-center justify-center rounded-full w-9 h-9 shrink-0">
                <span class="material-symbols-outlined text-[#1b3a27]">smart_toy</span>
            </div>
            <div class="bg-white px-4 py-3 rounded-2xl rounded-bl-none shadow-sm flex gap-1 h-8 items-center">
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
            </div>
        </div>
    </main>

    <footer class="w-full bg-[#f3f0e9] pt-2 pb-6 z-40">
        <div class="flex gap-2 px-4 pb-4 overflow-x-auto no-scrollbar">
            <button onclick="sendQuick('–ö–∞–∫–≤–∞ –µ Wi-Fi –ø–∞—Ä–æ–ª–∞—Ç–∞?')" class="flex h-10 shrink-0 items-center gap-2 rounded-full bg-white px-4 shadow-sm border border-white/50 hover:border-primary">
                <span class="material-symbols-outlined text-[18px] text-[#61896f]">wifi</span>
                <p class="text-xs font-bold">Wi-Fi</p>
            </button>
            <button onclick="sendQuick('–ù—è–º–∞ —Ç–æ–∫')" class="flex h-10 shrink-0 items-center gap-2 rounded-full bg-white px-4 shadow-sm border border-white/50 hover:border-primary">
                <span class="material-symbols-outlined text-[18px] text-[#61896f]">bolt</span>
                <p class="text-xs font-bold">–¢–æ–∫</p>
            </button>
            <button onclick="sendQuick('–ö–æ–≥–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –æ—Å–≤–æ–±–æ–¥—è?')" class="flex h-10 shrink-0 items-center gap-2 rounded-full bg-white px-4 shadow-sm border border-white/50 hover:border-primary">
                <span class="material-symbols-outlined text-[18px] text-[#61896f]">schedule</span>
                <p class="text-xs font-bold">Check-out</p>
            </button>
        </div>

        <div class="px-4">
            <div class="bg-white flex items-center rounded-full p-2 pl-5 shadow-lg border border-white/50">
                <input id="user-input" class="flex-1 bg-transparent border-none focus:ring-0 text-[16px] py-2" placeholder="–ü–∏—à–µ—Ç–µ —Ç—É–∫..." type="text" autocomplete="off"/>
                <button onclick="sendMessage()" class="flex size-10 items-center justify-center rounded-full bg-forest-green text-white shadow-lg active:scale-90 transition-all">
                    <span class="material-symbols-outlined font-bold text-[20px]">arrow_upward</span>
                </button>
            </div>
        </div>
    </footer>

<script>
    // --- –ü–†–û–°–¢–ê–¢–ê –ò –°–ò–ì–£–†–ù–ê –õ–û–ì–ò–ö–ê ---
    
    // –í–ê–ñ–ù–û: –¢—É–∫ —Å–ª–∞–≥–∞–º–µ –ø—ä–ª–Ω–∏—è –∞–¥—Ä–µ—Å, –∑–∞ –¥–∞ –∏–∑–±–µ–≥–Ω–µ–º 404 –≥—Ä–µ—à–∫–∞—Ç–∞
    const SERVER_URL = 'https://smart-stay.onrender.com/api/chat';

    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const loader = document.getElementById('loader');
    
    // –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —á–∞—Ç–∞ (–∑–∞ –¥–∞ –ø–æ–º–Ω–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
    let history = [];

    // –°–ª—É—à–∞–Ω–µ –∑–∞ Enter
    userInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });

    function sendQuick(text) {
        userInput.value = text;
        sendMessage();
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        // 1. –ü–æ–∫–∞–∑–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –Ω–∞ –µ–∫—Ä–∞–Ω–∞ (–î–∏–∑–∞–π–Ω—ä—Ç –µ –æ—Ç code.html)
        addMessage(text, 'user');
        userInput.value = '';

        // 2. –ü–æ–∫–∞–∑–≤–∞–º–µ –ª–æ—É–¥—ä—Ä–∞
        loader.classList.remove('hidden');
        chatBox.appendChild(loader); // –ú–µ—Å—Ç–∏–º –≥–æ –Ω–∞–π-–¥–æ–ª—É
        scrollToBottom();

        try {
            // 3. –ü—Ä–∞—â–∞–º–µ –∑–∞—è–≤–∫–∞—Ç–∞ –∫—ä–º –ü–™–õ–ù–ò–Ø –∞–¥—Ä–µ—Å
            const response = await fetch(SERVER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message: text,
                    history: history,
                    authCode: localStorage.getItem('guest_code') || ''
                })
            });

            if (!response.ok) throw new Error('Server error');

            const data = await response.json();

            // 4. –°–∫—Ä–∏–≤–∞–º–µ –ª–æ—É–¥—ä—Ä–∞ –∏ –ø–æ–∫–∞–∑–≤–∞–º–µ –æ—Ç–≥–æ–≤–æ—Ä–∞
            loader.classList.add('hidden');
            addMessage(data.reply, 'bot');

            // 5. –ü–∞–∑–∏–º –∏—Å—Ç–æ—Ä–∏—è—Ç–∞
            history.push({ role: 'user', parts: [{ text: text }] });
            history.push({ role: 'model', parts: [{ text: data.reply }] });

        } catch (error) {
            loader.classList.add('hidden');
            addMessage("‚ö†Ô∏è –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ä—ä–∑–∫–∞—Ç–∞. –ú–æ–ª—è, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ —Å–∏.", 'bot');
            console.error(error);
        }
    }

    function addMessage(text, sender) {
        const msgDiv = document.createElement('div');
        
        if (sender === 'user') {
            // –°—Ç–∏–ª –∑–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª (–ó–µ–ª–µ–Ω –±–∞–ª–æ–Ω –æ—Ç –¥—è—Å–Ω–æ)
            msgDiv.className = "flex items-end gap-3 justify-end ml-auto max-w-[90%]";
            msgDiv.innerHTML = `
                <div class="text-[15px] font-medium leading-relaxed rounded-2xl rounded-br-none px-4 py-3 bg-forest-green text-white shadow-md">
                    ${text}
                </div>
            `;
        } else {
            // –°—Ç–∏–ª –∑–∞ –ò–∫–æ (–ë—è–ª –±–∞–ª–æ–Ω –æ—Ç –ª—è–≤–æ)
            let formatted = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            msgDiv.className = "flex items-end gap-3 max-w-[90%]";
            msgDiv.innerHTML = `
                <div class="bg-white flex items-center justify-center rounded-full w-9 h-9 shrink-0 shadow-sm border border-white/50">
                    <span class="material-symbols-outlined text-[#1b3a27] text-[20px]">smart_toy</span>
                </div>
                <div class="text-[15px] font-medium leading-relaxed rounded-2xl rounded-bl-none px-4 py-3 bg-white text-[#111813] shadow-sm border border-white/40">
                    ${formatted}
                </div>
            `;
        }

        chatBox.insertBefore(msgDiv, loader);
        scrollToBottom();
    }

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∫–æ–¥ –≤ –ª–∏–Ω–∫–∞ (–∞–∫–æ –∏–º–∞)
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('code')) localStorage.setItem('guest_code', urlParams.get('code'));
</script>

</body>
</html>